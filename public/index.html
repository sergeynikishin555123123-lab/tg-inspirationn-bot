<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ú–∞—Å—Ç–µ—Ä—Å–∫–∞—è –í–¥–æ—Ö–Ω–æ–≤–µ–Ω–∏—è</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
        }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh; 
            padding: 20px; 
            color: #2d3748;
            line-height: 1.6;
        }
        
        .container { 
            max-width: 400px; 
            margin: 0 auto; 
        }
        
        .card { 
            background: rgba(255, 255, 255, 0.95); 
            border-radius: 20px; 
            padding: 24px; 
            margin-bottom: 16px; 
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .btn {
            width: 100%; 
            padding: 16px; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; 
            border: none; 
            border-radius: 12px; 
            font-size: 16px; 
            font-weight: 600;
            cursor: pointer; 
            margin-top: 12px; 
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }
        
        .btn:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .btn-secondary { 
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            box-shadow: 0 4px 15px rgba(72, 187, 120, 0.3);
        }
        
        .btn-warning { 
            background: linear-gradient(135deg, #ed8936 0%, #dd6b20 100%);
            box-shadow: 0 4px 15px rgba(237, 137, 54, 0.3);
        }
        
        .btn-danger { 
            background: linear-gradient(135deg, #f56565 0%, #e53e3e 100%);
            box-shadow: 0 4px 15px rgba(245, 101, 101, 0.3);
        }
        
        .btn-info { 
            background: linear-gradient(135deg, #4299e1 0%, #3182ce 100%);
            box-shadow: 0 4px 15px rgba(66, 153, 225, 0.3);
        }
        
        .btn-success { 
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            box-shadow: 0 4px 15px rgba(72, 187, 120, 0.3);
        }
        
        .sparks { 
            font-size: 42px; 
            font-weight: bold; 
            text-align: center; 
            color: #f6e05e; 
            text-shadow: 0 2px 8px rgba(246, 224, 94, 0.4); 
            margin: 20px 0; 
            padding: 16px;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
            border-radius: 16px;
            border: 2px solid rgba(246, 224, 94, 0.3);
        }
        
        .screen { 
            display: none; 
        }
        
        .active { 
            display: block; 
        }
        
        .back-btn { 
            background: #718096; 
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(113, 128, 150, 0.3);
        }
        
        .role-card, .character-card, .interactive-card {
            background: white; 
            border: 2px solid #e2e8f0; 
            border-radius: 16px; 
            padding: 20px;
            margin-bottom: 12px; 
            cursor: pointer; 
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }
        
        .role-card:hover, .character-card:hover, .interactive-card:hover { 
            border-color: #667eea; 
            transform: translateY(-2px); 
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.15);
        }
        
        .role-card.selected, .character-card.selected { 
            border-color: #667eea; 
            background: rgba(102, 126, 234, 0.05); 
        }
        
        .quiz-card, .marathon-card, .post-card, .shop-item, .work-card {
            background: white; 
            border: 2px solid #e2e8f0; 
            border-radius: 16px; 
            padding: 20px;
            margin-bottom: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }
        
        .purchase-item {
            background: #f0fff4; 
            border: 2px solid #9ae6b4; 
            border-radius: 16px; 
            padding: 20px;
            margin-bottom: 12px;
        }
        
        .work-pending { 
            background: #feebc8; 
            border-color: #fbd38d; 
        }
        
        .work-approved { 
            background: #f0fff4; 
            border-color: #9ae6b4; 
        }
        
        .work-rejected { 
            background: #fed7d7; 
            border-color: #feb2b2; 
        }
        
        .loading { 
            text-align: center; 
            color: #718096; 
            padding: 40px 20px; 
            font-size: 16px;
        }
        
        .error { 
            background: #fed7d7; 
            color: #c53030; 
            padding: 16px; 
            border-radius: 12px; 
            margin: 12px 0; 
            text-align: center;
            border: 1px solid #feb2b2;
        }
        
        .success { 
            background: #c6f6d5; 
            color: #276749; 
            padding: 16px; 
            border-radius: 12px; 
            margin: 12px 0; 
            text-align: center;
            border: 1px solid #9ae6b4;
        }
        
        .info { 
            background: #bee3f8; 
            color: #2c5aa0; 
            padding: 16px; 
            border-radius: 12px; 
            margin: 12px 0; 
            text-align: center;
            border: 1px solid #90cdf4;
        }
        
        .question { 
            margin-bottom: 24px; 
        }
        
        .options { 
            margin-top: 16px; 
        }
        
        .option { 
            background: #f7fafc; 
            border: 2px solid #e2e8f0; 
            border-radius: 12px; 
            padding: 16px;
            margin-bottom: 10px; 
            cursor: pointer; 
            transition: all 0.3s ease;
        }
        
        .option:hover { 
            border-color: #667eea; 
            background: #edf2f7; 
        }
        
        .option.selected { 
            border-color: #48bb78; 
            background: #f0fff4; 
        }
        
        .progress-bar { 
            background: #e2e8f0; 
            border-radius: 10px; 
            height: 8px; 
            margin: 16px 0;
            overflow: hidden;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        .progress-fill {
            background: linear-gradient(135deg, #48bb78, #38a169); 
            height: 100%;
            transition: width 0.5s ease;
            border-radius: 10px;
        }
        
        .marathon-day {
            background: #f7fafc; 
            border: 2px solid #e2e8f0; 
            border-radius: 12px; 
            padding: 20px;
            margin-bottom: 12px;
            transition: all 0.3s ease;
        }
        
        .marathon-day.completed { 
            background: #f0fff4; 
            border-color: #9ae6b4; 
        }
        
        .spark-badge {
            background: linear-gradient(135deg, #f6e05e, #d69e2e);
            color: #744210; 
            padding: 6px 12px; 
            border-radius: 20px;
            font-size: 12px; 
            font-weight: bold; 
            margin-left: 8px;
            box-shadow: 0 2px 4px rgba(214, 158, 46, 0.3);
        }
        
        .upload-area {
            border: 2px dashed #667eea; 
            border-radius: 16px; 
            padding: 40px 20px;
            text-align: center; 
            margin: 20px 0; 
            cursor: pointer;
            transition: all 0.3s ease;
            background: rgba(102, 126, 234, 0.05);
        }
        
        .upload-area:hover { 
            background: rgba(102, 126, 234, 0.1); 
            border-color: #5a67d8;
        }
        
        .upload-area.dragover { 
            background: rgba(102, 126, 234, 0.2); 
            border-color: #4a5568; 
        }
        
        .work-image {
            max-width: 100%; 
            border-radius: 12px; 
            margin: 12px 0;
            border: 2px solid #e2e8f0;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .status-badge {
            padding: 6px 12px; 
            border-radius: 12px; 
            font-size: 12px; 
            font-weight: 600;
            margin-left: 12px;
        }
        
        .status-pending { 
            background: #feebc8; 
            color: #dd6b20; 
        }
        
        .status-approved { 
            background: #c6f6d5; 
            color: #276749; 
        }
        
        .status-rejected { 
            background: #fed7d7; 
            color: #c53030; 
        }
        
        .form-control {
            width: 100%; 
            padding: 16px; 
            border: 2px solid #e2e8f0; 
            border-radius: 12px;
            font-size: 16px; 
            margin-top: 8px; 
            transition: border-color 0.3s ease;
            background: white;
        }
        
        .form-control:focus { 
            border-color: #667eea; 
            outline: none;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .stats-grid {
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 12px; 
            margin: 20px 0;
        }
        
        .stat-item {
            background: #f7fafc; 
            padding: 16px; 
            border-radius: 12px; 
            text-align: center;
            border: 1px solid #e2e8f0;
        }
        
        .stat-number { 
            font-size: 20px; 
            font-weight: bold; 
            color: #667eea; 
            margin-bottom: 4px;
        }
        
        .stat-label { 
            font-size: 12px; 
            color: #718096; 
        }
        
        .works-tabs {
            display: flex; 
            background: #f7fafc; 
            border-radius: 12px; 
            padding: 6px; 
            margin-bottom: 20px;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        .works-tab {
            flex: 1; 
            padding: 12px; 
            text-align: center; 
            cursor: pointer; 
            border-radius: 8px;
            transition: all 0.3s ease;
            font-weight: 500;
        }
        
        .works-tab.active { 
            background: #667eea; 
            color: white; 
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
        }
        
        .shop-tabs {
            display: flex; 
            background: #f7fafc; 
            border-radius: 12px; 
            padding: 6px; 
            margin-bottom: 20px;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        .shop-tab {
            flex: 1; 
            padding: 12px; 
            text-align: center; 
            cursor: pointer; 
            border-radius: 8px;
            transition: all 0.3s ease;
            font-weight: 500;
        }
        
        .shop-tab.active { 
            background: #667eea; 
            color: white; 
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
        }
        
        .content-preview {
            background: #f7fafc; 
            border: 1px solid #e2e8f0; 
            border-radius: 12px;
            padding: 16px; 
            margin-top: 12px; 
            max-height: 200px; 
            overflow-y: auto;
            font-size: 14px;
            line-height: 1.5;
        }
        
        .media-preview {
            max-width: 100%; 
            border-radius: 12px; 
            margin: 12px 0;
            border: 2px solid #e2e8f0;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .purchase-video {
            width: 100%;
            max-height: 300px;
            border-radius: 12px;
            background: #000;
            margin: 12px 0;
        }
        
        .purchase-audio {
            width: 100%;
            margin: 12px 0;
            border-radius: 25px;
            background: #f7fafc;
            padding: 10px;
            border: 2px solid #e2e8f0;
        }
        
        .interactive-tabs {
            display: flex; 
            background: #f7fafc; 
            border-radius: 12px; 
            padding: 6px; 
            margin-bottom: 20px;
            flex-wrap: wrap;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        .interactive-tab {
            flex: 1; 
            min-width: 80px; 
            padding: 12px; 
            text-align: center; 
            cursor: pointer; 
            border-radius: 8px; 
            transition: all 0.3s ease; 
            margin: 2px;
            font-weight: 500;
        }
        
        .interactive-tab.active { 
            background: #667eea; 
            color: white; 
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
        }
        
        .interactive-image {
            max-width: 100%; 
            border-radius: 16px; 
            margin: 20px 0;
            border: 3px solid #e2e8f0; 
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        
        .category-badge {
            display: inline-block; 
            padding: 8px 16px; 
            border-radius: 20px;
            font-size: 12px; 
            font-weight: 600; 
            margin: 6px 6px 6px 0;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .category-history { 
            background: #fed7d7; 
            color: #c53030; 
        }
        
        .category-style { 
            background: #c6f6d5; 
            color: #276749; 
        }
        
        .category-art { 
            background: #bee3f8; 
            color: #2c5aa0; 
        }
        
        .category-craft { 
            background: #feebc8; 
            color: #dd6b20; 
        }
        
        .compliment-input {
            width: 100%; 
            padding: 20px; 
            border: 2px solid #e2e8f0; 
            border-radius: 16px;
            font-size: 16px; 
            margin: 12px 0; 
            resize: vertical; 
            min-height: 120px;
            background: white;
            font-family: inherit;
        }
        
        .compliment-input:focus {
            border-color: #667eea; 
            outline: none;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .interactive-result {
            text-align: center; 
            padding: 40px 20px;
        }
        
        .result-icon {
            font-size: 80px; 
            margin-bottom: 20px;
        }
        
        .drawing-canvas {
            width: 100%; 
            height: 300px; 
            border: 2px dashed #667eea; 
            border-radius: 16px;
            margin: 20px 0; 
            background: #f7fafc; 
            cursor: crosshair;
            box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.05);
        }
        
        .drawing-tools {
            display: flex; 
            gap: 12px; 
            margin: 16px 0; 
            flex-wrap: wrap;
            align-items: center;
        }
        
        .drawing-tool {
            padding: 12px 20px; 
            border: 2px solid #e2e8f0; 
            border-radius: 12px;
            background: white; 
            cursor: pointer; 
            transition: all 0.3s ease;
            font-weight: 500;
        }
        
        .drawing-tool.active {
            border-color: #667eea; 
            background: #edf2f7;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.2);
        }
        
        .color-picker {
            width: 44px; 
            height: 44px; 
            border: 2px solid #e2e8f0; 
            border-radius: 12px;
            cursor: pointer; 
            margin: 4px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .color-picker:hover {
            transform: scale(1.1);
        }
        
        .color-picker.active {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.3);
        }
        
        .interactive-description {
            color: #718096; 
            font-size: 14px; 
            margin: 12px 0; 
            line-height: 1.5;
        }
        
        .header-title {
            text-align: center; 
            margin-bottom: 12px; 
            font-size: 24px;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .header-subtitle {
            text-align: center; 
            color: #718096; 
            margin-bottom: 24px;
            font-size: 16px;
        }
        
        .user-info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 16px;
        }
        
        .user-info-item {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .user-info-label {
            color: #718096;
            font-weight: 500;
        }
        
        .user-info-value {
            font-weight: 600;
            color: #2d3748;
        }
        
        .action-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 12px;
            margin-top: 20px;
        }
        
        .feature-card {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.05), rgba(118, 75, 162, 0.05));
            border: 1px solid rgba(102, 126, 234, 0.2);
            border-radius: 16px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s ease;
        }
        
        .feature-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.15);
        }
        
        .feature-icon {
            font-size: 32px;
            margin-bottom: 12px;
        }
        
        .feature-title {
            font-weight: 600;
            margin-bottom: 8px;
            color: #2d3748;
        }
        
        .feature-description {
            color: #718096;
            font-size: 14px;
            line-height: 1.4;
        }
        
        /* –ê–Ω–∏–º–∞—Ü–∏–∏ */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .screen.active {
            animation: fadeIn 0.5s ease;
        }
        
        .pulse {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
        @media (max-width: 480px) {
            .container {
                padding: 0 8px;
            }
            
            .card {
                padding: 20px;
                margin-bottom: 12px;
            }
            
            .stats-grid {
                grid-template-columns: 1fr 1fr;
                gap: 8px;
            }
            
            .user-info-grid {
                grid-template-columns: 1fr;
            }
        }
        
        /* –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è –∫–Ω–æ–ø–∫–∏ —Å–º–µ–Ω—ã —Ä–æ–ª–∏ */
        .change-role-btn {
            background: linear-gradient(135deg, #9f7aea 0%, #805ad5 100%);
            box-shadow: 0 4px 15px rgba(159, 122, 234, 0.3);
        }
        
        .change-role-btn:hover {
            background: linear-gradient(135deg, #805ad5 0%, #6b46c1 100%);
            box-shadow: 0 6px 20px rgba(159, 122, 234, 0.4);
        }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è –º–µ–¥–∏–∞ –≤ –ø–æ–∫—É–ø–∫–∞—Ö */
        .purchase-media-container {
            margin: 20px 0;
        }
        
        .purchase-media-title {
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
            color: #2d3748;
        }
        
        .purchase-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px;
            margin: 16px 0;
        }
        
        .purchase-grid-item {
            border-radius: 8px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid #e2e8f0;
        }
        
        .purchase-grid-item:hover {
            transform: scale(1.05);
            border-color: #667eea;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }
        
        .purchase-grid-item img {
            width: 100%;
            height: 120px;
            object-fit: cover;
        }
        
        .media-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            padding: 20px;
        }
        
        .media-modal-content {
            position: relative;
            max-width: 95%;
            max-height: 95%;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .media-modal-video {
            max-width: 100%;
            max-height: 90vh;
            border-radius: 8px;
        }
        
        .media-modal-image {
            max-width: 100%;
            max-height: 90vh;
            object-fit: contain;
            border-radius: 8px;
        }
        
        .media-modal-btn {
            position: absolute;
            background: rgba(255, 255, 255, 0.9);
            color: #2d3748;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            font-size: 18px;
            cursor: pointer;
            z-index: 10001;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }
        
        .media-modal-btn:hover {
            background: white;
            transform: scale(1.1);
        }
        
        .media-modal-close {
            top: -50px;
            right: 0;
            background: #f56565;
            color: white;
        }
        
        .media-modal-download {
            top: -50px;
            right: 50px;
            background: #48bb78;
            color: white;
        }
        
        .badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 6px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            line-height: 1;
        }
        
        .badge-info {
            background: #bee3f8;
            color: #2c5aa0;
            border: 1px solid #90cdf4;
        }
        
        .badge-success {
            background: #c6f6d5;
            color: #276749;
            border: 1px solid #9ae6b4;
        }
        
        .badge-warning {
            background: #feebc8;
            color: #dd6b20;
            border: 1px solid #fbd38d;
        }
        
        .badge-danger {
            background: #fed7d7;
            color: #c53030;
            border: 1px solid #feb2b2;
        }
        
        .badge-purple {
            background: #e9d8fd;
            color: #6b46c1;
            border: 1px solid #d6bcfa;
        }
        
        .purchase-actions {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            margin-top: 20px;
            padding-top: 16px;
            border-top: 1px solid #e2e8f0;
        }
        
        .purchase-btn {
            flex: 1;
            min-width: 120px;
            padding: 12px 16px;
            border: none;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }
        
        .purchase-btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
        }
        
        .purchase-btn-success {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            color: white;
            box-shadow: 0 2px 8px rgba(72, 187, 120, 0.3);
        }
        
        .purchase-btn-danger {
            background: linear-gradient(135deg, #f56565 0%, #e53e3e 100%);
            color: white;
            box-shadow: 0 2px 8px rgba(245, 101, 101, 0.3);
        }
        
        .purchase-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }
        
        .purchase-btn:active {
            transform: translateY(0);
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- –ì–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω -->
        <div id="mainScreen" class="screen active">
            <div class="card">
                <h1 class="header-title">üé® –ú–∞—Å—Ç–µ—Ä—Å–∫–∞—è –í–¥–æ—Ö–Ω–æ–≤–µ–Ω–∏—è</h1>
                <p class="header-subtitle">–í–∞—à–µ —Ç–≤–æ—Ä—á–µ—Å–∫–æ–µ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ</p>
                
                <div id="userData">
                    <div class="loading">
                        <div style="font-size: 48px; margin-bottom: 16px;">‚è≥</div>
                        –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...
                    </div>
                    <div id="userContent" style="display: none;">
                        <div class="user-info-grid">
                            <div class="user-info-item">
                                <span class="user-info-label">–ò–º—è:</span>
                                <span id="userName" class="user-info-value">-</span>
                            </div>
                            <div class="user-info-item">
                                <span class="user-info-label">–£—Ä–æ–≤–µ–Ω—å:</span>
                                <span id="userLevel" class="user-info-value">-</span>
                            </div>
                            <div class="user-info-item">
                                <span class="user-info-label">–†–æ–ª—å:</span>
                                <span id="userRole" class="user-info-value">-</span>
                            </div>
                            <div class="user-info-item">
                                <span class="user-info-label">–ü–µ—Ä—Å–æ–Ω–∞–∂:</span>
                                <span id="userCharacter" class="user-info-value">-</span>
                            </div>
                        </div>
                        
                        <div class="sparks pulse" id="sparksCount">‚ú® 0</div>
                        
                        <div id="userStats" style="display: none;">
                            <div class="stats-grid">
                                <div class="stat-item">
                                    <div class="stat-number" id="statQuizzes">0</div>
                                    <div class="stat-label">–ö–≤–∏–∑–æ–≤</div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-number" id="statWorks">0</div>
                                    <div class="stat-label">–†–∞–±–æ—Ç</div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-number" id="statMarathons">0</div>
                                    <div class="stat-label">–ú–∞—Ä–∞—Ñ–æ–Ω–æ–≤</div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-number" id="statInteractives">0</div>
                                    <div class="stat-label">–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–æ–≤</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="welcomeBlock" class="card" style="display: none;">
                <h3 style="text-align: center; margin-bottom: 20px;">üéØ –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –º–∏—Ä —Ç–≤–æ—Ä—á–µ—Å—Ç–≤–∞!</h3>
                <p style="text-align: center; color: #718096; margin-bottom: 24px; line-height: 1.6;">
                    –ü—Ä–∏—Å–æ–µ–¥–∏–Ω—è–π—Ç–µ—Å—å –∫ —Å–æ–æ–±—â–µ—Å—Ç–≤—É —Ç–≤–æ—Ä—á–µ—Å–∫–∏—Ö –ª—é–¥–µ–π. –í—ã–±–µ—Ä–∏—Ç–µ —Å–≤–æ—é —Ä–æ–ª—å –∏ –Ω–∞—á–Ω–∏—Ç–µ –ø—É—Ç—å –∫ –º–∞—Å—Ç–µ—Ä—Å—Ç–≤—É!
                </p>
                <button class="btn pulse" onclick="showScreen('registrationScreen')">
                    –ù–∞—á–∞—Ç—å –ø—É—Ç–µ—à–µ—Å—Ç–≤–∏–µ
                </button>
            </div>

            <div id="actionsBlock" class="card" style="display: none;">
                <h3 style="margin-bottom: 20px; text-align: center;">üöÄ –í–∞—à–∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏</h3>
                <div class="action-grid" id="actionButtons">
                    <!-- –ö–Ω–æ–ø–∫–∏ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                </div>
                
                <!-- –ö–Ω–æ–ø–∫–∞ —Å–º–µ–Ω—ã —Ä–æ–ª–∏ -->
                <button class="btn change-role-btn" onclick="showScreen('changeRoleScreen')" style="margin-top: 16px;">
                    üîÑ –°–º–µ–Ω–∏—Ç—å —Ä–æ–ª—å
                </button>
            </div>
        </div>

        <!-- –≠–∫—Ä–∞–Ω —Å–º–µ–Ω—ã —Ä–æ–ª–∏ -->
        <div id="changeRoleScreen" class="screen">
            <div class="card">
                <button class="btn back-btn" onclick="showScreen('mainScreen')">‚Üê –ù–∞–∑–∞–¥</button>
                <h2 style="text-align: center; margin-bottom: 24px;">üîÑ –°–º–µ–Ω–∞ —Ä–æ–ª–∏</h2>
                
                <div class="info">
                    <p>–í—ã –º–æ–∂–µ—Ç–µ —Å–º–µ–Ω–∏—Ç—å —Ä–æ–ª—å –≤ –ª—é–±–æ–µ –≤—Ä–µ–º—è –±–µ–∑ –ø–æ—Ç–µ—Ä–∏ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –∏ –∏—Å–∫—Ä.</p>
                </div>

                <h3 style="margin-bottom: 16px;">üé≠ –í—ã–±–µ—Ä–∏—Ç–µ –Ω–æ–≤—É—é —Ä–æ–ª—å:</h3>
                <div id="changeRoleList" class="loading">
                    –ó–∞–≥—Ä—É–∑–∫–∞ —Ä–æ–ª–µ–π...
                </div>

                <div id="changeCharactersSection" style="display: none;">
                    <h3 style="margin-bottom: 16px;">üë• –í—ã–±–µ—Ä–∏—Ç–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞:</h3>
                    <div id="changeCharactersList">
                        <!-- –ü–µ—Ä—Å–æ–Ω–∞–∂–∏ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –∑–¥–µ—Å—å -->
                    </div>
                    <button class="btn change-role-btn" onclick="completeRoleChange()" id="completeRoleChangeBtn" disabled>
                        ‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å —Å–º–µ–Ω—É —Ä–æ–ª–∏
                    </button>
                </div>
            </div>
        </div>

        <!-- –≠–∫—Ä–∞–Ω —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ -->
        <div id="registrationScreen" class="screen">
            <div class="card">
                <button class="btn back-btn" onclick="showScreen('mainScreen')">‚Üê –ù–∞–∑–∞–¥</button>
                <h2 style="text-align: center; margin-bottom: 24px;">üìù –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h2>
                
                <div class="form-group">
                    <label style="font-weight: 600; display: block; margin-bottom: 8px;">–í–∞—à–µ –∏–º—è:</label>
                    <input type="text" id="userFirstName" class="form-control" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è" value="">
                </div>

                <h3 style="margin-bottom: 16px;">üé≠ –í—ã–±–µ—Ä–∏—Ç–µ —Ä–æ–ª—å:</h3>
                <div id="rolesList" class="loading">
                    –ó–∞–≥—Ä—É–∑–∫–∞ —Ä–æ–ª–µ–π...
                </div>

                <div id="charactersSection" style="display: none;">
                    <h3 style="margin-bottom: 16px;">üë• –í—ã–±–µ—Ä–∏—Ç–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞:</h3>
                    <div id="charactersList">
                        <!-- –ü–µ—Ä—Å–æ–Ω–∞–∂–∏ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –∑–¥–µ—Å—å -->
                    </div>
                    <button class="btn" onclick="completeRegistration()" id="completeBtn" disabled>
                        ‚úÖ –ó–∞–≤–µ—Ä—à–∏—Ç—å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é
                    </button>
                </div>
            </div>
        </div>

        <!-- –≠–∫—Ä–∞–Ω –∫–≤–∏–∑–æ–≤ -->
        <div id="quizzesScreen" class="screen">
            <div class="card">
                <button class="btn back-btn" onclick="showScreen('mainScreen')">‚Üê –ù–∞–∑–∞–¥</button>
                <h2 style="text-align: center; margin-bottom: 24px;">üéØ –ö–≤–∏–∑—ã –∏ —Ç–µ—Å—Ç—ã</h2>
                <div id="quizzesList" class="loading">
                    –ó–∞–≥—Ä—É–∑–∫–∞ –∫–≤–∏–∑–æ–≤...
                </div>
            </div>
        </div>

        <!-- –≠–∫—Ä–∞–Ω –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è –∫–≤–∏–∑–∞ -->
        <div id="quizScreen" class="screen">
            <div class="card">
                <button class="btn back-btn" onclick="showScreen('quizzesScreen')">‚Üê –ù–∞–∑–∞–¥</button>
                <h2 id="quizTitle" style="text-align: center; margin-bottom: 12px;"></h2>
                <p id="quizDescription" style="text-align: center; color: #718096; margin-bottom: 20px;"></p>
                
                <div class="progress-bar">
                    <div id="quizProgress" class="progress-fill" style="width: 0%"></div>
                </div>
                <div style="text-align: center; color: #718096; margin-bottom: 20px;">
                    –í–æ–ø—Ä–æ—Å <span id="currentQuestion">1</span> –∏–∑ <span id="totalQuestions">0</span>
                </div>
                
                <div id="quizContent">
                    <!-- –í–æ–ø—Ä–æ—Å—ã –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –∑–¥–µ—Å—å -->
                </div>
                
                <button class="btn" onclick="submitQuiz()" id="submitQuizBtn" style="display: none;">
                    ‚úÖ –ó–∞–≤–µ—Ä—à–∏—Ç—å –∫–≤–∏–∑
                </button>
            </div>
        </div>

        <!-- –≠–∫—Ä–∞–Ω —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –∫–≤–∏–∑–∞ -->
        <div id="quizResultScreen" class="screen">
            <div class="card">
                <h2 style="text-align: center; margin-bottom: 24px;">üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∫–≤–∏–∑–∞</h2>
                <div id="quizResultContent">
                    <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –∑–¥–µ—Å—å -->
                </div>
                <button class="btn" onclick="showScreen('quizzesScreen')">üéØ –ö —Å–ø–∏—Å–∫—É –∫–≤–∏–∑–æ–≤</button>
                <button class="btn btn-secondary" onclick="showScreen('mainScreen')">üè† –ù–∞ –≥–ª–∞–≤–Ω—É—é</button>
            </div>
        </div>

        <!-- –≠–∫—Ä–∞–Ω –º–∞—Ä–∞—Ñ–æ–Ω–æ–≤ -->
        <div id="marathonsScreen" class="screen">
            <div class="card">
                <button class="btn back-btn" onclick="showScreen('mainScreen')">‚Üê –ù–∞–∑–∞–¥</button>
                <h2 style="text-align: center; margin-bottom: 24px;">üèÉ‚Äç‚ôÇÔ∏è –¢–≤–æ—Ä—á–µ—Å–∫–∏–µ –º–∞—Ä–∞—Ñ–æ–Ω—ã</h2>
                <div id="marathonsList" class="loading">
                    –ó–∞–≥—Ä—É–∑–∫–∞ –º–∞—Ä–∞—Ñ–æ–Ω–æ–≤...
                </div>
            </div>
        </div>

        <!-- –≠–∫—Ä–∞–Ω –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è –º–∞—Ä–∞—Ñ–æ–Ω–∞ -->
        <div id="marathonScreen" class="screen">
            <div class="card">
                <button class="btn back-btn" onclick="showScreen('marathonsScreen')">‚Üê –ù–∞–∑–∞–¥</button>
                <h2 id="marathonTitle" style="text-align: center; margin-bottom: 12px;"></h2>
                <p id="marathonDescription" style="text-align: center; color: #718096; margin-bottom: 20px;"></p>
                
                <div class="progress-bar">
                    <div id="marathonProgress" class="progress-fill" style="width: 0%"></div>
                </div>
                <div style="text-align: center; color: #718096; margin-bottom: 20px;">
                    –î–µ–Ω—å <span id="currentDay">1</span> –∏–∑ <span id="totalDays">0</span>
                    (<span id="progressPercent">0</span>%)
                </div>
                
                <div id="marathonContent">
                    <!-- –ó–∞–¥–∞–Ω–∏—è –º–∞—Ä–∞—Ñ–æ–Ω–∞ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –∑–¥–µ—Å—å -->
                </div>
            </div>
        </div>

        <!-- –≠–∫—Ä–∞–Ω –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ä–∞–±–æ—Ç—ã –≤ –º–∞—Ä–∞—Ñ–æ–Ω–µ -->
        <div id="marathonSubmissionScreen" class="screen">
            <div class="card">
                <button class="btn back-btn" onclick="showScreen('marathonScreen')">‚Üê –ù–∞–∑–∞–¥</button>
                <h2 id="marathonSubmissionTitle" style="text-align: center; margin-bottom: 12px;"></h2>
                <p id="marathonSubmissionDescription" style="text-align: center; color: #718096; margin-bottom: 20px;"></p>
                
                <div id="textSubmissionSection" style="display: none;">
                    <label style="font-weight: 600; display: block; margin-bottom: 8px;">–û–ø–∏—à–∏—Ç–µ –≤–∞—à—É —Ä–∞–±–æ—Ç—É:</label>
                    <textarea id="marathonSubmissionText" class="form-control" rows="4" placeholder="–†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –æ –≤–∞—à–µ–π —Ä–∞–±–æ—Ç–µ, —Ç—Ä—É–¥–Ω–æ—Å—Ç—è—Ö –∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è—Ö..."></textarea>
                </div>
                
                <div id="imageSubmissionSection" style="display: none;">
                    <div class="upload-area" id="marathonUploadArea" onclick="document.getElementById('marathonImageInput').click()">
                        <div style="font-size: 48px; margin-bottom: 12px;">üìÅ</div>
                        <div style="font-weight: 600; margin-bottom: 8px;">–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–æ—Ç–æ —Ä–∞–±–æ—Ç—ã</div>
                        <div style="color: #718096; font-size: 14px;">–ù–∞–∂–º–∏—Ç–µ –∏–ª–∏ –ø–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–∞–π–ª —Å—é–¥–∞</div>
                    </div>
                    <input type="file" id="marathonImageInput" accept="image/*" style="display: none;" onchange="handleMarathonImageUpload(this.files[0])">
                    
                    <div id="marathonImagePreview" style="display: none;">
                        <img id="marathonPreviewImage" class="work-image">
                        <button class="btn btn-danger" onclick="clearMarathonImage()" style="margin-top: 12px;">
                            üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
                        </button>
                    </div>
                </div>
                
                <button class="btn btn-success" onclick="submitMarathonDay()" id="submitMarathonBtn" style="margin-top: 20px;">
                    üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ä–∞–±–æ—Ç—É
                </button>
            </div>
        </div>

        <!-- –≠–∫—Ä–∞–Ω –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–æ–≤ -->
        <div id="interactivesScreen" class="screen">
            <div class="card">
                <button class="btn back-btn" onclick="showScreen('mainScreen')">‚Üê –ù–∞–∑–∞–¥</button>
                <h2 style="text-align: center; margin-bottom: 24px;">üéÆ –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–¥–∞–Ω–∏—è</h2>
                
                <div class="interactive-tabs">
                    <div class="interactive-tab active" data-category="all">–í—Å–µ</div>
                    <div class="interactive-tab" data-category="history">üèõÔ∏è –ò—Å—Ç–æ—Ä–∏—è</div>
                    <div class="interactive-tab" data-category="style">üëó –°—Ç–∏–ª—å</div>
                    <div class="interactive-tab" data-category="art">üé® –ò—Å–∫—É—Å—Å—Ç–≤–æ</div>
                    <div class="interactive-tab" data-category="craft">üßµ –†–µ–º–µ—Å–ª–æ</div>
                </div>

                <div id="interactivesList" class="loading">
                    –ó–∞–≥—Ä—É–∑–∫–∞ –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–æ–≤...
                </div>
            </div>
        </div>

        <!-- –≠–∫—Ä–∞–Ω –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–∞ -->
        <div id="interactiveScreen" class="screen">
            <div class="card">
                <button class="btn back-btn" onclick="showScreen('interactivesScreen')">‚Üê –ù–∞–∑–∞–¥</button>
                <h2 id="interactiveTitle" style="text-align: center; margin-bottom: 12px;"></h2>
                <p id="interactiveDescription" style="text-align: center; color: #718096; margin-bottom: 20px;"></p>
                
                <div id="interactiveContent">
                    <!-- –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–∞ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –∑–¥–µ—Å—å -->
                </div>
            </div>
        </div>

        <!-- –≠–∫—Ä–∞–Ω —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–∞ -->
        <div id="interactiveResultScreen" class="screen">
            <div class="card">
                <h2 style="text-align: center; margin-bottom: 24px;">üéØ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã</h2>
                <div id="interactiveResultContent">
                    <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –∑–¥–µ—Å—å -->
                </div>
                <button class="btn" onclick="showScreen('interactivesScreen')">üéÆ –ö —Å–ø–∏—Å–∫—É –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–æ–≤</button>
                <button class="btn btn-secondary" onclick="showScreen('mainScreen')">üè† –ù–∞ –≥–ª–∞–≤–Ω—É—é</button>
            </div>
        </div>

        <!-- –≠–∫—Ä–∞–Ω —Ä–∏—Å–æ–≤–∞–ª—å–Ω–æ–≥–æ —á–µ–ª–ª–µ–Ω–¥–∂–∞ -->
        <div id="drawingChallengeScreen" class="screen">
            <div class="card">
                <button class="btn back-btn" onclick="showScreen('interactiveScreen')">‚Üê –ù–∞–∑–∞–¥</button>
                <h2 id="drawingTitle" style="text-align: center; margin-bottom: 12px;"></h2>
                <p id="drawingDescription" style="text-align: center; color: #718096; margin-bottom: 20px;"></p>
                
                <div id="drawingReference">
                    <!-- –†–µ—Ñ–µ—Ä–µ–Ω—Å–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ -->
                </div>
                
                <canvas id="drawingCanvas" class="drawing-canvas"></canvas>
                
                               <div class="drawing-tools">
                    <div class="drawing-tool active" data-tool="brush">üñåÔ∏è –ö–∏—Å—Ç—å</div>
                    <div class="drawing-tool" data-tool="eraser">üßΩ –õ–∞—Å—Ç–∏–∫</div>
                    <div style="display: flex; gap: 8px; align-items: center;">
                        <div class="color-picker active" style="background: #000000;" data-color="#000000"></div>
                        <div class="color-picker" style="background: #ff0000;" data-color="#ff0000"></div>
                        <div class="color-picker" style="background: #0000ff;" data-color="#0000ff"></div>
                        <div class="color-picker" style="background: #00ff00;" data-color="#00ff00"></div>
                        <div class="color-picker" style="background: #ffff00;" data-color="#ffff00"></div>
                    </div>
                </div>
                
                <button class="btn" onclick="submitDrawing()" style="margin-top: 20px;">
                    üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ä–∏—Å—É–Ω–æ–∫
                </button>
            </div>
        </div>

        <!-- –≠–∫—Ä–∞–Ω –º–∞–≥–∞–∑–∏–Ω–∞ -->
        <div id="shopScreen" class="screen">
            <div class="card">
                <button class="btn back-btn" onclick="showScreen('mainScreen')">‚Üê –ù–∞–∑–∞–¥</button>
                <h2 style="text-align: center; margin-bottom: 24px;">üõí –ú–∞–≥–∞–∑–∏–Ω –∑–Ω–∞–Ω–∏–π</h2>
                
                <div class="shop-tabs">
                    <div class="shop-tab active" onclick="showShopTab('items')">üõçÔ∏è –¢–æ–≤–∞—Ä—ã</div>
                    <div class="shop-tab" onclick="showShopTab('purchases')">üì¶ –ú–æ–∏ –ø–æ–∫—É–ø–∫–∏</div>
                </div>

                <div id="shopItemsTab">
                    <div id="shopItemsList" class="loading">
                        –ó–∞–≥—Ä—É–∑–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤...
                    </div>
                </div>

                <div id="shopPurchasesTab" style="display: none;">
                    <div id="purchasesList" class="loading">
                        –ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ–∫—É–ø–æ–∫...
                    </div>
                </div>
            </div>
        </div>

        <!-- –≠–∫—Ä–∞–Ω –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Ç–æ–≤–∞—Ä–∞ -->
        <div id="shopItemScreen" class="screen">
            <div class="card">
                <button class="btn back-btn" onclick="showScreen('shopScreen')">‚Üê –ù–∞–∑–∞–¥</button>
                <h2 id="shopItemTitle" style="text-align: center; margin-bottom: 12px;"></h2>
                <p id="shopItemDescription" style="text-align: center; color: #718096; margin-bottom: 20px;"></p>
                
                <div id="shopItemContent">
                    <!-- –°–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ç–æ–≤–∞—Ä–∞ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –∑–¥–µ—Å—å -->
                </div>
                
                <div style="text-align: center; margin: 24px 0;">
                    <div style="font-size: 24px; font-weight: bold; color: #f6e05e;">
                        üí∞ <span id="shopItemPrice">0</span> –∏—Å–∫—Ä
                    </div>
                </div>
                
                <button class="btn btn-success" onclick="purchaseItem()" id="purchaseBtn">
                    üõí –ö—É–ø–∏—Ç—å —Å–µ–π—á–∞—Å
                </button>
                <button class="btn btn-danger" onclick="showScreen('shopScreen')">
                    ‚ùå –û—Ç–º–µ–Ω–∞
                </button>
            </div>
        </div>

        <!-- –≠–∫—Ä–∞–Ω –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ø–æ–∫—É–ø–∫–∏ -->
        <div id="purchaseScreen" class="screen">
            <div class="card">
                <button class="btn back-btn" onclick="showScreen('shopScreen')">‚Üê –ù–∞–∑–∞–¥</button>
                <h2 id="purchaseTitle" style="text-align: center; margin-bottom: 12px;"></h2>
                
                <div id="purchaseContent">
                    <!-- –°–æ–¥–µ—Ä–∂–∏–º–æ–µ –ø–æ–∫—É–ø–∫–∏ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –∑–¥–µ—Å—å -->
                </div>
                
                <div class="purchase-actions">
                    <button class="purchase-btn purchase-btn-primary" onclick="downloadPurchase()">
                        üíæ –°–∫–∞—á–∞—Ç—å
                    </button>
                    <button class="purchase-btn purchase-btn-success" onclick="viewPurchaseMedia()">
                        üëÅÔ∏è –ü—Ä–æ—Å–º–æ—Ç—Ä
                    </button>
                    <button class="purchase-btn" onclick="showScreen('shopScreen')">
                        üõí –í –º–∞–≥–∞–∑–∏–Ω
                    </button>
                </div>
            </div>
        </div>

        <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –º–µ–¥–∏–∞ -->
        <div id="mediaModal" class="media-modal" style="display: none;">
            <div class="media-modal-content">
                <button class="media-modal-btn media-modal-close" onclick="closeMediaModal()">‚úï</button>
                <button class="media-modal-btn media-modal-download" onclick="downloadMedia()">üíæ</button>
                <img id="modalImage" class="media-modal-image">
                <video id="modalVideo" class="media-modal-video" controls></video>
            </div>
        </div>

        <!-- –≠–∫—Ä–∞–Ω —Ä–∞–±–æ—Ç -->
        <div id="worksScreen" class="screen">
            <div class="card">
                <button class="btn back-btn" onclick="showScreen('mainScreen')">‚Üê –ù–∞–∑–∞–¥</button>
                <h2 style="text-align: center; margin-bottom: 24px;">üñºÔ∏è –ú–æ–∏ —Ä–∞–±–æ—Ç—ã</h2>
                
                <div class="works-tabs">
                    <div class="works-tab active" onclick="showWorksTab('all')">–í—Å–µ</div>
                    <div class="works-tab" onclick="showWorksTab('pending')">‚è≥ –ù–∞ –ø—Ä–æ–≤–µ—Ä–∫–µ</div>
                    <div class="works-tab" onclick="showWorksTab('approved')">‚úÖ –û–¥–æ–±—Ä–µ–Ω–Ω—ã–µ</div>
                    <div class="works-tab" onclick="showWorksTab('rejected')">‚ùå –û—Ç–∫–ª–æ–Ω–µ–Ω–Ω—ã–µ</div>
                </div>

                <button class="btn btn-success" onclick="showScreen('uploadWorkScreen')" style="margin-bottom: 20px;">
                    üì§ –ó–∞–≥—Ä—É–∑–∏—Ç—å –Ω–æ–≤—É—é —Ä–∞–±–æ—Ç—É
                </button>

                <div id="worksList" class="loading">
                    –ó–∞–≥—Ä—É–∑–∫–∞ —Ä–∞–±–æ—Ç...
                </div>
            </div>
        </div>

        <!-- –≠–∫—Ä–∞–Ω –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–∞–±–æ—Ç—ã -->
        <div id="uploadWorkScreen" class="screen">
            <div class="card">
                <button class="btn back-btn" onclick="showScreen('worksScreen')">‚Üê –ù–∞–∑–∞–¥</button>
                <h2 style="text-align: center; margin-bottom: 24px;">üì§ –ó–∞–≥—Ä—É–∑–∫–∞ —Ä–∞–±–æ—Ç—ã</h2>
                
                <div class="form-group">
                    <label style="font-weight: 600; display: block; margin-bottom: 8px;">–ù–∞–∑–≤–∞–Ω–∏–µ —Ä–∞–±–æ—Ç—ã:</label>
                    <input type="text" id="workTitle" class="form-control" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –≤–∞—à–µ–π —Ä–∞–±–æ—Ç—ã">
                </div>
                
                <div class="form-group">
                    <label style="font-weight: 600; display: block; margin-bottom: 8px;">–û–ø–∏—Å–∞–Ω–∏–µ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):</label>
                    <textarea id="workDescription" class="form-control" rows="3" placeholder="–†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –æ –≤–∞—à–µ–π —Ä–∞–±–æ—Ç–µ..."></textarea>
                </div>
                
                <div class="form-group">
                    <label style="font-weight: 600; display: block; margin-bottom: 8px;">–¢–∏–ø —Ä–∞–±–æ—Ç—ã:</label>
                    <select id="workType" class="form-control">
                        <option value="painting">üé® –ñ–∏–≤–æ–ø–∏—Å—å</option>
                        <option value="drawing">‚úèÔ∏è –†–∏—Å—É–Ω–æ–∫</option>
                        <option value="digital">üíª –¶–∏—Ñ—Ä–æ–≤–æ–µ –∏—Å–∫—É—Å—Å—Ç–≤–æ</option>
                        <option value="photo">üì∑ –§–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è</option>
                        <option value="craft">üßµ –†–µ–º–µ—Å–ª–æ</option>
                    </select>
                </div>
                
                <div class="upload-area" id="workUploadArea" onclick="document.getElementById('workImageInput').click()">
                    <div style="font-size: 48px; margin-bottom: 12px;">üìÅ</div>
                    <div style="font-weight: 600; margin-bottom: 8px;">–ó–∞–≥—Ä—É–∑–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ä–∞–±–æ—Ç—ã</div>
                    <div style="color: #718096; font-size: 14px;">–ù–∞–∂–º–∏—Ç–µ –∏–ª–∏ –ø–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–∞–π–ª —Å—é–¥–∞</div>
                    <div style="color: #718096; font-size: 12px; margin-top: 8px;">–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è: JPG, PNG, GIF (–º–∞–∫—Å. 10MB)</div>
                </div>
                <input type="file" id="workImageInput" accept="image/*" style="display: none;" onchange="handleWorkImageUpload(this.files[0])">
                
                <div id="workImagePreview" style="display: none;">
                    <img id="workPreviewImage" class="work-image">
                    <button class="btn btn-danger" onclick="clearWorkImage()" style="margin-top: 12px;">
                        üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
                    </button>
                </div>
                
                <button class="btn btn-success" onclick="submitWork()" id="submitWorkBtn" disabled style="margin-top: 20px;">
                    üì§ –û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å —Ä–∞–±–æ—Ç—É
                </button>
            </div>
        </div>

        <!-- –≠–∫—Ä–∞–Ω –ø–æ—Å—Ç–æ–≤ -->
        <div id="postsScreen" class="screen">
            <div class="card">
                <button class="btn back-btn" onclick="showScreen('mainScreen')">‚Üê –ù–∞–∑–∞–¥</button>
                <h2 style="text-align: center; margin-bottom: 24px;">üì∞ –ü–æ–ª–µ–∑–Ω—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã</h2>
                <div id="postsList" class="loading">
                    –ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ—Å—Ç–æ–≤...
                </div>
            </div>
        </div>

        <!-- –≠–∫—Ä–∞–Ω –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ø–æ—Å—Ç–∞ -->
        <div id="postScreen" class="screen">
            <div class="card">
                <button class="btn back-btn" onclick="showScreen('postsScreen')">‚Üê –ù–∞–∑–∞–¥</button>
                <h2 id="postTitle" style="text-align: center; margin-bottom: 12px;"></h2>
                
                <div id="postMedia" style="margin-bottom: 20px;">
                    <!-- –ú–µ–¥–∏–∞ –ø–æ—Å—Ç–∞ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –∑–¥–µ—Å—å -->
                </div>
                
                <div id="postContent" style="line-height: 1.6; margin-bottom: 24px;">
                    <!-- –°–æ–¥–µ—Ä–∂–∏–º–æ–µ –ø–æ—Å—Ç–∞ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –∑–¥–µ—Å—å -->
                </div>
                
                <div class="form-group">
                    <label style="font-weight: 600; display: block; margin-bottom: 8px;">–í–∞—à –æ—Ç–∑—ã–≤:</label>
                    <textarea id="postReview" class="form-control" rows="3" placeholder="–ü–æ–¥–µ–ª–∏—Ç–µ—Å—å –≤–∞—à–∏–º –º–Ω–µ–Ω–∏–µ–º –æ –º–∞—Ç–µ—Ä–∏–∞–ª–µ..."></textarea>
                </div>
                
                <div class="form-group">
                    <label style="font-weight: 600; display: block; margin-bottom: 8px;">–û—Ü–µ–Ω–∫–∞:</label>
                    <div style="display: flex; gap: 8px; margin-top: 8px;">
                        <button class="rating-btn" data-rating="1">1 ‚≠ê</button>
                        <button class="rating-btn" data-rating="2">2 ‚≠ê</button>
                        <button class="rating-btn" data-rating="3">3 ‚≠ê</button>
                        <button class="rating-btn" data-rating="4">4 ‚≠ê</button>
                        <button class="rating-btn" data-rating="5">5 ‚≠ê</button>
                    </div>
                </div>
                
                <button class="btn btn-success" onclick="submitPostReview()">
                    üìù –û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤
                </button>
            </div>
        </div>

        <!-- –≠–∫—Ä–∞–Ω –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–µ–π -->
        <div id="activitiesScreen" class="screen">
            <div class="card">
                <button class="btn back-btn" onclick="showScreen('mainScreen')">‚Üê –ù–∞–∑–∞–¥</button>
                <h2 style="text-align: center; margin-bottom: 24px;">üìà –ò—Å—Ç–æ—Ä–∏—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–µ–π</h2>
                <div id="activitiesList" class="loading">
                    –ó–∞–≥—Ä—É–∑–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–µ–π...
                </div>
            </div>
        </div>

        <!-- –≠–∫—Ä–∞–Ω –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è –¥—Ä—É–∑–µ–π -->
        <div id="inviteScreen" class="screen">
            <div class="card">
                <button class="btn back-btn" onclick="showScreen('mainScreen')">‚Üê –ù–∞–∑–∞–¥</button>
                <h2 style="text-align: center; margin-bottom: 24px;">üë• –ü—Ä–∏–≥–ª–∞—Å–∏—Ç–µ –¥—Ä—É–∑–µ–π</h2>
                
                <div class="info">
                    <p>–ü—Ä–∏–≥–ª–∞—à–∞–π—Ç–µ –¥—Ä—É–∑–µ–π –∏ –ø–æ–ª—É—á–∞–π—Ç–µ –±–æ–Ω—É—Å—ã!</p>
                </div>

                <div style="text-align: center; margin: 24px 0;">
                    <div style="font-size: 18px; font-weight: 600; margin-bottom: 12px;">–í–∞—à–∞ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å—Å—ã–ª–∫–∞:</div>
                    <div style="background: #f7fafc; border: 2px dashed #667eea; border-radius: 12px; padding: 16px; word-break: break-all; font-size: 14px; margin-bottom: 16px;" id="referralLink">
                        –ó–∞–≥—Ä—É–∑–∫–∞...
                    </div>
                    <button class="btn btn-info" onclick="copyReferralLink()">
                        üìã –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É
                    </button>
                </div>

                <div style="text-align: center;">
                    <div class="spark-badge" style="font-size: 16px; padding: 12px 20px;">
                        +10 –∏—Å–∫—Ä –∑–∞ –∫–∞–∂–¥–æ–≥–æ –¥—Ä—É–≥–∞
                    </div>
                </div>
            </div>
        </div>

        <!-- –≠–∫—Ä–∞–Ω —á–µ–ª–ª–µ–Ω–¥–∂–∞ –∫–æ–º–ø–ª–∏–º–µ–Ω—Ç–æ–≤ -->
        <div id="complimentScreen" class="screen">
            <div class="card">
                <button class="btn back-btn" onclick="showScreen('mainScreen')">‚Üê –ù–∞–∑–∞–¥</button>
                <h2 style="text-align: center; margin-bottom: 24px;">üíù –ß–µ–ª–ª–µ–Ω–¥–∂ –∫–æ–º–ø–ª–∏–º–µ–Ω—Ç–æ–≤</h2>
                
                <div class="info">
                    <p>–û—Å—Ç–∞–≤—å—Ç–µ –∫–æ–º–ø–ª–∏–º–µ–Ω—Ç —Ä–∞–±–æ—Ç–µ –¥—Ä—É–≥–æ–≥–æ —É—á–∞—Å—Ç–Ω–∏–∫–∞ –∏ –ø–æ–ª—É—á–∏—Ç–µ –∏—Å–∫—Ä—ã!</p>
                </div>

                <div class="form-group">
                    <label style="font-weight: 600; display: block; margin-bottom: 8px;">–í–∞—à –∫–æ–º–ø–ª–∏–º–µ–Ω—Ç:</label>
                    <textarea id="complimentText" class="compliment-input" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ –¥–æ–±—Ä—ã–π –∏ –∏—Å–∫—Ä–µ–Ω–Ω–∏–π –∫–æ–º–ø–ª–∏–º–µ–Ω—Ç —á—å–µ–π-—Ç–æ —Ä–∞–±–æ—Ç–µ..."></textarea>
                </div>

                <div style="text-align: center; margin: 20px 0;">
                    <div class="spark-badge" style="font-size: 16px; padding: 12px 20px;">
                        +0.5 –∏—Å–∫—Ä –∑–∞ –∫–æ–º–ø–ª–∏–º–µ–Ω—Ç
                    </div>
                    <div style="color: #718096; font-size: 14px; margin-top: 8px;">
                        –ú–æ–∂–Ω–æ —É—á–∞—Å—Ç–≤–æ–≤–∞—Ç—å 1 —Ä–∞–∑ –≤ –¥–µ–Ω—å
                    </div>
                </div>

                <button class="btn btn-success" onclick="submitCompliment()">
                    üíù –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–æ–º–ø–ª–∏–º–µ–Ω—Ç
                </button>
            </div>
        </div>

        <!-- –°–æ–æ–±—â–µ–Ω–∏—è -->
        <div id="messageArea"></div>
    </div>

    <script>
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let tg = null;
        let currentUser = null;
        let currentScreen = 'mainScreen';
        let currentQuiz = null;
        let currentMarathon = null;
        let currentInteractive = null;
        let currentShopItem = null;
        let currentPurchase = null;
        let currentPost = null;
        let quizAnswers = [];
        let selectedRating = 0;
        let currentWorkImage = null;
        let currentMarathonImage = null;
        let currentDrawing = null;

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        async function initApp() {
            console.log("üöÄ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è...");
            
            try {
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram Web App
                tg = window.Telegram.WebApp;
                tg.expand();
                tg.enableClosingConfirmation();
                
                // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                const initData = tg.initDataUnsafe;
                const userId = initData.user?.id;
                
                if (!userId) {
                    showError('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
                    return;
                }
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                await loadUserData(userId);
                
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º drag and drop
                initializeAppDragAndDrop();
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:', error);
                showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è');
            }
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è drag and drop
        function initializeAppDragAndDrop() {
            const uploadAreas = ['workUploadArea', 'marathonUploadArea'];
            
            uploadAreas.forEach(areaId => {
                const area = document.getElementById(areaId);
                if (!area) return;
                
                ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                    area.addEventListener(eventName, preventDefaults, false);
                });
                
                ['dragenter', 'dragover'].forEach(eventName => {
                    area.addEventListener(eventName, highlight, false);
                });
                
                ['dragleave', 'drop'].forEach(eventName => {
                    area.addEventListener(eventName, unhighlight, false);
                });
                
                area.addEventListener('drop', handleAppDrop, false);
            });
            
            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }
            
            function highlight() {
                this.classList.add('dragover');
            }
            
            function unhighlight() {
                this.classList.remove('dragover');
            }
            
            function handleAppDrop(e) {
                const dt = e.dataTransfer;
                const files = dt.files;
                
                if (files.length > 0) {
                    const areaId = this.id;
                    
                    if (areaId === 'workUploadArea') {
                        handleWorkImageUpload(files[0]);
                    } else if (areaId === 'marathonUploadArea') {
                        handleMarathonImageUpload(files[0]);
                    }
                }
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        async function loadUserData(userId) {
            try {
                const response = await fetch(`/api/users/${userId}`);
                const data = await response.json();
                
                if (data.exists) {
                    currentUser = data.user;
                    showUserData();
                    
                    if (!currentUser.is_registered) {
                        showWelcomeScreen();
                    } else {
                        showMainScreen();
                    }
                } else {
                    currentUser = data.user;
                    showWelcomeScreen();
                }
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö:', error);
                showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
            }
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        function showUserData() {
            document.getElementById('userName').textContent = currentUser.tg_first_name || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
            document.getElementById('userLevel').textContent = currentUser.level;
            document.getElementById('userRole').textContent = currentUser.class || '–ù–µ –≤—ã–±—Ä–∞–Ω–∞';
            document.getElementById('userCharacter').textContent = currentUser.character_name || '–ù–µ –≤—ã–±—Ä–∞–Ω';
            document.getElementById('sparksCount').textContent = `‚ú® ${currentUser.sparks.toFixed(1)}`;
            
            if (currentUser.stats) {
                document.getElementById('statQuizzes').textContent = currentUser.stats.totalQuizzesCompleted;
                document.getElementById('statWorks').textContent = currentUser.stats.totalWorks;
                document.getElementById('statMarathons').textContent = currentUser.stats.totalMarathonsCompleted;
                document.getElementById('statInteractives').textContent = currentUser.stats.totalInteractivesCompleted;
                document.getElementById('userStats').style.display = 'block';
            }
            
            document.getElementById('userContent').style.display = 'block';
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å —ç–∫—Ä–∞–Ω –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è
        function showWelcomeScreen() {
            document.getElementById('welcomeBlock').style.display = 'block';
            document.getElementById('actionsBlock').style.display = 'none';
            loadRoles();
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å –≥–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω
        function showMainScreen() {
            document.getElementById('welcomeBlock').style.display = 'none';
            document.getElementById('actionsBlock').style.display = 'block';
            loadActionButtons();
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –∫–Ω–æ–ø–æ–∫ –¥–µ–π—Å—Ç–≤–∏–π
        function loadActionButtons() {
            const actionsContainer = document.getElementById('actionButtons');
            actionsContainer.innerHTML = '';
            
            const availableButtons = currentUser.available_buttons || [];
            
            const actions = [
                { id: 'quiz', icon: 'üéØ', title: '–ö–≤–∏–∑—ã', description: '–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∑–Ω–∞–Ω–∏—è', screen: 'quizzesScreen' },
                { id: 'marathon', icon: 'üèÉ‚Äç‚ôÇÔ∏è', title: '–ú–∞—Ä–∞—Ñ–æ–Ω—ã', description: '–î–ª–∏—Ç–µ–ª—å–Ω—ã–µ –∑–∞–¥–∞–Ω–∏—è', screen: 'marathonsScreen' },
                { id: 'works', icon: 'üñºÔ∏è', title: '–ú–æ–∏ —Ä–∞–±–æ—Ç—ã', description: '–í–∞—à–∏ —Ç–≤–æ—Ä–µ–Ω–∏—è', screen: 'worksScreen' },
                { id: 'activities', icon: 'üìà', title: '–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏', description: '–ò—Å—Ç–æ—Ä–∏—è –¥–µ–π—Å—Ç–≤–∏–π', screen: 'activitiesScreen' },
                { id: 'posts', icon: 'üì∞', title: '–ú–∞—Ç–µ—Ä–∏–∞–ª—ã', description: '–ü–æ–ª–µ–∑–Ω—ã–µ –ø–æ—Å—Ç—ã', screen: 'postsScreen' },
                { id: 'shop', icon: 'üõí', title: '–ú–∞–≥–∞–∑–∏–Ω', description: '–ü–æ–∫—É–ø–∞–π—Ç–µ –∑–Ω–∞–Ω–∏—è', screen: 'shopScreen' },
                { id: 'invite', icon: 'üë•', title: '–ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å', description: '–ü—Ä–∏–≥–ª–∞—Å–∏—Ç–µ –¥—Ä—É–∑–µ–π', screen: 'inviteScreen' },
                { id: 'interactives', icon: 'üéÆ', title: '–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤—ã', description: '–ò–Ω—Ç–µ—Ä–µ—Å–Ω—ã–µ –∑–∞–¥–∞–Ω–∏—è', screen: 'interactivesScreen' }
            ];
            
            actions.forEach(action => {
                if (availableButtons.includes(action.id)) {
                    const actionElement = document.createElement('div');
                    actionElement.className = 'feature-card';
                    actionElement.onclick = () => showScreen(action.screen);
                    
                    actionElement.innerHTML = `
                        <div class="feature-icon">${action.icon}</div>
                        <div class="feature-title">${action.title}</div>
                        <div class="feature-description">${action.description}</div>
                    `;
                    
                    actionsContainer.appendChild(actionElement);
                }
            });
            
            // –î–æ–±–∞–≤–ª—è–µ–º —á–µ–ª–ª–µ–Ω–¥–∂ –∫–æ–º–ø–ª–∏–º–µ–Ω—Ç–æ–≤
            const complimentAction = document.createElement('div');
            complimentAction.className = 'feature-card';
            complimentAction.onclick = () => showScreen('complimentScreen');
            complimentAction.innerHTML = `
                <div class="feature-icon">üíù</div>
                <div class="feature-title">–ö–æ–º–ø–ª–∏–º–µ–Ω—Ç—ã</div>
                <div class="feature-description">–î–∞—Ä–∏—Ç–µ –¥–æ–±—Ä–æ</div>
            `;
            actionsContainer.appendChild(complimentAction);
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å —ç–∫—Ä–∞–Ω
        function showScreen(screenName) {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            
            document.getElementById(screenName).classList.add('active');
            currentScreen = screenName;
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è —ç–∫—Ä–∞–Ω–∞
            switch(screenName) {
                case 'quizzesScreen':
                    loadQuizzes();
                    break;
                case 'marathonsScreen':
                    loadMarathons();
                    break;
                case 'interactivesScreen':
                    loadInteractives();
                    break;
                case 'shopScreen':
                    loadShopItems();
                    break;
                case 'worksScreen':
                    loadWorks();
                    break;
                case 'postsScreen':
                    loadPosts();
                    break;
                case 'activitiesScreen':
                    loadActivities();
                    break;
                case 'inviteScreen':
                    loadReferralLink();
                    break;
            }
        }

        // ==================== –†–ï–ì–ò–°–¢–†–ê–¶–ò–Ø ====================

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Ä–æ–ª–µ–π
        async function loadRoles() {
            try {
                const response = await fetch('/api/webapp/roles');
                const roles = await response.json();
                
                const rolesContainer = document.getElementById('rolesList');
                const changeRolesContainer = document.getElementById('changeRoleList');
                
                rolesContainer.innerHTML = '';
                changeRolesContainer.innerHTML = '';
                
                roles.forEach(role => {
                    const roleElement = createRoleElement(role, 'registration');
                    const changeRoleElement = createRoleElement(role, 'change');
                    
                    rolesContainer.appendChild(roleElement);
                    changeRolesContainer.appendChild(changeRoleElement);
                });
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–æ–ª–µ–π:', error);
                showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–æ–ª–µ–π');
            }
        }

        // –°–æ–∑–¥–∞–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–∞ —Ä–æ–ª–∏
        function createRoleElement(role, type) {
            const element = document.createElement('div');
            element.className = 'role-card';
            element.dataset.roleId = role.id;
            
            element.innerHTML = `
                <div style="display: flex; align-items: center; gap: 12px;">
                    <div style="font-size: 24px;">${role.icon}</div>
                    <div>
                        <div style="font-weight: 600; margin-bottom: 4px;">${role.name}</div>
                        <div style="color: #718096; font-size: 14px;">${role.description}</div>
                    </div>
                </div>
            `;
            
            element.onclick = () => selectRole(role.id, type);
            return element;
        }

        // –í—ã–±–æ—Ä —Ä–æ–ª–∏
        async function selectRole(roleId, type) {
            // –£–±–∏—Ä–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Å–æ –≤—Å–µ—Ö —Ä–æ–ª–µ–π
            document.querySelectorAll('.role-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            // –í—ã–¥–µ–ª—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é —Ä–æ–ª—å
            document.querySelectorAll(`.role-card[data-role-id="${roleId}"]`).forEach(card => {
                card.classList.add('selected');
            });
            
            try {
                const response = await fetch(`/api/webapp/characters/${roleId}`);
                const characters = await response.json();
                
                const charactersContainer = type === 'registration' ? 
                    document.getElementById('charactersList') : 
                    document.getElementById('changeCharactersList');
                
                charactersContainer.innerHTML = '';
                
                characters.forEach(character => {
                    const characterElement = document.createElement('div');
                    characterElement.className = 'character-card';
                    characterElement.dataset.characterId = character.id;
                    
                    characterElement.innerHTML = `
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <div style="font-size: 24px;">üë§</div>
                            <div style="flex: 1;">
                                <div style="font-weight: 600; margin-bottom: 4px;">${character.name}</div>
                                <div style="color: #718096; font-size: 14px; margin-bottom: 8px;">${character.description}</div>
                                <div style="font-size: 12px; color: #667eea;">
                                    –ë–æ–Ω—É—Å: ${getBonusDescription(character)}
                                </div>
                            </div>
                        </div>
                    `;
                    
                    characterElement.onclick = () => selectCharacter(character.id, type);
                    charactersContainer.appendChild(characterElement);
                });
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–µ–∫—Ü–∏—é —Å –ø–µ—Ä—Å–æ–Ω–∞–∂–∞–º–∏
                if (type === 'registration') {
                    document.getElementById('charactersSection').style.display = 'block';
                } else {
                    document.getElementById('changeCharactersSection').style.display = 'block';
                }
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π:', error);
                showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π');
            }
        }

        // –ü–æ–ª—É—á–µ–Ω–∏–µ –æ–ø–∏—Å–∞–Ω–∏—è –±–æ–Ω—É—Å–∞
        function getBonusDescription(character) {
            switch(character.bonus_type) {
                case 'percent_bonus':
                    return `+${character.bonus_value}% –∫ –Ω–∞–≥—Ä–∞–¥–∞–º`;
                case 'forgiveness':
                    return '–ü—Ä–∞–≤–æ –Ω–∞ –æ—à–∏–±–∫—É –≤ –∫–≤–∏–∑–∞—Ö';
                case 'random_gift':
                    return '–°–ª—É—á–∞–π–Ω—ã–µ –ø–æ–¥–∞—Ä–∫–∏';
                case 'secret_advice':
                    return '–°–µ–∫—Ä–µ—Ç–Ω—ã–µ —Å–æ–≤–µ—Ç—ã';
                default:
                    return '–û—Å–æ–±—ã–π –±–æ–Ω—É—Å';
            }
        }

        // –í—ã–±–æ—Ä –ø–µ—Ä—Å–æ–Ω–∞–∂–∞
        function selectCharacter(characterId, type) {
            // –£–±–∏—Ä–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Å–æ –≤—Å–µ—Ö –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π
            document.querySelectorAll('.character-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            // –í—ã–¥–µ–ª—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞
            document.querySelectorAll(`.character-card[data-character-id="${characterId}"]`).forEach(card => {
                card.classList.add('selected');
            });
            
            // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
            if (type === 'registration') {
                document.getElementById('completeBtn').disabled = false;
            } else {
                document.getElementById('completeRoleChangeBtn').disabled = false;
            }
        }

        // –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
        async function completeRegistration() {
            const firstName = document.getElementById('userFirstName').value.trim();
            const selectedRole = document.querySelector('.role-card.selected');
            const selectedCharacter = document.querySelector('.character-card.selected');
            
            if (!firstName) {
                showError('–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è');
                return;
            }
            
            if (!selectedRole || !selectedCharacter) {
                showError('–í—ã–±–µ—Ä–∏—Ç–µ —Ä–æ–ª—å –∏ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞');
                return;
            }
            
            const roleId = selectedRole.dataset.roleId;
            const characterId = selectedCharacter.dataset.characterId;
            
            try {
                const response = await fetch('/api/users/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        userId: currentUser.user_id,
                        firstName: firstName,
                        roleId: parseInt(roleId),
                        characterId: parseInt(characterId)
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    currentUser = result.user;
                    showUserData();
                    showMainScreen();
                    showMessage(result.message, 'success');
                } else {
                    showError(result.error);
                }
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:', error);
                showError('–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏');
            }
        }

        // –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Å–º–µ–Ω—ã —Ä–æ–ª–∏
        async function completeRoleChange() {
            const selectedRole = document.querySelector('#changeRoleList .role-card.selected');
            const selectedCharacter = document.querySelector('#changeCharactersList .character-card.selected');
            
            if (!selectedRole || !selectedCharacter) {
                showError('–í—ã–±–µ—Ä–∏—Ç–µ —Ä–æ–ª—å –∏ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞');
                return;
            }
            
            const roleId = selectedRole.dataset.roleId;
            const characterId = selectedCharacter.dataset.characterId;
            
            try {
                const response = await fetch('/api/users/change-role', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        userId: currentUser.user_id,
                        roleId: parseInt(roleId),
                        characterId: parseInt(characterId)
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    currentUser = result.user;
                    showUserData();
                    loadActionButtons();
                    showScreen('mainScreen');
                    showMessage(result.message, 'success');
                } else {
                    showError(result.error);
                }
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —Å–º–µ–Ω—ã —Ä–æ–ª–∏:', error);
                showError('–û—à–∏–±–∫–∞ —Å–º–µ–Ω—ã —Ä–æ–ª–∏');
            }
        }

        // ==================== –ö–í–ò–ó–´ ====================

        // –ó–∞–≥—Ä—É–∑–∫–∞ –∫–≤–∏–∑–æ–≤
        async function loadQuizzes() {
            try {
                const response = await fetch(`/api/webapp/quizzes?userId=${currentUser.user_id}`);
                const quizzes = await response.json();
                
                const container = document.getElementById('quizzesList');
                container.innerHTML = '';
                
                if (quizzes.length === 0) {
                    container.innerHTML = '<div class="info">–ü–æ–∫–∞ –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∫–≤–∏–∑–æ–≤</div>';
                    return;
                }
                
                quizzes.forEach(quiz => {
                    const quizElement = document.createElement('div');
                    quizElement.className = 'quiz-card';
                    quizElement.onclick = () => startQuiz(quiz);
                    
                    let statusBadge = '';
                    if (quiz.completed) {
                        statusBadge = `<span class="badge badge-success">‚úÖ –ü—Ä–æ–π–¥–µ–Ω</span>`;
                        if (quiz.can_retake) {
                            statusBadge += `<span class="badge badge-warning" style="margin-left: 8px;">üîÑ –î–æ—Å—Ç—É–ø–µ–Ω –ø–æ–≤—Ç–æ—Ä</span>`;
                        }
                    } else {
                        statusBadge = `<span class="badge badge-info">üéØ –î–æ—Å—Ç—É–ø–µ–Ω</span>`;
                    }
                    
                    quizElement.innerHTML = `
                        <div style="display: flex; justify-content: between; align-items: start; margin-bottom: 12px;">
                            <h3 style="flex: 1; margin: 0;">${quiz.title}</h3>
                            ${statusBadge}
                        </div>
                        <p style="color: #718096; margin-bottom: 12px;">${quiz.description}</p>
                        <div style="display: flex; justify-content: space-between; color: #718096; font-size: 14px;">
                            <span>üìù ${quiz.total_questions} –≤–æ–ø—Ä–æ—Å–æ–≤</span>
                            <span>‚ú® –¥–æ ${quiz.total_questions * quiz.sparks_per_correct + quiz.sparks_perfect_bonus} –∏—Å–∫—Ä</span>
                        </div>
                        ${quiz.completed ? `<div style="margin-top: 8px; color: #48bb78; font-size: 14px;">–í–∞—à —Ä–µ–∑—É–ª—å—Ç–∞—Ç: ${quiz.user_score}/${quiz.total_questions}</div>` : ''}
                    `;
                    
                    container.appendChild(quizElement);
                });
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–≤–∏–∑–æ–≤:', error);
                showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–≤–∏–∑–æ–≤');
            }
        }

        // –ù–∞—á–∞—Ç—å –∫–≤–∏–∑
        function startQuiz(quiz) {
            if (quiz.completed && !quiz.can_retake) {
                showError('–≠—Ç–æ—Ç –∫–≤–∏–∑ —É–∂–µ –ø—Ä–æ–π–¥–µ–Ω –∏ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è');
                return;
            }
            
            currentQuiz = quiz;
            quizAnswers = [];
            
            document.getElementById('quizTitle').textContent = quiz.title;
            document.getElementById('quizDescription').textContent = quiz.description;
            document.getElementById('totalQuestions').textContent = quiz.questions.length;
            
            showScreen('quizScreen');
            showQuizQuestion(0);
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å –≤–æ–ø—Ä–æ—Å –∫–≤–∏–∑–∞
        function showQuizQuestion(questionIndex) {
            if (!currentQuiz || questionIndex >= currentQuiz.questions.length) {
                document.getElementById('submitQuizBtn').style.display = 'block';
                return;
            }
            
            const question = currentQuiz.questions[questionIndex];
            const container = document.getElementById('quizContent');
            
            document.getElementById('currentQuestion').textContent = questionIndex + 1;
            document.getElementById('quizProgress').style.width = `${((questionIndex) / currentQuiz.questions.length) * 100}%`;
            
            let optionsHtml = '';
            question.options.forEach((option, index) => {
                optionsHtml += `
                    <div class="option" data-option="${index}">
                        ${option}
                    </div>
                `;
            });
            
            container.innerHTML = `
                <div class="question">
                    <h3 style="margin-bottom: 16px;">${question.question}</h3>
                    <div class="options">
                        ${optionsHtml}
                    </div>
                </div>
                <button class="btn" onclick="nextQuizQuestion(${questionIndex})" id="nextQuestionBtn" disabled>
                    ‚û°Ô∏è –°–ª–µ–¥—É—é—â–∏–π –≤–æ–ø—Ä–æ—Å
                </button>
            `;
            
            // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –æ—Ç–≤–µ—Ç–∞
            container.querySelectorAll('.option').forEach(option => {
                option.addEventListener('click', function() {
                    // –£–±–∏—Ä–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Å–æ –≤—Å–µ—Ö –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤
                    container.querySelectorAll('.option').forEach(opt => {
                        opt.classList.remove('selected');
                    });
                    
                    // –í—ã–¥–µ–ª—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç
                    this.classList.add('selected');
                    
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ç–≤–µ—Ç
                    quizAnswers[questionIndex] = parseInt(this.dataset.option);
                    
                    // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É
                    document.getElementById('nextQuestionBtn').disabled = false;
                });
            });
        }

        // –°–ª–µ–¥—É—é—â–∏–π –≤–æ–ø—Ä–æ—Å
        function nextQuizQuestion(currentIndex) {
            showQuizQuestion(currentIndex + 1);
        }

        // –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–≤–∏–∑
        async function submitQuiz() {
            try {
                const response = await fetch(`/api/webapp/quizzes/${currentQuiz.id}/submit`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        userId: currentUser.user_id,
                        answers: quizAnswers
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showQuizResult(result);
                } else {
                    showError(result.error);
                }
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∫–≤–∏–∑–∞:', error);
                showError('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∫–≤–∏–∑–∞');
            }
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∫–≤–∏–∑–∞
        function showQuizResult(result) {
            const container = document.getElementById('quizResultContent');
            
            let resultHtml = '';
            if (result.perfectScore) {
                resultHtml = `
                    <div class="success" style="text-align: center; padding: 30px;">
                        <div style="font-size: 64px; margin-bottom: 16px;">üéâ</div>
                        <h3 style="margin-bottom: 12px;">–ò–¥–µ–∞–ª—å–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç!</h3>
                        <p>–í—ã –æ—Ç–≤–µ—Ç–∏–ª–∏ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –Ω–∞ –≤—Å–µ –≤–æ–ø—Ä–æ—Å—ã!</p>
                        <div style="font-size: 24px; font-weight: bold; color: #f6e05e; margin: 16px 0;">
                            +${result.sparksEarned} ‚ú®
                        </div>
                    </div>
                `;
            } else {
                resultHtml = `
                    <div class="info" style="text-align: center; padding: 30px;">
                        <div style="font-size: 48px; margin-bottom: 16px;">üìä</div>
                        <h3 style="margin-bottom: 12px;">–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∫–≤–∏–∑–∞</h3>
                        <p>–ü—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤: ${result.correctAnswers} –∏–∑ ${result.totalQuestions}</p>
                        <div style="font-size: 20px; font-weight: bold; color: #f6e05e; margin: 16px 0;">
                            +${result.sparksEarned} ‚ú®
                        </div>
                        <p>–ü—Ä–æ—Ü–µ–Ω—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤: ${result.scorePercentage}%</p>
                    </div>
                `;
            }
            
            container.innerHTML = resultHtml;
            showScreen('quizResultScreen');
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            currentUser.sparks += result.sparksEarned;
            showUserData();
        }

        // ==================== –ú–ê–†–ê–§–û–ù–´ ====================

        // –ó–∞–≥—Ä—É–∑–∫–∞ –º–∞—Ä–∞—Ñ–æ–Ω–æ–≤
        async function loadMarathons() {
            try {
                const response = await fetch(`/api/webapp/marathons?userId=${currentUser.user_id}`);
                const marathons = await response.json();
                
                const container = document.getElementById('marathonsList');
                container.innerHTML = '';
                
                if (marathons.length === 0) {
                    container.innerHTML = '<div class="info">–ü–æ–∫–∞ –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –º–∞—Ä–∞—Ñ–æ–Ω–æ–≤</div>';
                    return;
                }
                
                marathons.forEach(marathon => {
                    const marathonElement = document.createElement('div');
                    marathonElement.className = 'marathon-card';
                    marathonElement.onclick = () => startMarathon(marathon);
                    
                    let statusBadge = '';
                    if (marathon.completed) {
                        statusBadge = `<span class="badge badge-success">üèÜ –ó–∞–≤–µ—Ä—à–µ–Ω</span>`;
                    } else if (marathon.started_at) {
                        statusBadge = `<span class="badge badge-warning">üìÖ –í –ø—Ä–æ—Ü–µ—Å—Å–µ</span>`;
                    } else {
                        statusBadge = `<span class="badge badge-info">üéØ –ù–∞—á–∞—Ç—å</span>`;
                    }
                    
                    marathonElement.innerHTML = `
                        <div style="display: flex; justify-content: between; align-items: start; margin-bottom: 12px;">
                            <h3 style="flex: 1; margin: 0;">${marathon.title}</h3>
                            ${statusBadge}
                        </div>
                        <p style="color: #718096; margin-bottom: 12px;">${marathon.description}</p>
                        <div style="display: flex; justify-content: space-between; color: #718096; font-size: 14px;">
                            <span>üìÖ ${marathon.duration_days} –¥–Ω–µ–π</span>
                            <span>‚ú® ${marathon.sparks_per_day} –∏—Å–∫—Ä/–¥–µ–Ω—å</span>
                        </div>
                        ${marathon.started_at ? `
                            <div style="margin-top: 12px;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                    <span>–ü—Ä–æ–≥—Ä–µ—Å—Å:</span>
                                    <span>${marathon.progress}%</span>
                                </div>
                                <div class="progress-bar">
                                    <div class="progress-fill" style="width: ${marathon.progress}%"></div>
                                </div>
                                <div style="text-align: center; color: #718096; font-size: 12px; margin-top: 4px;">
                                    –î–µ–Ω—å ${marathon.current_day} –∏–∑ ${marathon.duration_days}
                                </div>
                            </div>
                        ` : ''}
                    `;
                    
                    container.appendChild(marathonElement);
                });
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–∞—Ä–∞—Ñ–æ–Ω–æ–≤:', error);
                showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–∞—Ä–∞—Ñ–æ–Ω–æ–≤');
            }
        }

        // –ù–∞—á–∞—Ç—å –º–∞—Ä–∞—Ñ–æ–Ω
        function startMarathon(marathon) {
            currentMarathon = marathon;
            
            document.getElementById('marathonTitle').textContent = marathon.title;
            document.getElementById('marathonDescription').textContent = marathon.description;
            document.getElementById('currentDay').textContent = marathon.current_day;
            document.getElementById('totalDays').textContent = marathon.duration_days;
            document.getElementById('progressPercent').textContent = marathon.progress;
            document.getElementById('marathonProgress').style.width = `${marathon.progress}%`;
            
            showMarathonDay(marathon.current_day);
            showScreen('marathonScreen');
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å –¥–µ–Ω—å –º–∞—Ä–∞—Ñ–æ–Ω–∞
        function showMarathonDay(day) {
            const task = currentMarathon.tasks.find(t => t.day === day);
            if (!task) return;
            
            const container = document.getElementById('marathonContent');
            
            let submissionSection = '';
            if (task.requires_submission) {
                submissionSection = `
                    <div style="margin-top: 20px;">
                        <button class="btn btn-success" onclick="showMarathonSubmission(${day})">
                            üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ä–∞–±–æ—Ç—É
                        </button>
                    </div>
                `;
            } else {
                submissionSection = `
                    <div style="margin-top: 20px;">
                        <button class="btn btn-success" onclick="completeMarathonDay(${day})">
                            ‚úÖ –ó–∞–≤–µ—Ä—à–∏—Ç—å –¥–µ–Ω—å
                        </button>
                    </div>
                `;
            }
            
            container.innerHTML = `
                <div class="marathon-day ${day < currentMarathon.current_day ? 'completed' : ''}">
                    <h3 style="margin-bottom: 12px;">–î–µ–Ω—å ${day}: ${task.title}</h3>
                    <p style="color: #718096; margin-bottom: 16px;">${task.description}</p>
                    ${day < currentMarathon.current_day ? 
                        '<div class="badge badge-success">‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω–æ</div>' : 
                        submissionSection
                    }
                </div>
            `;
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å —ç–∫—Ä–∞–Ω –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ä–∞–±–æ—Ç—ã –¥–ª—è –º–∞—Ä–∞—Ñ–æ–Ω–∞
        function showMarathonSubmission(day) {
            const task = currentMarathon.tasks.find(t => t.day === day);
            if (!task) return;
            
            document.getElementById('marathonSubmissionTitle').textContent = `–î–µ–Ω—å ${day}: ${task.title}`;
            document.getElementById('marathonSubmissionDescription').textContent = task.description;
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ —Å–µ–∫—Ü–∏–∏ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏
            if (task.submission_type === 'text') {
                document.getElementById('textSubmissionSection').style.display = 'block';
                document.getElementById('imageSubmissionSection').style.display = 'none';
            } else if (task.submission_type === 'image') {
                document.getElementById('textSubmissionSection').style.display = 'none';
                document.getElementById('imageSubmissionSection').style.display = 'block';
            }
            
            showScreen('marathonSubmissionScreen');
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–ª—è –º–∞—Ä–∞—Ñ–æ–Ω–∞
        async function handleMarathonImageUpload(file) {
            if (!file) return;
            
            if (!file.type.startsWith('image/')) {
                showError('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ');
                return;
            }
            
            if (file.size > 10 * 1024 * 1024) {
                showError('–†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞ –Ω–µ –¥–æ–ª–∂–µ–Ω –ø—Ä–µ–≤—ã—à–∞—Ç—å 10MB');
                return;
            }
            
            try {
                const base64 = await fileToBase64(file);
                currentMarathonImage = base64;
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–≤—å—é
                const preview = document.getElementById('marathonPreviewImage');
                preview.src = base64;
                document.getElementById('marathonImagePreview').style.display = 'block';
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è:', error);
                showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è');
            }
        }

        // –û—á–∏—Å—Ç–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –º–∞—Ä–∞—Ñ–æ–Ω–∞
        function clearMarathonImage() {
            currentMarathonImage = null;
            document.getElementById('marathonImagePreview').style.display = 'none';
            document.getElementById('marathonImageInput').value = '';
        }

        // –û—Ç–ø—Ä–∞–≤–∫–∞ –¥–Ω—è –º–∞—Ä–∞—Ñ–æ–Ω–∞
        async function submitMarathonDay() {
            const day = currentMarathon.current_day;
            const task = currentMarathon.tasks.find(t => t.day === day);
            
            if (task.requires_submission) {
                if (task.submission_type === 'text' && !document.getElementById('marathonSubmissionText').value.trim()) {
                    showError('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Ä–∞–±–æ—Ç—ã');
                    return;
                }
                
                if (task.submission_type === 'image' && !currentMarathonImage) {
                    showError('–ó–∞–≥—Ä—É–∑–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ä–∞–±–æ—Ç—ã');
                    return;
                }
            }
            
            try {
                const submissionData = {
                    userId: currentUser.user_id,
                    day: day,
                    submission_text: task.submission_type === 'text' ? document.getElementById('marathonSubmissionText').value.trim() : '',
                    submission_image: task.submission_type === 'image' ? currentMarathonImage : null
                };
                
                const response = await fetch(`/api/webapp/marathons/${currentMarathon.id}/submit-day`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(submissionData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showMessage(result.message, 'success');
                    currentUser.sparks += currentMarathon.sparks_per_day;
                    showUserData();
                    
                    if (result.completed) {
                        showScreen('marathonsScreen');
                    } else {
                        showScreen('marathonScreen');
                        loadMarathons(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –º–∞—Ä–∞—Ñ–æ–Ω–æ–≤
                    }
                } else {
                    showError(result.error);
                }
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –¥–Ω—è –º–∞—Ä–∞—Ñ–æ–Ω–∞:', error);
                showError('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –¥–Ω—è –º–∞—Ä–∞—Ñ–æ–Ω–∞');
            }
        }

        // –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –¥–Ω—è –º–∞—Ä–∞—Ñ–æ–Ω–∞ (–±–µ–∑ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ä–∞–±–æ—Ç—ã)
        async function completeMarathonDay(day) {
            try {
                const response = await fetch(`/api/webapp/marathons/${currentMarathon.id}/submit-day`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        userId: currentUser.user_id,
                        day: day
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showMessage(result.message, 'success');
                    currentUser.sparks += currentMarathon.sparks_per_day;
                    showUserData();
                    showScreen('marathonScreen');
                    loadMarathons(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –º–∞—Ä–∞—Ñ–æ–Ω–æ–≤
                } else {
                    showError(result.error);
                }
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –¥–Ω—è:', error);
                showError('–û—à–∏–±–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –¥–Ω—è');
            }
        }

        // ==================== –ò–ù–¢–ï–†–ê–ö–¢–ò–í–´ ====================

        // –ó–∞–≥—Ä—É–∑–∫–∞ –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–æ–≤
        async function loadInteractives() {
            try {
                const response = await fetch(`/api/webapp/interactives?userId=${currentUser.user_id}`);
                const interactives = await response.json();
                
                const container = document.getElementById('interactivesList');
                container.innerHTML = '';
                
                if (interactives.length === 0) {
                    container.innerHTML = '<div class="info">–ü–æ–∫–∞ –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–æ–≤</div>';
                    return;
                }
                
                // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–æ–≤
                document.querySelectorAll('.interactive-tab').forEach(tab => {
                    tab.addEventListener('click', function() {
                        document.querySelectorAll('.interactive-tab').forEach(t => t.classList.remove('active'));
                        this.classList.add('active');
                        filterInteractives(interactives, this.dataset.category);
                    });
                });
                
                displayInteractives(interactives, 'all');
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–æ–≤:', error);
                showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–æ–≤');
            }
        }

        // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–æ–≤
        function filterInteractives(interactives, category) {
            const filtered = category === 'all' ? 
                interactives : 
                interactives.filter(i => i.category === category);
            
            displayInteractives(filtered, category);
        }

        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–æ–≤
        function displayInteractives(interactives, category) {
            const container = document.getElementById('interactivesList');
            container.innerHTML = '';
            
            if (interactives.length === 0) {
                container.innerHTML = '<div class="info">–ù–µ—Ç –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–æ–≤ –≤ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</div>';
                return;
            }
            
            interactives.forEach(interactive => {
                const interactiveElement = document.createElement('div');
                interactiveElement.className = 'interactive-card';
                interactiveElement.onclick = () => startInteractive(interactive);
                
                let statusBadge = '';
                if (interactive.completed) {
                    statusBadge = `<span class="badge badge-success">‚úÖ –ü—Ä–æ–π–¥–µ–Ω–æ</span>`;
                    if (interactive.can_retake) {
                        statusBadge += `<span class="badge badge-warning" style="margin-left: 8px;">üîÑ –ü–æ–≤—Ç–æ—Ä–Ω–æ</span>`;
                    }
                } else {
                    statusBadge = `<span class="badge badge-info">üéÆ –ò–≥—Ä–∞—Ç—å</span>`;
                }
                
                const categoryClass = `category-${interactive.category}`;
                const categoryNames = {
                    'history': 'üèõÔ∏è –ò—Å—Ç–æ—Ä–∏—è',
                    'style': 'üëó –°—Ç–∏–ª—å',
                    'art': 'üé® –ò—Å–∫—É—Å—Å—Ç–≤–æ',
                    'craft': 'üßµ –†–µ–º–µ—Å–ª–æ'
                };
                
                interactiveElement.innerHTML = `
                    <div style="display: flex; justify-content: between; align-items: start; margin-bottom: 12px;">
                        <h3 style="flex: 1; margin: 0;">${interactive.title}</h3>
                        ${statusBadge}
                    </div>
                    <p class="interactive-description">${interactive.description}</p>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 12px;">
                        <span class="category-badge ${categoryClass}">
                            ${categoryNames[interactive.category] || interactive.category}
                        </span>
                        <span class="spark-badge">+${interactive.sparks_reward} ‚ú®</span>
                    </div>
                `;
                
                container.appendChild(interactiveElement);
            });
        }

        // –ù–∞—á–∞—Ç—å –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤
        function startInteractive(interactive) {
            if (interactive.completed && !interactive.can_retake) {
                showError('–≠—Ç–æ—Ç –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤ —É–∂–µ –ø—Ä–æ–π–¥–µ–Ω –∏ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è');
                return;
            }
            
            currentInteractive = interactive;
            
            document.getElementById('interactiveTitle').textContent = interactive.title;
            document.getElementById('interactiveDescription').textContent = interactive.description;
            
            const container = document.getElementById('interactiveContent');
            
            let contentHtml = '';
            
            switch(interactive.type) {
                case 'guess_era':
                    contentHtml = createGuessEraInteractive(interactive);
                    break;
                case 'style_match':
                    contentHtml = createStyleMatchInteractive(interactive);
                    break;
                case 'drawing_challenge':
                    contentHtml = createDrawingChallengeInteractive(interactive);
                    break;
                default:
                    contentHtml = createDefaultInteractive(interactive);
            }
            
            container.innerHTML = contentHtml;
            showScreen('interactiveScreen');
        }

        // –°–æ–∑–¥–∞–Ω–∏–µ –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–∞ "–£–≥–∞–¥–∞–π —ç–ø–æ—Ö—É"
        function createGuessEraInteractive(interactive) {
            let imageHtml = '';
            if (interactive.image_url) {
                imageHtml = `<img src="${interactive.image_url}" class="interactive-image" alt="–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —ç–ø–æ—Ö–∏">`;
            }
            
            let optionsHtml = '';
            interactive.options.forEach((option, index) => {
                optionsHtml += `
                    <div class="option" data-option="${index}">
                        ${option}
                    </div>
                `;
            });
            
            return `
                ${imageHtml}
                <h3 style="text-align: center; margin: 20px 0;">${interactive.question}</h3>
                <div class="options">
                    ${optionsHtml}
                </div>
                <button class="btn" onclick="submitInteractiveAnswer()" id="submitInteractiveBtn" disabled style="margin-top: 20px;">
                    ‚úÖ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ—Ç–≤–µ—Ç
                </button>
            `;
        }

        // –û—Ç–ø—Ä–∞–≤–∫–∞ –æ—Ç–≤–µ—Ç–∞ –Ω–∞ –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤
        async function submitInteractiveAnswer() {
            const selectedOption = document.querySelector('#interactiveContent .option.selected');
            if (!selectedOption) {
                showError('–í—ã–±–µ—Ä–∏—Ç–µ –≤–∞—Ä–∏–∞–Ω—Ç –æ—Ç–≤–µ—Ç–∞');
                return;
            }
            
            const answer = parseInt(selectedOption.dataset.option);
            
            try {
                const response = await fetch(`/api/webapp/interactives/${currentInteractive.id}/submit`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        userId: currentUser.user_id,
                        answer: answer
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showInteractiveResult(result);
                } else {
                    showError(result.error);
                }
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –æ—Ç–≤–µ—Ç–∞:', error);
                showError('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –æ—Ç–≤–µ—Ç–∞');
            }
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–∞
        function showInteractiveResult(result) {
            const container = document.getElementById('interactiveResultContent');
            
            let resultHtml = '';
            if (result.correct) {
                resultHtml = `
                    <div class="success" style="text-align: center; padding: 40px 20px;">
                        <div class="result-icon">üéâ</div>
                        <h3 style="margin-bottom: 12px;">–ü—Ä–∞–≤–∏–ª—å–Ω–æ!</h3>
                        <p>–û—Ç–ª–∏—á–Ω–∞—è —Ä–∞–±–æ—Ç–∞! –í—ã –ø—Ä–∞–≤–∏–ª—å–Ω–æ –æ—Ç–≤–µ—Ç–∏–ª–∏ –Ω–∞ –≤–æ–ø—Ä–æ—Å.</p>
                        <div style="font-size: 24px; font-weight: bold; color: #f6e05e; margin: 20px 0;">
                            +${result.sparksEarned} ‚ú®
                        </div>
                    </div>
                `;
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                currentUser.sparks += result.sparksEarned;
                showUserData();
            } else {
                resultHtml = `
                    <div class="error" style="text-align: center; padding: 40px 20px;">
                        <div class="result-icon">üòî</div>
                        <h3 style="margin-bottom: 12px;">–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ</h3>
                        <p>–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑! –í—ã –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —Å–ø—Ä–∞–≤–∏—Ç–µ—Å—å.</p>
                        <div style="margin-top: 20px;">
                            <button class="btn" onclick="showScreen('interactiveScreen')">
                                üîÑ –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞
                            </button>
                        </div>
                    </div>
                `;
            }
            
            container.innerHTML = resultHtml;
            showScreen('interactiveResultScreen');
        }

        // ==================== –ú–ê–ì–ê–ó–ò–ù ====================

        // –ü–æ–∫–∞–∑–∞—Ç—å –≤–∫–ª–∞–¥–∫—É –º–∞–≥–∞–∑–∏–Ω–∞
        function showShopTab(tab) {
            document.querySelectorAll('.shop-tab').forEach(t => t.classList.remove('active'));
            document.querySelector(`.shop-tab:nth-child(${tab === 'items' ? 1 : 2})`).classList.add('active');
            
            document.getElementById('shopItemsTab').style.display = tab === 'items' ? 'block' : 'none';
            document.getElementById('shopPurchasesTab').style.display = tab === 'purchases' ? 'block' : 'none';
            
            if (tab === 'purchases') {
                loadPurchases();
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤
        async function loadShopItems() {
            try {
                const response = await fetch('/api/webapp/shop/items');
                const items = await response.json();
                
                const container = document.getElementById('shopItemsList');
                container.innerHTML = '';
                
                if (items.length === 0) {
                    container.innerHTML = '<div class="info">–ü–æ–∫–∞ –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤</div>';
                    return;
                }
                
                items.forEach(item => {
                    const itemElement = document.createElement('div');
                    itemElement.className = 'shop-item';
                    itemElement.onclick = () => viewShopItem(item);
                    
                    const typeIcons = {
                        'video': 'üé•',
                        'image': 'üñºÔ∏è',
                        'pdf': 'üìö',
                        'text': 'üìù',
                        'audio': 'üéß'
                    };
                    
                    itemElement.innerHTML = `
                        <div style="display: flex; justify-content: between; align-items: start; margin-bottom: 12px;">
                            <h3 style="flex: 1; margin: 0;">${typeIcons[item.type]} ${item.title}</h3>
                            <div class="spark-badge">${item.price} ‚ú®</div>
                        </div>
                        <p style="color: #718096; margin-bottom: 12px;">${item.description}</p>
                        <div style="color: #718096; font-size: 14px;">
                            –¢–∏–ø: ${getShopItemTypeName(item.type)}
                        </div>
                    `;
                    
                    container.appendChild(itemElement);
                });
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–æ–≤–∞—Ä–æ–≤:', error);
                showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–æ–≤–∞—Ä–æ–≤');
            }
        }

        // –ü–æ–ª—É—á–µ–Ω–∏–µ –Ω–∞–∑–≤–∞–Ω–∏—è —Ç–∏–ø–∞ —Ç–æ–≤–∞—Ä–∞
        function getShopItemTypeName(type) {
            const names = {
                'video': '–í–∏–¥–µ–æ—É—Ä–æ–∫',
                'image': '–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ',
                'pdf': 'PDF-–¥–æ–∫—É–º–µ–Ω—Ç',
                'text': '–¢–µ–∫—Å—Ç–æ–≤—ã–π –º–∞—Ç–µ—Ä–∏–∞–ª',
                'audio': '–ê—É–¥–∏–æ–∑–∞–ø–∏—Å—å'
            };
            return names[type] || type;
        }

        // –ü—Ä–æ—Å–º–æ—Ç—Ä —Ç–æ–≤–∞—Ä–∞
        function viewShopItem(item) {
            currentShopItem = item;
            
            document.getElementById('shopItemTitle').textContent = item.title;
            document.getElementById('shopItemDescription').textContent = item.description;
            document.getElementById('shopItemPrice').textContent = item.price;
            
            const container = document.getElementById('shopItemContent');
            let contentHtml = '';
            
            if (item.preview_url && item.type !== 'text') {
                if (item.type === 'video') {
                    contentHtml = `
                        <div class="purchase-media-container">
                            <div class="purchase-media-title">
                                <span>üé• –ü—Ä–µ–≤—å—é –≤–∏–¥–µ–æ</span>
                            </div>
                            <video src="${item.preview_url}" controls class="purchase-video"></video>
                        </div>
                    `;
                } else if (item.type === 'image') {
                    contentHtml = `
                        <div class="purchase-media-container">
                            <div class="purchase-media-title">
                                <span>üñºÔ∏è –ü—Ä–µ–≤—å—é –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è</span>
                            </div>
                            <img src="${item.preview_url}" class="media-preview">
                        </div>
                    `;
                }
            }
            
            if (item.content_text) {
                contentHtml += `
                    <div style="margin-top: 20px;">
                        <h4 style="margin-bottom: 12px;">üìã –û–ø–∏—Å–∞–Ω–∏–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ:</h4>
                        <div class="content-preview">
                            ${item.content_text}
                        </div>
                    </div>
                `;
            }
            
            container.innerHTML = contentHtml;
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Ö–≤–∞—Ç–∞–µ—Ç –ª–∏ –∏—Å–∫—Ä
            const purchaseBtn = document.getElementById('purchaseBtn');
            if (currentUser.sparks < item.price) {
                purchaseBtn.disabled = true;
                purchaseBtn.innerHTML = '‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∏—Å–∫—Ä';
            } else {
                purchaseBtn.disabled = false;
                purchaseBtn.innerHTML = 'üõí –ö—É–ø–∏—Ç—å —Å–µ–π—á–∞—Å';
            }
            
            showScreen('shopItemScreen');
        }

        // –ü–æ–∫—É–ø–∫–∞ —Ç–æ–≤–∞—Ä–∞
        async function purchaseItem() {
            if (!currentShopItem) return;
            
            if (currentUser.sparks < currentShopItem.price) {
                showError('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∏—Å–∫—Ä –¥–ª—è –ø–æ–∫—É–ø–∫–∏');
                return;
            }
            
            try {
                const response = await fetch('/api/webapp/shop/purchase', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        userId: currentUser.user_id,
                        itemId: currentShopItem.id
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showMessage(result.message, 'success');
                    currentUser.sparks -= currentShopItem.price;
                    showUserData();
                    showScreen('shopScreen');
                } else {
                    showError(result.error);
                }
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø–æ–∫—É–ø–∫–∏:', error);
                showError('–û—à–∏–±–∫–∞ –ø–æ–∫—É–ø–∫–∏ —Ç–æ–≤–∞—Ä–∞');
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ–∫—É–ø–æ–∫
        async function loadPurchases() {
            try {
                const response = await fetch(`/api/webapp/users/${currentUser.user_id}/purchases`);
                const data = await response.json();
                
                const container = document.getElementById('purchasesList');
                container.innerHTML = '';
                
                if (data.purchases.length === 0) {
                    container.innerHTML = '<div class="info">–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –ø–æ–∫—É–ø–æ–∫</div>';
                    return;
                }
                
                data.purchases.forEach(purchase => {
                    const purchaseElement = document.createElement('div');
                    purchaseElement.className = 'purchase-item';
                    purchaseElement.onclick = () => viewPurchase(purchase);
                    
                    const typeIcons = {
                        'video': 'üé•',
                        'image': 'üñºÔ∏è',
                        'pdf': 'üìö',
                        'text': 'üìù',
                        'audio': 'üéß'
                    };
                    
                    purchaseElement.innerHTML = `
                        <div style="display: flex; justify-content: between; align-items: start; margin-bottom: 12px;">
                            <h3 style="flex: 1; margin: 0;">${typeIcons[purchase.type]} ${purchase.title}</h3>
                            <div class="badge badge-success">‚úÖ –ö—É–ø–ª–µ–Ω–æ</div>
                        </div>
                        <p style="color: #718096; margin-bottom: 8px;">${purchase.description}</p>
                        <div style="color: #718096; font-size: 14px;">
                            –ö—É–ø–ª–µ–Ω–æ: ${new Date(purchase.purchased_at).toLocaleDateString('ru-RU')}
                        </div>
                    `;
                    
                    container.appendChild(purchaseElement);
                });
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–∫—É–ø–æ–∫:', error);
                showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–∫—É–ø–æ–∫');
            }
        }

        // –ü—Ä–æ—Å–º–æ—Ç—Ä –ø–æ–∫—É–ø–∫–∏
        function viewPurchase(purchase) {
            currentPurchase = purchase;
            
            document.getElementById('purchaseTitle').textContent = purchase.title;
            
            const container = document.getElementById('purchaseContent');
            let contentHtml = '';
            
            if (purchase.file_url) {
                if (purchase.type === 'video') {
                    contentHtml = `
                        <div class="purchase-media-container">
                            <div class="purchase-media-title">
                                <span>üé• –í–∏–¥–µ–æ—É—Ä–æ–∫</span>
                            </div>
                            <video src="${purchase.file_url}" controls class="purchase-video"></video>
                        </div>
                    `;
                } else if (purchase.type === 'image') {
                    contentHtml = `
                        <div class="purchase-media-container">
                            <div class="purchase-media-title">
                                <span>üñºÔ∏è –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</span>
                            </div>
                            <img src="${purchase.file_url}" class="media-preview">
                        </div>
                    `;
                } else if (purchase.type === 'audio') {
                    contentHtml = `
                        <div class="purchase-media-container">
                            <div class="purchase-media-title">
                                <span>üéß –ê—É–¥–∏–æ–∑–∞–ø–∏—Å—å</span>
                            </div>
                            <audio src="${purchase.file_url}" controls class="purchase-audio"></audio>
                        </div>
                    `;
                } else if (purchase.type === 'pdf') {
                    contentHtml = `
                        <div class="purchase-media-container">
                            <div class="purchase-media-title">
                                <span>üìö PDF-–¥–æ–∫—É–º–µ–Ω—Ç</span>
                            </div>
                            <div class="info">
                                <p>–î–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ PDF-–¥–æ–∫—É–º–µ–Ω—Ç–∞ –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É "–°–∫–∞—á–∞—Ç—å"</p>
                            </div>
                        </div>
                    `;
                }
            }
            
            if (purchase.content_text) {
                contentHtml += `
                    <div style="margin-top: 20px;">
                        <h4 style="margin-bottom: 12px;">üìã –û–ø–∏—Å–∞–Ω–∏–µ:</h4>
                        <div class="content-preview">
                            ${purchase.content_text}
                        </div>
                    </div>
                `;
            }
            
            container.innerHTML = contentHtml;
            showScreen('purchaseScreen');
        }

        // –°–∫–∞—á–∞—Ç—å –ø–æ–∫—É–ø–∫—É
        function downloadPurchase() {
            if (!currentPurchase || !currentPurchase.file_url) {
                showError('–§–∞–π–ª –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω');
                return;
            }
            
            const link = document.createElement('a');
            link.href = currentPurchase.file_url;
            link.download = currentPurchase.title;
            link.click();
        }

        // –ü—Ä–æ—Å–º–æ—Ç—Ä –º–µ–¥–∏–∞ –ø–æ–∫—É–ø–∫–∏
        function viewPurchaseMedia() {
            if (!currentPurchase || !currentPurchase.file_url) {
                showError('–ú–µ–¥–∏–∞—Ñ–∞–π–ª –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω');
                return;
            }
            
            const modal = document.getElementById('mediaModal');
            const modalImage = document.getElementById('modalImage');
            const modalVideo = document.getElementById('modalVideo');
            
            modalImage.style.display = 'none';
            modalVideo.style.display = 'none';
            
            if (currentPurchase.type === 'video') {
                modalVideo.src = currentPurchase.file_url;
                modalVideo.style.display = 'block';
            } else if (currentPurchase.type === 'image') {
                modalImage.src = currentPurchase.file_url;
                modalImage.style.display = 'block';
            } else {
                showError('–ü—Ä–æ—Å–º–æ—Ç—Ä —ç—Ç–æ–≥–æ —Ç–∏–ø–∞ —Ñ–∞–π–ª–∞ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è');
                return;
            }
            
            modal.style.display = 'flex';
        }

        // –ó–∞–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –º–µ–¥–∏–∞
        function closeMediaModal() {
            document.getElementById('mediaModal').style.display = 'none';
            const modalVideo = document.getElementById('modalVideo');
            modalVideo.pause();
            modalVideo.currentTime = 0;
        }

        // –°–∫–∞—á–∞—Ç—å –º–µ–¥–∏–∞
        function downloadMedia() {
            if (!currentPurchase || !currentPurchase.file_url) {
                showError('–§–∞–π–ª –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω');
                return;
            }
            
            downloadPurchase();
        }

        // ==================== –†–ê–ë–û–¢–´ ====================

        // –ü–æ–∫–∞–∑–∞—Ç—å –≤–∫–ª–∞–¥–∫—É —Ä–∞–±–æ—Ç
        function showWorksTab(filter) {
            document.querySelectorAll('.works-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelector(`.works-tab[onclick="showWorksTab('${filter}')"]`).classList.add('active');
            loadWorks(filter);
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Ä–∞–±–æ—Ç
        async function loadWorks(filter = 'all') {
            try {
                const response = await fetch(`/api/webapp/users/${currentUser.user_id}/works`);
                const data = await response.json();
                
                const container = document.getElementById('worksList');
                container.innerHTML = '';
                
                let works = data.works;
                
                // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è —Ä–∞–±–æ—Ç
                if (filter !== 'all') {
                    works = works.filter(work => work.status === filter);
                }
                
                if (works.length === 0) {
                    let message = '';
                    switch(filter) {
                        case 'pending': message = '–ù–µ—Ç —Ä–∞–±–æ—Ç –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–µ'; break;
                        case 'approved': message = '–ù–µ—Ç –æ–¥–æ–±—Ä–µ–Ω–Ω—ã—Ö —Ä–∞–±–æ—Ç'; break;
                        case 'rejected': message = '–ù–µ—Ç –æ—Ç–∫–ª–æ–Ω–µ–Ω–Ω—ã—Ö —Ä–∞–±–æ—Ç'; break;
                        default: message = '–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç —Ä–∞–±–æ—Ç';
                    }
                    container.innerHTML = `<div class="info">${message}</div>`;
                    return;
                }
                
                works.forEach(work => {
                    const workElement = document.createElement('div');
                    workElement.className = `work-card work-${work.status}`;
                    
                    const statusBadges = {
                        'pending': '<span class="status-badge status-pending">‚è≥ –ù–∞ –ø—Ä–æ–≤–µ—Ä–∫–µ</span>',
                        'approved': '<span class="status-badge status-approved">‚úÖ –û–¥–æ–±—Ä–µ–Ω–æ</span>',
                        'rejected': '<span class="status-badge status-rejected">‚ùå –û—Ç–∫–ª–æ–Ω–µ–Ω–æ</span>'
                    };
                    
                    workElement.innerHTML = `
                        <div style="display: flex; justify-content: between; align-items: start; margin-bottom: 12px;">
                            <h3 style="flex: 1; margin: 0;">${work.title}</h3>
                            ${statusBadges[work.status]}
                        </div>
                        ${work.description ? `<p style="color: #718096; margin-bottom: 12px;">${work.description}</p>` : ''}
                        <img src="${work.image_url}" class="work-image">
                        <div style="color: #718096; font-size: 14px; margin-top: 8px;">
                            –ó–∞–≥—Ä—É–∂–µ–Ω–æ: ${new Date(work.created_at).toLocaleDateString('ru-RU')}
                            ${work.admin_comment ? `<div style="margin-top: 8px; color: #e53e3e;"><strong>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–∞:</strong> ${work.admin_comment}</div>` : ''}
                        </div>
                    `;
                    
                    container.appendChild(workElement);
                });
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–∞–±–æ—Ç:', error);
                showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–∞–±–æ—Ç');
            }
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ä–∞–±–æ—Ç—ã
        async function handleWorkImageUpload(file) {
            if (!file) return;
            
            if (!file.type.startsWith('image/')) {
                showError('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ');
                return;
            }
            
            if (file.size > 10 * 1024 * 1024) {
                showError('–†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞ –Ω–µ –¥–æ–ª–∂–µ–Ω –ø—Ä–µ–≤—ã—à–∞—Ç—å 10MB');
                return;
            }
            
            try {
                const base64 = await fileToBase64(file);
                currentWorkImage = base64;
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–≤—å—é
                const preview = document.getElementById('workPreviewImage');
                preview.src = base64;
                document.getElementById('workImagePreview').style.display = 'block';
                
                // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É –æ—Ç–ø—Ä–∞–≤–∫–∏
                document.getElementById('submitWorkBtn').disabled = false;
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è:', error);
                showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è');
            }
        }

        // –û—á–∏—Å—Ç–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ä–∞–±–æ—Ç—ã
        function clearWorkImage() {
            currentWorkImage = null;
            document.getElementById('workImagePreview').style.display = 'none';
            document.getElementById('workImageInput').value = '';
            document.getElementById('submitWorkBtn').disabled = true;
        }

        // –û—Ç–ø—Ä–∞–≤–∫–∞ —Ä–∞–±–æ—Ç—ã
        async function submitWork() {
            const title = document.getElementById('workTitle').value.trim();
            const description = document.getElementById('workDescription').value.trim();
            const type = document.getElementById('workType').value;
            
            if (!title) {
                showError('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ä–∞–±–æ—Ç—ã');
                return;
            }
            
            if (!currentWorkImage) {
                showError('–ó–∞–≥—Ä—É–∑–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ä–∞–±–æ—Ç—ã');
                return;
            }
            
            try {
                const response = await fetch('/api/webapp/upload-work', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        userId: currentUser.user_id,
                        title: title,
                        description: description,
                        imageUrl: currentWorkImage,
                        type: type
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showMessage(result.message, 'success');
                    currentUser.sparks += 5; // –ë–æ–Ω—É—Å –∑–∞ –∑–∞–≥—Ä—É–∑–∫—É —Ä–∞–±–æ—Ç—ã
                    showUserData();
                    showScreen('worksScreen');
                } else {
                    showError(result.error);
                }
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ä–∞–±–æ—Ç—ã:', error);
                showError('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ä–∞–±–æ—Ç—ã');
            }
        }

        // ==================== –ü–û–°–¢–´ ====================

        // –ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ—Å—Ç–æ–≤
        async function loadPosts() {
            try {
                const response = await fetch('/api/webapp/channel-posts');
                const data = await response.json();
                
                const container = document.getElementById('postsList');
                container.innerHTML = '';
                
                if (data.posts.length === 0) {
                    container.innerHTML = '<div class="info">–ü–æ–∫–∞ –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤</div>';
                    return;
                }
                
                data.posts.forEach(post => {
                    const postElement = document.createElement('div');
                    postElement.className = 'post-card';
                    postElement.onclick = () => viewPost(post);
                    
                    let mediaInfo = '';
                    if (post.media_type === 'image' && post.image_url) {
                        mediaInfo = '<span style="color: #667eea;">üñºÔ∏è –° –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º</span>';
                    } else if (post.media_type === 'video' && post.video_url) {
                        mediaInfo = '<span style="color: #667eea;">üé• –° –≤–∏–¥–µ–æ</span>';
                    }
                    
                    postElement.innerHTML = `
                        <h3 style="margin-bottom: 12px;">${post.title}</h3>
                        <p style="color: #718096; margin-bottom: 12px; line-height: 1.4;">
                            ${post.content.substring(0, 150)}${post.content.length > 150 ? '...' : ''}
                        </p>
                        <div style="display: flex; justify-content: space-between; color: #718096; font-size: 14px;">
                            <span>üìÖ ${new Date(post.created_at).toLocaleDateString('ru-RU')}</span>
                            ${mediaInfo}
                            ${post.reviews_count > 0 ? `<span>‚≠ê ${post.average_rating.toFixed(1)} (${post.reviews_count})</span>` : ''}
                        </div>
                    `;
                    
                    container.appendChild(postElement);
                });
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ—Å—Ç–æ–≤:', error);
                showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ—Å—Ç–æ–≤');
            }
        }

        // –ü—Ä–æ—Å–º–æ—Ç—Ä –ø–æ—Å—Ç–∞
        function viewPost(post) {
            currentPost = post;
            selectedRating = 0;
            
            document.getElementById('postTitle').textContent = post.title;
            
            const mediaContainer = document.getElementById('postMedia');
            const contentContainer = document.getElementById('postContent');
            
            // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –∫–æ–Ω—Ç–µ–Ω—Ç
            mediaContainer.innerHTML = '';
            contentContainer.innerHTML = '';
            
            // –î–æ–±–∞–≤–ª—è–µ–º –º–µ–¥–∏–∞ –µ—Å–ª–∏ –µ—Å—Ç—å
            if (post.media_type === 'image' && post.image_url) {
                mediaContainer.innerHTML = `<img src="${post.image_url}" class="media-preview">`;
            } else if (post.media_type === 'video' && post.video_url) {
                mediaContainer.innerHTML = `<video src="${post.video_url}" controls class="purchase-video"></video>`;
            }
            
            // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ
            contentContainer.innerHTML = post.content;
            
            // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è —Ä–µ–π—Ç–∏–Ω–≥–∞
            document.querySelectorAll('.rating-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    selectedRating = parseInt(this.dataset.rating);
                    
                    // –£–±–∏—Ä–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Å–æ –≤—Å–µ—Ö –∫–Ω–æ–ø–æ–∫
                    document.querySelectorAll('.rating-btn').forEach(b => {
                        b.style.background = '';
                        b.style.color = '';
                    });
                    
                    // –í—ã–¥–µ–ª—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é –∫–Ω–æ–ø–∫—É
                    this.style.background = '#667eea';
                    this.style.color = 'white';
                });
            });
            
            showScreen('postScreen');
        }

        // –û—Ç–ø—Ä–∞–≤–∫–∞ –æ—Ç–∑—ã–≤–∞ –Ω–∞ –ø–æ—Å—Ç
        async function submitPostReview() {
            const reviewText = document.getElementById('postReview').value.trim();
            
            if (!reviewText) {
                showError('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –æ—Ç–∑—ã–≤–∞');
                return;
            }
            
            if (selectedRating === 0) {
                showError('–ü–æ—Å—Ç–∞–≤—å—Ç–µ –æ—Ü–µ–Ω–∫—É');
                return;
            }
            
            try {
                const response = await fetch(`/api/webapp/posts/${currentPost.post_id}/review`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        userId: currentUser.user_id,
                        reviewText: reviewText,
                        rating: selectedRating
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showMessage(result.message, 'success');
                    currentUser.sparks += 3; // –ë–æ–Ω—É—Å –∑–∞ –æ—Ç–∑—ã–≤
                    showUserData();
                    showScreen('postsScreen');
                } else {
                    showError(result.error);
                }
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –æ—Ç–∑—ã–≤–∞:', error);
                showError('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –æ—Ç–∑—ã–≤–∞');
            }
        }

        // ==================== –ê–ö–¢–ò–í–ù–û–°–¢–ò ====================

        // –ó–∞–≥—Ä—É–∑–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–µ–π
        async function loadActivities() {
            try {
                const response = await fetch(`/api/webapp/users/${currentUser.user_id}/activities`);
                const data = await response.json();
                
                const container = document.getElementById('activitiesList');
                container.innerHTML = '';
                
                if (data.activities.length === 0) {
                    container.innerHTML = '<div class="info">–ü–æ–∫–∞ –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–µ–π</div>';
                    return;
                }
                
                data.activities.forEach(activity => {
                    const activityElement = document.createElement('div');
                    activityElement.className = 'quiz-card';
                    
                    const activityIcons = {
                        'registration': 'üéâ',
                        'quiz': 'üéØ',
                        'marathon': 'üèÉ‚Äç‚ôÇÔ∏è',
                        'work_upload': 'üñºÔ∏è',
                        'post_review': 'üìù',
                        'compliment': 'üíù',
                        'interactive': 'üéÆ',
                        'role_change': 'üîÑ',
                        'marathon_day': 'üìÖ',
                        'marathon_completion': 'üèÜ'
                    };
                    
                    activityElement.innerHTML = `
                        <div style="display: flex; justify-content: between; align-items: start; margin-bottom: 8px;">
                            <div style="flex: 1;">
                                <div style="font-weight: 600; margin-bottom: 4px;">
                                    ${activityIcons[activity.activity_type] || 'üìä'} ${activity.description}
                                </div>
                                <div style="color: #718096; font-size: 14px;">
                                    ${new Date(activity.created_at).toLocaleString('ru-RU')}
                                </div>
                            </div>
                            <div class="spark-badge" style="font-size: 14px;">
                                +${activity.sparks_earned} ‚ú®
                            </div>
                        </div>
                    `;
                    
                    container.appendChild(activityElement);
                });
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–µ–π:', error);
                showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–µ–π');
            }
        }

        // ==================== –ü–†–ò–ì–õ–ê–®–ï–ù–ò–Ø ====================

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π —Å—Å—ã–ª–∫–∏
        function loadReferralLink() {
            const baseUrl = window.location.origin;
            const referralLink = `${baseUrl}?startapp=ref_${currentUser.user_id}`;
            
            document.getElementById('referralLink').textContent = referralLink;
        }

        // –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π —Å—Å—ã–ª–∫–∏
        async function copyReferralLink() {
            const referralLink = document.getElementById('referralLink').textContent;
            
            try {
                await navigator.clipboard.writeText(referralLink);
                showMessage('–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!', 'success');
            } catch (error) {
                // Fallback –¥–ª—è —Å—Ç–∞—Ä—ã—Ö –±—Ä–∞—É–∑–µ—Ä–æ–≤
                const textArea = document.createElement('textarea');
                textArea.value = referralLink;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                showMessage('–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!', 'success');
            }
        }

        // ==================== –ß–ï–õ–õ–ï–ù–î–ñ –ö–û–ú–ü–õ–ò–ú–ï–ù–¢–û–í ====================

        // –û—Ç–ø—Ä–∞–≤–∫–∞ –∫–æ–º–ø–ª–∏–º–µ–Ω—Ç–∞
        async function submitCompliment() {
            const complimentText = document.getElementById('complimentText').value.trim();
            
            if (!complimentText) {
                showError('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –∫–æ–º–ø–ª–∏–º–µ–Ω—Ç–∞');
                return;
            }
            
            if (complimentText.length < 10) {
                showError('–ö–æ–º–ø–ª–∏–º–µ–Ω—Ç –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ö–æ—Ç—è –±—ã 10 —Å–∏–º–≤–æ–ª–æ–≤');
                return;
            }
            
            try {
                const response = await fetch('/api/webapp/compliment-challenge', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        userId: currentUser.user_id,
                        compliment: complimentText
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showMessage(result.message, 'success');
                    currentUser.sparks += 0.5;
                    showUserData();
                    document.getElementById('complimentText').value = '';
                } else {
                    showError(result.error);
                }
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∫–æ–º–ø–ª–∏–º–µ–Ω—Ç–∞:', error);
                showError('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∫–æ–º–ø–ª–∏–º–µ–Ω—Ç–∞');
            }
        }

        // ==================== –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ====================

        // –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è —Ñ–∞–π–ª–∞ –≤ base64
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
                reader.readAsDataURL(file);
            });
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
        function showError(message) {
            showMessage(message, 'error');
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ
        function showMessage(message, type) {
            const messageArea = document.getElementById('messageArea');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            messageDiv.textContent = message;
            messageArea.appendChild(messageDiv);
            
            setTimeout(() => {
                if (messageDiv.parentNode) {
                    messageDiv.parentNode.removeChild(messageDiv);
                }
            }, 5000);
        }

        // –°–æ–∑–¥–∞–Ω–∏–µ –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–∞ "–ü–æ–¥–±–µ—Ä–∏ —Å—Ç–∏–ª—å"
        function createStyleMatchInteractive(interactive) {
            // –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–∞ "–ü–æ–¥–±–µ—Ä–∏ —Å—Ç–∏–ª—å"
            return createDefaultInteractive(interactive);
        }

        // –°–æ–∑–¥–∞–Ω–∏–µ –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–∞ "–†–∏—Å–æ–≤–∞–ª—å–Ω—ã–π —á–µ–ª–ª–µ–Ω–¥–∂"
        function createDrawingChallengeInteractive(interactive) {
            // –†–µ–∞–ª–∏–∑–∞—Ü–∏—è —Ä–∏—Å–æ–≤–∞–ª—å–Ω–æ–≥–æ —á–µ–ª–ª–µ–Ω–¥–∂–∞
            return `
                <div class="info">
                    <p>–ù–∞—Ä–∏—Å—É–π—Ç–µ —á—Ç–æ-—Ç–æ –Ω–∞ –∑–∞–¥–∞–Ω–Ω—É—é —Ç–µ–º—É –∏—Å–ø–æ–ª—å–∑—É—è –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –Ω–∏–∂–µ.</p>
                </div>
                <canvas id="drawingCanvas" class="drawing-canvas" width="400" height="300"></canvas>
                <div class="drawing-tools">
                    <div class="drawing-tool active" data-tool="brush">üñåÔ∏è –ö–∏—Å—Ç—å</div>
                    <div class="drawing-tool" data-tool="eraser">üßΩ –õ–∞—Å—Ç–∏–∫</div>
                    <div style="display: flex; gap: 8px; align-items: center;">
                        <div class="color-picker active" style="background: #000000;" data-color="#000000"></div>
                        <div class="color-picker" style="background: #ff0000;" data-color="#ff0000"></div>
                        <div class="color-picker" style="background: #0000ff;" data-color="#0000ff"></div>
                        <div class="color-picker" style="background: #00ff00;" data-color="#00ff00"></div>
                        <div class="color-picker" style="background: #ffff00;" data-color="#ffff00"></div>
                    </div>
                </div>
                <button class="btn" onclick="submitDrawing()" style="margin-top: 20px;">
                    üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ä–∏—Å—É–Ω–æ–∫
                </button>
            `;
        }

        // –°–æ–∑–¥–∞–Ω–∏–µ –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        function createDefaultInteractive(interactive) {
            let optionsHtml = '';
            interactive.options.forEach((option, index) => {
                optionsHtml += `
                    <div class="option" data-option="${index}">
                        ${option}
                    </div>
                `;
            });
            
            return `
                <h3 style="text-align: center; margin: 20px 0;">${interactive.question}</h3>
                <div class="options">
                    ${optionsHtml}
                </div>
                <button class="btn" onclick="submitInteractiveAnswer()" id="submitInteractiveBtn" disabled style="margin-top: 20px;">
                    ‚úÖ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ—Ç–≤–µ—Ç
                </button>
            `;
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ä–∏—Å–æ–≤–∞–ª—å–Ω–æ–≥–æ —á–µ–ª–ª–µ–Ω–¥–∂–∞
        function initDrawingChallenge() {
            const canvas = document.getElementById('drawingCanvas');
            const ctx = canvas.getContext('2d');
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è canvas
            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –¥–ª—è –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤
            // (—Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è —Ä–∏—Å–æ–≤–∞–Ω–∏—è)
        }

        // –û—Ç–ø—Ä–∞–≤–∫–∞ —Ä–∏—Å—É–Ω–∫–∞
        async function submitDrawing() {
            // –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ä–∏—Å—É–Ω–∫–∞
            showMessage('–§—É–Ω–∫—Ü–∏—è —Ä–∏—Å–æ–≤–∞–Ω–∏—è –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ', 'info');
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
