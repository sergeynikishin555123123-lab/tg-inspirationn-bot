// –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å –ú–∞—Å—Ç–µ—Ä—Å–∫–æ–π –í–¥–æ—Ö–Ω–æ–≤–µ–Ω–∏—è v8.0
class AdminPanel {
    constructor() {
        this.userId = this.getUserId();
        this.currentSection = 'dashboard';
        this.stats = null;
        this.init();
    }

    getUserId() {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get('userId') || '898508164'; // Fallback –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
    }

    async init() {
        console.log('üöÄ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏...');
        
        if (!this.userId) {
            this.showError('User ID –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞—Ö URL');
            return;
        }

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞
        try {
            const response = await fetch(`/api/admin/stats?userId=${this.userId}`);
            if (!response.ok) {
                if (response.status === 403) {
                    this.showError('–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω. –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞.');
                    return;
                }
                throw new Error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞');
            }

            this.stats = await response.json();
            this.showSection('dashboard');
            
        } catch (error) {
            console.error('‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:', error);
            this.showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏: ' + error.message);
        }
    }

    async showSection(sectionName) {
        this.currentSection = sectionName;
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –ø—É–Ω–∫—Ç –º–µ–Ω—é
        document.querySelectorAll('.nav-item').forEach(item => {
            item.classList.remove('active');
        });
        document.querySelector(`[onclick="admin.showSection('${sectionName}')"]`).classList.add('active');
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫
        const titles = {
            dashboard: { title: '–î–∞—à–±–æ—Ä–¥', subtitle: '–û–±–∑–æ—Ä —Å–∏—Å—Ç–µ–º—ã –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞' },
            users: { title: '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏', subtitle: '–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ –∏ –æ—Ç—á–µ—Ç—ã' },
            stats: { title: '–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞', subtitle: '–ü–æ–¥—Ä–æ–±–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ —Å–∏—Å—Ç–µ–º—ã' },
            quizzes: { title: '–ö–≤–∏–∑—ã', subtitle: '–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–≤–∏–∑–∞–º–∏ –∏ –≤–æ–ø—Ä–æ—Å–∞–º–∏' },
            marathons: { title: '–ú–∞—Ä–∞—Ñ–æ–Ω—ã', subtitle: '–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–∞—Ä–∞—Ñ–æ–Ω–∞–º–∏ –∏ –∑–∞–¥–∞–Ω–∏—è–º–∏' },
            interactives: { title: '–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤—ã', subtitle: '–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–º–∏ –∑–∞–¥–∞–Ω–∏—è–º–∏' },
            shop: { title: '–ú–∞–≥–∞–∑–∏–Ω', subtitle: '–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞–º–∏ –∏ —Ü–µ–Ω–∞–º–∏' },
            posts: { title: '–ü–æ—Å—Ç—ã', subtitle: '–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ—Å—Ç–∞–º–∏ –∏ –∫–æ–Ω—Ç–µ–Ω—Ç–æ–º' },
            roles: { title: '–†–æ–ª–∏', subtitle: '–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–æ–ª—è–º–∏ –∏ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è–º–∏' },
            characters: { title: '–ü–µ—Ä—Å–æ–Ω–∞–∂–∏', subtitle: '–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞–º–∏ –∏ –±–æ–Ω—É—Å–∞–º–∏' },
            moderation: { title: '–ú–æ–¥–µ—Ä–∞—Ü–∏—è', subtitle: '–ú–æ–¥–µ—Ä–∞—Ü–∏—è —Ä–∞–±–æ—Ç –∏ –æ—Ç–∑—ã–≤–æ–≤' },
            admins: { title: '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã', subtitle: '–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–∞–≤–∞–º–∏ –¥–æ—Å—Ç—É–ø–∞' },
            settings: { title: '–ù–∞—Å—Ç—Ä–æ–π–∫–∏', subtitle: '–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–∏—Å—Ç–µ–º—ã' }
        };

        const titleInfo = titles[sectionName] || { title: '–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å', subtitle: '' };
        document.getElementById('pageTitle').textContent = titleInfo.title;
        document.getElementById('pageSubtitle').textContent = titleInfo.subtitle;

        // –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç —Å–µ–∫—Ü–∏–∏
        await this.loadSectionContent(sectionName);
    }

    async loadSectionContent(sectionName) {
        const contentArea = document.getElementById('contentArea');
        contentArea.innerHTML = `
            <div class="loading">
                <div class="loading-spinner"></div>
                <div>–ó–∞–≥—Ä—É–∑–∫–∞ ${sectionName}...</div>
            </div>
        `;

        try {
            let html = '';
            
            switch (sectionName) {
                case 'dashboard':
                    html = await this.loadDashboard();
                    break;
                case 'users':
                    html = await this.loadUsers();
                    break;
                case 'stats':
                    html = await this.loadStats();
                    break;
                case 'quizzes':
                    html = await this.loadQuizzes();
                    break;
                case 'marathons':
                    html = await this.loadMarathons();
                    break;
                case 'interactives':
                    html = await this.loadInteractives();
                    break;
                case 'shop':
                    html = await this.loadShop();
                    break;
                case 'posts':
                    html = await this.loadPosts();
                    break;
                case 'roles':
                    html = await this.loadRoles();
                    break;
                case 'characters':
                    html = await this.loadCharacters();
                    break;
                case 'moderation':
                    html = await this.loadModeration();
                    break;
                case 'admins':
                    html = await this.loadAdmins();
                    break;
                case 'settings':
                    html = await this.loadSettings();
                    break;
                default:
                    html = '<div class="text-center p-4">–†–∞–∑–¥–µ–ª –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ</div>';
            }
            
            contentArea.innerHTML = html;
            
        } catch (error) {
            console.error(`‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–µ–∫—Ü–∏–∏ ${sectionName}:`, error);
            contentArea.innerHTML = `
                <div class="text-center p-4">
                    <div class="text-danger">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${error.message}</div>
                    <button class="btn btn-primary mt-4" onclick="admin.loadSectionContent('${sectionName}')">
                        –ü–æ–≤—Ç–æ—Ä–∏—Ç—å –ø–æ–ø—ã—Ç–∫—É
                    </button>
                </div>
            `;
        }
    }

    async loadDashboard() {
        const stats = await this.fetchAdminData('stats');
        
        return `
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value">${stats.totalUsers}</div>
                    <div class="stat-label">–í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</div>
                    <div class="stat-change positive">
                        ‚Üë ${stats.newUsersToday} –Ω–æ–≤—ã—Ö —Å–µ–≥–æ–¥–Ω—è
                    </div>
                </div>
                <div class="stat-card success">
                    <div class="stat-value">${stats.registeredUsers}</div>
                    <div class="stat-label">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–æ</div>
                    <div class="stat-change positive">
                        ${Math.round((stats.registeredUsers / stats.totalUsers) * 100)}% –∞–∫—Ç–∏–≤–Ω—ã—Ö
                    </div>
                </div>
                <div class="stat-card warning">
                    <div class="stat-value">${stats.activeUsers}</div>
                    <div class="stat-label">–ê–∫—Ç–∏–≤–Ω—ã—Ö (30 –¥–Ω–µ–π)</div>
                    <div class="stat-change positive">
                        ${Math.round((stats.activeUsers / stats.totalUsers) * 100)}% –æ—Ç –≤—Å–µ—Ö
                    </div>
                </div>
                <div class="stat-card info">
                    <div class="stat-value">${stats.totalSparks.toFixed(0)}</div>
                    <div class="stat-label">–í—Å–µ–≥–æ –∏—Å–∫—Ä –≤ —Å–∏—Å—Ç–µ–º–µ</div>
                    <div class="stat-change positive">
                        ${stats.earnedSparks} –∑–∞—Ä–∞–±–æ—Ç–∞–Ω–æ
                    </div>
                </div>
            </div>

            <div class="form-container">
                <h3 class="mb-4">üìà –ë—ã—Å—Ç—Ä–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h3>
                <div class="form-grid">
                    <div>
                        <div class="form-group">
                            <div class="form-label">–ê–∫—Ç–∏–≤–Ω—ã–µ –∫–≤–∏–∑—ã</div>
                            <div class="stat-value text-info">${stats.activeQuizzes}</div>
                        </div>
                        <div class="form-group">
                            <div class="form-label">–ê–∫—Ç–∏–≤–Ω—ã–µ –º–∞—Ä–∞—Ñ–æ–Ω—ã</div>
                            <div class="stat-value text-warning">${stats.activeMarathons}</div>
                        </div>
                    </div>
                    <div>
                        <div class="form-group">
                            <div class="form-label">–¢–æ–≤–∞—Ä–æ–≤ –≤ –º–∞–≥–∞–∑–∏–Ω–µ</div>
                            <div class="stat-value text-success">${stats.shopItems}</div>
                        </div>
                        <div class="form-group">
                            <div class="form-label">–í—Å–µ–≥–æ –ø–æ–∫—É–ø–æ–∫</div>
                            <div class="stat-value text-primary">${stats.totalPurchases}</div>
                        </div>
                    </div>
                    <div>
                        <div class="form-group">
                            <div class="form-label">–ù–∞ –º–æ–¥–µ—Ä–∞—Ü–∏–∏</div>
                            <div class="stat-value text-danger">${stats.pendingWorks + stats.pendingReviews}</div>
                            <small class="text-muted">${stats.pendingWorks} —Ä–∞–±–æ—Ç, ${stats.pendingReviews} –æ—Ç–∑—ã–≤–æ–≤</small>
                        </div>
                        <div class="form-group">
                            <div class="form-label">–í—Å–µ–≥–æ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–µ–π</div>
                            <div class="stat-value text-secondary">${stats.totalActivities}</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="table-container">
                <div class="table-header">
                    <div class="table-title">üéØ –ü–æ—Å–ª–µ–¥–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏</div>
                    <div class="table-actions">
                        <button class="btn btn-sm btn-primary" onclick="admin.showSection('stats')">
                            –í—Å—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
                        </button>
                    </div>
                </div>
                <div class="p-4 text-center text-muted">
                    –î–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ø–æ–ª–Ω–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø–µ—Ä–µ–π–¥–∏—Ç–µ –≤ —Ä–∞–∑–¥–µ–ª "–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞"
                </div>
            </div>
        `;
    }

    async loadUsers() {
        const report = await this.fetchAdminData('users-report');
        
        return `
            <div class="table-container">
                <div class="table-header">
                    <div class="table-title">üë• –û—Ç—á–µ—Ç –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º</div>
                    <div class="table-actions">
                        <button class="btn btn-sm btn-primary" onclick="admin.exportUsers()">
                            üìä –≠–∫—Å–ø–æ—Ä—Ç –≤ CSV
                        </button>
                    </div>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>–ò–º—è</th>
                            <th>–†–æ–ª—å</th>
                            <th>–ò—Å–∫—Ä—ã</th>
                            <th>–£—Ä–æ–≤–µ–Ω—å</th>
                            <th>–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏</th>
                            <th>–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${report.users.slice(0, 50).map(user => `
                            <tr>
                                <td>${user.id}</td>
                                <td>
                                    <strong>${user.name}</strong>
                                    ${user.username ? `<br><small class="text-muted">@${user.username}</small>` : ''}
                                </td>
                                <td>
                                    <span class="badge badge-secondary">${user.role}</span>
                                    ${user.character ? `<br><small>${user.character}</small>` : ''}
                                </td>
                                <td>
                                    <strong>${user.sparks.toFixed(1)}</strong>
                                    <div class="stat-change ${user.total_spent > 0 ? 'negative' : 'positive'}">
                                        ${user.total_spent > 0 ? `-${user.total_spent} –ø–æ—Ç—Ä–∞—á–µ–Ω–æ` : '—Ç–æ–ª—å–∫–æ –∑–∞—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç'}
                                    </div>
                                </td>
                                <td>
                                    <span class="badge badge-info">${user.level}</span>
                                </td>
                                <td>
                                    <div class="text-sm">
                                        <div>üìä ${user.total_activities}</div>
                                        <div>üéØ ${user.total_quizzes}</div>
                                        <div>üèÉ‚Äç‚ôÇÔ∏è ${user.total_marathons}</div>
                                        <div>üñºÔ∏è ${user.total_works}</div>
                                    </div>
                                </td>
                                <td>${this.formatDate(user.registration_date)}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
                ${report.users.length > 50 ? `
                    <div class="p-4 text-center">
                        <small class="text-muted">
                            –ü–æ–∫–∞–∑–∞–Ω–æ 50 –∏–∑ ${report.users.length} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
                        </small>
                    </div>
                ` : ''}
            </div>
        `;
    }

    async loadStats() {
        const fullStats = await this.fetchAdminData('full-stats');
        
        return `
            <div class="form-container">
                <h3 class="mb-4">üìä –ü–æ–ª–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–∏—Å—Ç–µ–º—ã</h3>
                
                <div class="form-grid">
                    <div>
                        <h4 class="mb-4">üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</h4>
                        ${Object.entries(fullStats.users).map(([key, value]) => {
                            if (typeof value === 'number') {
                                return `
                                    <div class="form-group">
                                        <div class="form-label">${this.formatStatKey(key)}</div>
                                        <div class="stat-value text-primary">${value}</div>
                                    </div>
                                `;
                            }
                            return '';
                        }).join('')}
                    </div>
                    
                    <div>
                        <h4 class="mb-4">üéØ –ö–æ–Ω—Ç–µ–Ω—Ç</h4>
                        ${Object.entries(fullStats.content).map(([key, value]) => {
                            if (typeof value === 'number') {
                                return `
                                    <div class="form-group">
                                        <div class="form-label">${this.formatStatKey(key)}</div>
                                        <div class="stat-value text-info">${value}</div>
                                    </div>
                                `;
                            }
                            return '';
                        }).join('')}
                    </div>
                    
                    <div>
                        <h4 class="mb-4">üí∞ –≠–∫–æ–Ω–æ–º–∏–∫–∞</h4>
                        ${Object.entries(fullStats.activities).map(([key, value]) => {
                            if (typeof value === 'number') {
                                return `
                                    <div class="form-group">
                                        <div class="form-label">${this.formatStatKey(key)}</div>
                                        <div class="stat-value text-success">${value}</div>
                                    </div>
                                `;
                            }
                            return '';
                        }).join('')}
                    </div>
                </div>
            </div>

            <div class="form-container">
                <h3 class="mb-4">üìà –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ —Ä–æ–ª—è–º</h3>
                <div class="form-grid">
                    ${fullStats.users.by_role.map(role => `
                        <div class="form-group">
                            <div class="form-label">${role.role}</div>
                            <div class="stat-value text-warning">${role.count}</div>
                            <div class="progress-bar" style="height: 8px; background: #e2e8f0; border-radius: 4px; margin-top: 8px;">
                                <div class="progress-fill" style="height: 100%; background: #f59e0b; border-radius: 4px; width: ${(role.count / fullStats.users.total) * 100}%"></div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            </div>

            <div class="form-container">
                <h3 class="mb-4">üí∞ –î–æ—Ö–æ–¥—ã –ø–æ —Ç–æ–≤–∞—Ä–∞–º</h3>
                <table class="w-full">
                    <thead>
                        <tr>
                            <th>–¢–æ–≤–∞—Ä</th>
                            <th>–ü–æ–∫—É–ø–æ–∫</th>
                            <th>–î–æ—Ö–æ–¥</th>
                            <th>–°—Ä–µ–¥–Ω–∏–π —á–µ–∫</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${fullStats.revenue.by_item.map(item => `
                            <tr>
                                <td>${item.item}</td>
                                <td>${item.purchases}</td>
                                <td><strong>${item.revenue}‚ú®</strong></td>
                                <td>${(item.revenue / item.purchases).toFixed(1)}‚ú®</td>
                            </tr>
                        `).join('')}
                        <tr style="background: #f8fafc;">
                            <td><strong>–ò—Ç–æ–≥–æ</strong></td>
                            <td><strong>${fullStats.revenue.total}</strong></td>
                            <td><strong>${fullStats.revenue.by_item.reduce((sum, item) => sum + item.revenue, 0)}‚ú®</strong></td>
                            <td><strong>${(fullStats.revenue.by_item.reduce((sum, item) => sum + item.revenue, 0) / fullStats.revenue.by_item.reduce((sum, item) => sum + item.purchases, 0)).toFixed(1)}‚ú®</strong></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        `;
    }

    async loadQuizzes() {
        const quizzes = await this.fetchAdminData('quizzes');
        
        return `
            <div class="table-container">
                <div class="table-header">
                    <div class="table-title">üéØ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–≤–∏–∑–∞–º–∏</div>
                    <div class="table-actions">
                        <button class="btn btn-sm btn-primary" onclick="admin.showQuizForm()">
                            ‚ûï –°–æ–∑–¥–∞—Ç—å –∫–≤–∏–∑
                        </button>
                    </div>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                            <th>–°–ª–æ–∂–Ω–æ—Å—Ç—å</th>
                            <th>–í–æ–ø—Ä–æ—Å—ã</th>
                            <th>–ü—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è</th>
                            <th>–£—Å–ø–µ—à–Ω–æ—Å—Ç—å</th>
                            <th>–°—Ç–∞—Ç—É—Å</th>
                            <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${quizzes.map(quiz => `
                            <tr>
                                <td>${quiz.id}</td>
                                <td>
                                    <strong>${quiz.title}</strong>
                                    <div class="text-muted">${quiz.description}</div>
                                </td>
                                <td>
                                    <span class="badge ${
                                        quiz.difficulty === 'beginner' ? 'badge-success' : 
                                        quiz.difficulty === 'intermediate' ? 'badge-warning' : 'badge-danger'
                                    }">
                                        ${quiz.difficulty}
                                    </span>
                                </td>
                                <td>${quiz.questions.length}</td>
                                <td>
                                    <div>${quiz.completions_count}</div>
                                    <small class="text-muted">${quiz.perfect_completions} –∏–¥–µ–∞–ª—å–Ω–æ</small>
                                </td>
                                <td>
                                    <div>${quiz.average_score.toFixed(1)}/5</div>
                                    <small class="text-muted">${quiz.success_rate.toFixed(1)}%</small>
                                </td>
                                <td>
                                    <span class="badge ${quiz.is_active ? 'badge-success' : 'badge-secondary'}">
                                        ${quiz.is_active ? '–ê–∫—Ç–∏–≤–µ–Ω' : '–ù–µ–∞–∫—Ç–∏–≤–µ–Ω'}
                                    </span>
                                </td>
                                <td>
                                    <div class="flex gap-4">
                                        <button class="btn btn-sm btn-primary" onclick="admin.editQuiz(${quiz.id})">
                                            ‚úèÔ∏è
                                        </button>
                                        <button class="btn btn-sm btn-danger" onclick="admin.deleteQuiz(${quiz.id})">
                                            üóëÔ∏è
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        `;
    }

    async loadMarathons() {
        const marathons = await this.fetchAdminData('marathons');
        
        return `
            <div class="table-container">
                <div class="table-header">
                    <div class="table-title">üèÉ‚Äç‚ôÇÔ∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–∞—Ä–∞—Ñ–æ–Ω–∞–º–∏</div>
                    <div class="table-actions">
                        <button class="btn btn-sm btn-primary" onclick="admin.showMarathonForm()">
                            ‚ûï –°–æ–∑–¥–∞—Ç—å –º–∞—Ä–∞—Ñ–æ–Ω
                        </button>
                    </div>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                            <th>–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å</th>
                            <th>–£—á–∞—Å—Ç–Ω–∏–∫–∏</th>
                            <th>–ó–∞–≤–µ—Ä—à–∏–ª–∏</th>
                            <th>–ù–∞–≥—Ä–∞–¥—ã</th>
                            <th>–°—Ç–∞—Ç—É—Å</th>
                            <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${marathons.map(marathon => `
                            <tr>
                                <td>${marathon.id}</td>
                                <td>
                                    <strong>${marathon.title}</strong>
                                    <div class="text-muted">${marathon.description}</div>
                                </td>
                                <td>${marathon.duration_days} –¥–Ω–µ–π</td>
                                <td>
                                    <div>${marathon.completions_count}</div>
                                    <small class="text-muted">${marathon.active_participants} –∞–∫—Ç–∏–≤–Ω—ã</small>
                                </td>
                                <td>
                                    <div>${marathon.completed_participants}</div>
                                    <small class="text-muted">${marathon.completion_rate.toFixed(1)}%</small>
                                </td>
                                <td>
                                    <div>${marathon.sparks_per_day}‚ú®/–¥–µ–Ω—å</div>
                                    <small class="text-muted">+${marathon.sparks_completion_bonus}‚ú® –±–æ–Ω—É—Å</small>
                                </td>
                                <td>
                                    <span class="badge ${marathon.is_active ? 'badge-success' : 'badge-secondary'}">
                                        ${marathon.is_active ? '–ê–∫—Ç–∏–≤–µ–Ω' : '–ù–µ–∞–∫—Ç–∏–≤–µ–Ω'}
                                    </span>
                                </td>
                                <td>
                                    <div class="flex gap-4">
                                        <button class="btn btn-sm btn-primary" onclick="admin.editMarathon(${marathon.id})">
                                            ‚úèÔ∏è
                                        </button>
                                        <button class="btn btn-sm btn-danger" onclick="admin.deleteMarathon(${marathon.id})">
                                            üóëÔ∏è
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        `;
    }

    async loadInteractives() {
        const interactives = await this.fetchAdminData('interactives');
        
        return `
            <div class="table-container">
                <div class="table-header">
                    <div class="table-title">üéÆ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–∞–º–∏</div>
                    <div class="table-actions">
                        <button class="btn btn-sm btn-primary" onclick="admin.showInteractiveForm()">
                            ‚ûï –°–æ–∑–¥–∞—Ç—å –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤
                        </button>
                    </div>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                            <th>–¢–∏–ø</th>
                            <th>–ü—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è</th>
                            <th>–£—Å–ø–µ—à–Ω–æ—Å—Ç—å</th>
                            <th>–ù–∞–≥—Ä–∞–¥–∞</th>
                            <th>–°—Ç–∞—Ç—É—Å</th>
                            <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${interactives.map(interactive => `
                            <tr>
                                <td>${interactive.id}</td>
                                <td>
                                    <strong>${interactive.title}</strong>
                                    <div class="text-muted">${interactive.description}</div>
                                </td>
                                <td>
                                    <span class="badge badge-info">${interactive.type}</span>
                                </td>
                                <td>${interactive.completions_count}</td>
                                <td>
                                    <div>${interactive.average_score.toFixed(1)}/1</div>
                                    <small class="text-muted">${interactive.success_rate.toFixed(1)}%</small>
                                </td>
                                <td>${interactive.sparks_reward}‚ú®</td>
                                <td>
                                    <span class="badge ${interactive.is_active ? 'badge-success' : 'badge-secondary'}">
                                        ${interactive.is_active ? '–ê–∫—Ç–∏–≤–µ–Ω' : '–ù–µ–∞–∫—Ç–∏–≤–µ–Ω'}
                                    </span>
                                </td>
                                <td>
                                    <div class="flex gap-4">
                                        <button class="btn btn-sm btn-primary" onclick="admin.editInteractive(${interactive.id})">
                                            ‚úèÔ∏è
                                        </button>
                                        <button class="btn btn-sm btn-danger" onclick="admin.deleteInteractive(${interactive.id})">
                                            üóëÔ∏è
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        `;
    }

    async loadShop() {
        const items = await this.fetchAdminData('shop/items');
        
        return `
            <div class="table-container">
                <div class="table-header">
                    <div class="table-title">üõí –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–∞–≥–∞–∑–∏–Ω–æ–º</div>
                    <div class="table-actions">
                        <button class="btn btn-sm btn-primary" onclick="admin.showShopItemForm()">
                            ‚ûï –î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä
                        </button>
                    </div>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                            <th>–¢–∏–ø</th>
                            <th>–¶–µ–Ω–∞</th>
                            <th>–ü–æ–∫—É–ø–∫–∏</th>
                            <th>–î–æ—Ö–æ–¥</th>
                            <th>–°—Ç–∞—Ç—É—Å</th>
                            <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${items.map(item => `
                            <tr>
                                <td>${item.id}</td>
                                <td>
                                    <strong>${item.title}</strong>
                                    <div class="text-muted">${item.description}</div>
                                </td>
                                <td>
                                    <span class="badge badge-info">${item.type}</span>
                                </td>
                                <td>
                                    <strong>${item.price}‚ú®</strong>
                                </td>
                                <td>
                                    <div>${item.purchases_count}</div>
                                    <small class="text-muted">${item.students_count} —Å—Ç—É–¥–µ–Ω—Ç–æ–≤</small>
                                </td>
                                <td>
                                    <strong>${item.total_revenue}‚ú®</strong>
                                </td>
                                <td>
                                    <span class="badge ${item.is_active ? 'badge-success' : 'badge-secondary'}">
                                        ${item.is_active ? '–ê–∫—Ç–∏–≤–µ–Ω' : '–ù–µ–∞–∫—Ç–∏–≤–µ–Ω'}
                                    </span>
                                </td>
                                <td>
                                    <div class="flex gap-4">
                                        <button class="btn btn-sm btn-primary" onclick="admin.editShopItem(${item.id})">
                                            ‚úèÔ∏è
                                        </button>
                                        <button class="btn btn-sm btn-danger" onclick="admin.deleteShopItem(${item.id})">
                                            üóëÔ∏è
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        `;
    }

    async loadPosts() {
        const posts = await this.fetchAdminData('channel-posts');
        
        return `
            <div class="table-container">
                <div class="table-header">
                    <div class="table-title">üì∞ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ—Å—Ç–∞–º–∏</div>
                    <div class="table-actions">
                        <button class="btn btn-sm btn-primary" onclick="admin.showPostForm()">
                            ‚ûï –°–æ–∑–¥–∞—Ç—å –ø–æ—Å—Ç
                        </button>
                    </div>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>–ó–∞–≥–æ–ª–æ–≤–æ–∫</th>
                            <th>–¢–∏–ø</th>
                            <th>–û—Ç–∑—ã–≤—ã</th>
                            <th>–†–µ–π—Ç–∏–Ω–≥</th>
                            <th>–ê–≤—Ç–æ—Ä</th>
                            <th>–°—Ç–∞—Ç—É—Å</th>
                            <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${posts.posts.map(post => `
                            <tr>
                                <td>${post.id}</td>
                                <td>
                                    <strong>${post.title}</strong>
                                    <div class="text-muted">${post.content.substring(0, 100)}...</div>
                                </td>
                                <td>
                                    <span class="badge badge-secondary">${post.media_type}</span>
                                </td>
                                <td>
                                    <div>${post.reviews_count}</div>
                                </td>
                                <td>
                                    <div>${post.average_rating.toFixed(1)}/5</div>
                                </td>
                                <td>${post.admin_username}</td>
                                <td>
                                    <span class="badge ${post.is_active ? 'badge-success' : 'badge-secondary'}">
                                        ${post.is_active ? '–ê–∫—Ç–∏–≤–µ–Ω' : '–ù–µ–∞–∫—Ç–∏–≤–µ–Ω'}
                                    </span>
                                </td>
                                <td>
                                    <div class="flex gap-4">
                                        <button class="btn btn-sm btn-primary" onclick="admin.editPost(${post.id})">
                                            ‚úèÔ∏è
                                        </button>
                                        <button class="btn btn-sm btn-danger" onclick="admin.deletePost(${post.id})">
                                            üóëÔ∏è
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        `;
    }

    async loadRoles() {
        const roles = await this.fetchAdminData('roles');
        
        return `
            <div class="table-container">
                <div class="table-header">
                    <div class="table-title">üîß –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–æ–ª—è–º–∏</div>
                    <div class="table-actions">
                        <button class="btn btn-sm btn-primary" onclick="admin.showRoleForm()">
                            ‚ûï –°–æ–∑–¥–∞—Ç—å —Ä–æ–ª—å
                        </button>
                    </div>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                            <th>–û–ø–∏—Å–∞–Ω–∏–µ</th>
                            <th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</th>
                            <th>–ö–Ω–æ–ø–∫–∏</th>
                            <th>–°—Ç–∞—Ç—É—Å</th>
                            <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${roles.map(role => `
                            <tr>
                                <td>${role.id}</td>
                                <td>
                                    <strong>${role.icon} ${role.name}</strong>
                                    <div class="text-muted">${role.description}</div>
                                </td>
                                <td>${role.description}</td>
                                <td>
                                    <div>${role.users_count}</div>
                                </td>
                                <td>
                                    <small>${role.available_buttons.slice(0, 3).join(', ')}...</small>
                                </td>
                                <td>
                                    <span class="badge ${role.is_active ? 'badge-success' : 'badge-secondary'}">
                                        ${role.is_active ? '–ê–∫—Ç–∏–≤–Ω–∞' : '–ù–µ–∞–∫—Ç–∏–≤–Ω–∞'}
                                    </span>
                                </td>
                                <td>
                                    <div class="flex gap-4">
                                        <button class="btn btn-sm btn-primary" onclick="admin.editRole(${role.id})">
                                            ‚úèÔ∏è
                                        </button>
                                        <button class="btn btn-sm btn-danger" onclick="admin.deleteRole(${role.id})">
                                            üóëÔ∏è
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        `;
    }

    async loadCharacters() {
        const characters = await this.fetchAdminData('characters');
        
        return `
            <div class="table-container">
                <div class="table-header">
                    <div class="table-title">üë§ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞–º–∏</div>
                    <div class="table-actions">
                        <button class="btn btn-sm btn-primary" onclick="admin.showCharacterForm()">
                            ‚ûï –°–æ–∑–¥–∞—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–∂–∞
                        </button>
                    </div>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>–ò–º—è</th>
                            <th>–†–æ–ª—å</th>
                            <th>–ë–æ–Ω—É—Å</th>
                            <th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</th>
                            <th>–°—Ç–∞—Ç—É—Å</th>
                            <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${characters.map(character => `
                            <tr>
                                <td>${character.id}</td>
                                <td>
                                    <strong>${character.avatar} ${character.name}</strong>
                                    <div class="text-muted">${character.description}</div>
                                </td>
                                <td>${character.role_name}</td>
                                <td>
                                    <div><strong>${character.bonus_description}</strong></div>
                                    <small class="text-muted">${character.bonus_type}: ${character.bonus_value}</small>
                                </td>
                                <td>${character.users_count}</td>
                                <td>
                                    <span class="badge ${character.is_active ? 'badge-success' : 'badge-secondary'}">
                                        ${character.is_active ? '–ê–∫—Ç–∏–≤–µ–Ω' : '–ù–µ–∞–∫—Ç–∏–≤–µ–Ω'}
                                    </span>
                                </td>
                                <td>
                                    <div class="flex gap-4">
                                        <button class="btn btn-sm btn-primary" onclick="admin.editCharacter(${character.id})">
                                            ‚úèÔ∏è
                                        </button>
                                        <button class="btn btn-sm btn-danger" onclick="admin.deleteCharacter(${character.id})">
                                            üóëÔ∏è
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        `;
    }

    async loadModeration() {
        const [works, reviews] = await Promise.all([
            this.fetchAdminData('user-works?status=pending'),
            this.fetchAdminData('reviews?status=pending')
        ]);
        
        return `
            <div class="form-container">
                <h3 class="mb-4">üñºÔ∏è –†–∞–±–æ—Ç—ã –Ω–∞ –º–æ–¥–µ—Ä–∞—Ü–∏–∏</h3>
                ${works.works.length > 0 ? `
                    <table class="w-full">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                                <th>–ê–≤—Ç–æ—Ä</th>
                                <th>–î–∞—Ç–∞</th>
                                <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${works.works.map(work => `
                                <tr>
                                    <td>${work.id}</td>
                                    <td>
                                        <strong>${work.title}</strong>
                                        <div class="text-muted">${work.description}</div>
                                    </td>
                                    <td>
                                        <div>${work.user_name}</div>
                                        <small class="text-muted">${work.user_level}</small>
                                    </td>
                                    <td>${this.formatDate(work.created_at)}</td>
                                    <td>
                                        <div class="flex gap-4">
                                            <button class="btn btn-sm btn-success" onclick="admin.moderateWork(${work.id}, 'approved')">
                                                ‚úÖ
                                            </button>
                                            <button class="btn btn-sm btn-danger" onclick="admin.moderateWork(${work.id}, 'rejected')">
                                                ‚ùå
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                ` : `
                    <div class="text-center p-4 text-muted">
                        –ù–µ—Ç —Ä–∞–±–æ—Ç –Ω–∞ –º–æ–¥–µ—Ä–∞—Ü–∏–∏
                    </div>
                `}
            </div>

            <div class="form-container">
                <h3 class="mb-4">‚úçÔ∏è –û—Ç–∑—ã–≤—ã –Ω–∞ –º–æ–¥–µ—Ä–∞—Ü–∏–∏</h3>
                ${reviews.reviews.length > 0 ? `
                    <table class="w-full">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>–ü–æ—Å—Ç</th>
                                <th>–ê–≤—Ç–æ—Ä</th>
                                <th>–û—Ç–∑—ã–≤</th>
                                <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${reviews.reviews.map(review => `
                                <tr>
                                    <td>${review.id}</td>
                                    <td>
                                        <strong>${review.post_title}</strong>
                                    </td>
                                    <td>
                                        <div>${review.tg_first_name}</div>
                                        <small class="text-muted">@${review.tg_username}</small>
                                    </td>
                                    <td>
                                        <div>${review.review_text.substring(0, 100)}...</div>
                                        <small class="text-muted">–û—Ü–µ–Ω–∫–∞: ${review.rating}/5</small>
                                    </td>
                                    <td>
                                        <div class="flex gap-4">
                                            <button class="btn btn-sm btn-success" onclick="admin.moderateReview(${review.id}, 'approved')">
                                                ‚úÖ
                                            </button>
                                            <button class="btn btn-sm btn-danger" onclick="admin.moderateReview(${review.id}, 'rejected')">
                                                ‚ùå
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                ` : `
                    <div class="text-center p-4 text-muted">
                        –ù–µ—Ç –æ—Ç–∑—ã–≤–æ–≤ –Ω–∞ –º–æ–¥–µ—Ä–∞—Ü–∏–∏
                    </div>
                `}
            </div>
        `;
    }

    async loadAdmins() {
        const admins = await this.fetchAdminData('admins');
        
        return `
            <div class="table-container">
                <div class="table-header">
                    <div class="table-title">üëë –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º–∏</div>
                    <div class="table-actions">
                        <button class="btn btn-sm btn-primary" onclick="admin.showAdminForm()">
                            ‚ûï –î–æ–±–∞–≤–∏—Ç—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
                        </button>
                    </div>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th>
                            <th>–†–æ–ª—å</th>
                            <th>–†–∞–∑—Ä–µ—à–µ–Ω–∏—è</th>
                            <th>–î–∞—Ç–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è</th>
                            <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${admins.map(admin => `
                            <tr>
                                <td>${admin.id}</td>
                                <td>
                                    <div>${admin.tg_first_name}</div>
                                    <small class="text-muted">@${admin.username}</small>
                                </td>
                                <td>
                                    <span class="badge ${
                                        admin.role === 'superadmin' ? 'badge-danger' : 
                                        admin.role === 'admin' ? 'badge-warning' : 'badge-info'
                                    }">
                                        ${admin.role}
                                    </span>
                                </td>
                                <td>
                                    <small>${admin.permissions.slice(0, 3).join(', ')}...</small>
                                </td>
                                <td>${this.formatDate(admin.created_at)}</td>
                                <td>
                                    ${admin.user_id != this.userId ? `
                                        <button class="btn btn-sm btn-danger" onclick="admin.removeAdmin(${admin.user_id})">
                                            üóëÔ∏è –£–¥–∞–ª–∏—Ç—å
                                        </button>
                                    ` : '<small class="text-muted">–≠—Ç–æ –≤—ã</small>'}
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        `;
    }

    async loadSettings() {
        const settings = await this.fetchAdminData('settings');
        
        return `
            <div class="form-container">
                <h3 class="mb-4">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–∏—Å—Ç–µ–º—ã</h3>
                <form id="settingsForm">
                    ${settings.map(setting => `
                        <div class="form-group">
                            <label class="form-label">${setting.description}</label>
                            <input type="text" class="form-control" 
                                   name="${setting.key}" 
                                   value="${setting.value}"
                                   placeholder="${setting.description}">
                        </div>
                    `).join('')}
                    <div class="form-group">
                        <button type="submit" class="btn btn-primary">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</button>
                    </div>
                </form>
            </div>
        `;

        // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ñ–æ—Ä–º—ã
        document.getElementById('settingsForm').addEventListener('submit', this.saveSettings.bind(this));
    }

    // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ –º–µ—Ç–æ–¥—ã
    async fetchAdminData(endpoint) {
        const response = await fetch(`/api/admin/${endpoint}?userId=${this.userId}`);
        if (!response.ok) throw new Error(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ ${endpoint}`);
        const data = await response.json();
        return data;
    }

    formatDate(dateString) {
        return new Date(dateString).toLocaleDateString('ru-RU');
    }

    formatStatKey(key) {
        const translations = {
            totalUsers: '–í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π',
            registeredUsers: '–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–æ',
            activeUsers: '–ê–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π',
            newUsersToday: '–ù–æ–≤—ã—Ö —Å–µ–≥–æ–¥–Ω—è',
            activeQuizzes: '–ê–∫—Ç–∏–≤–Ω—ã—Ö –∫–≤–∏–∑–æ–≤',
            activeMarathons: '–ê–∫—Ç–∏–≤–Ω—ã—Ö –º–∞—Ä–∞—Ñ–æ–Ω–æ–≤',
            shopItems: '–¢–æ–≤–∞—Ä–æ–≤ –≤ –º–∞–≥–∞–∑–∏–Ω–µ',
            totalSparks: '–í—Å–µ–≥–æ –∏—Å–∫—Ä',
            totalPurchases: '–í—Å–µ–≥–æ –ø–æ–∫—É–ø–æ–∫',
            totalActivities: '–í—Å–µ–≥–æ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–µ–π',
            earnedSparks: '–ó–∞—Ä–∞–±–æ—Ç–∞–Ω–æ –∏—Å–∫—Ä',
            spentSparks: '–ü–æ—Ç—Ä–∞—á–µ–Ω–æ –∏—Å–∫—Ä'
        };
        return translations[key] || key;
    }

    showMessage(text, type = 'info') {
        const messageArea = document.getElementById('messageArea');
        const messageClass = type === 'error' ? 'text-danger' : type === 'success' ? 'text-success' : 'text-info';
        
        messageArea.innerHTML = `
            <div class="form-container ${messageClass}">
                ${text}
            </div>
        `;
        
        setTimeout(() => {
            messageArea.innerHTML = '';
        }, 5000);
    }

    showError(text) {
        this.showMessage(text, 'error');
    }

    async refreshData() {
        await this.loadSectionContent(this.currentSection);
        this.showMessage('–î–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω—ã', 'success');
    }

    // –ó–∞–≥–ª—É—à–∫–∏ –¥–ª—è –º–µ—Ç–æ–¥–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –Ω—É–∂–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å
    async exportData() {
        this.showMessage('–≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ', 'info');
    }

    async exportUsers() {
        this.showMessage('–≠–∫—Å–ø–æ—Ä—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ', 'info');
    }

    // –ú–µ—Ç–æ–¥—ã –¥–ª—è —Ñ–æ—Ä–º (–∑–∞–≥–ª—É—à–∫–∏)
    showQuizForm() { this.showMessage('–°–æ–∑–¥–∞–Ω–∏–µ –∫–≤–∏–∑–∞ –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ', 'info'); }
    editQuiz(id) { this.showMessage(`–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–≤–∏–∑–∞ ${id} –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ`, 'info'); }
    deleteQuiz(id) { 
        if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –∫–≤–∏–∑?')) {
            this.showMessage(`–£–¥–∞–ª–µ–Ω–∏–µ –∫–≤–∏–∑–∞ ${id} –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ`, 'info');
        }
    }

    showMarathonForm() { this.showMessage('–°–æ–∑–¥–∞–Ω–∏–µ –º–∞—Ä–∞—Ñ–æ–Ω–∞ –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ', 'info'); }
    editMarathon(id) { this.showMessage(`–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –º–∞—Ä–∞—Ñ–æ–Ω–∞ ${id} –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ`, 'info'); }
    deleteMarathon(id) { 
        if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –º–∞—Ä–∞—Ñ–æ–Ω?')) {
            this.showMessage(`–£–¥–∞–ª–µ–Ω–∏–µ –º–∞—Ä–∞—Ñ–æ–Ω–∞ ${id} –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ`, 'info');
        }
    }

    showInteractiveForm() { this.showMessage('–°–æ–∑–¥–∞–Ω–∏–µ –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–∞ –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ', 'info'); }
    editInteractive(id) { this.showMessage(`–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–∞ ${id} –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ`, 'info'); }
    deleteInteractive(id) { 
        if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤?')) {
            this.showMessage(`–£–¥–∞–ª–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–∞ ${id} –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ`, 'info');
        }
    }

    showShopItemForm() { this.showMessage('–°–æ–∑–¥–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞ –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ', 'info'); }
    editShopItem(id) { this.showMessage(`–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞ ${id} –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ`, 'info'); }
    deleteShopItem(id) { 
        if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —Ç–æ–≤–∞—Ä?')) {
            this.showMessage(`–£–¥–∞–ª–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞ ${id} –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ`, 'info');
        }
    }

    showPostForm() { this.showMessage('–°–æ–∑–¥–∞–Ω–∏–µ –ø–æ—Å—Ç–∞ –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ', 'info'); }
    editPost(id) { this.showMessage(`–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ—Å—Ç–∞ ${id} –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ`, 'info'); }
    deletePost(id) { 
        if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –ø–æ—Å—Ç?')) {
            this.showMessage(`–£–¥–∞–ª–µ–Ω–∏–µ –ø–æ—Å—Ç–∞ ${id} –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ`, 'info');
        }
    }

    showRoleForm() { this.showMessage('–°–æ–∑–¥–∞–Ω–∏–µ —Ä–æ–ª–∏ –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ', 'info'); }
    editRole(id) { this.showMessage(`–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–æ–ª–∏ ${id} –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ`, 'info'); }
    deleteRole(id) { 
        if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç—É —Ä–æ–ª—å?')) {
            this.showMessage(`–£–¥–∞–ª–µ–Ω–∏–µ —Ä–æ–ª–∏ ${id} –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ`, 'info');
        }
    }

    showCharacterForm() { this.showMessage('–°–æ–∑–¥–∞–Ω–∏–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ', 'info'); }
    editCharacter(id) { this.showMessage(`–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ ${id} –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ`, 'info'); }
    deleteCharacter(id) { 
        if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ–≥–æ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞?')) {
            this.showMessage(`–£–¥–∞–ª–µ–Ω–∏–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ ${id} –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ`, 'info');
        }
    }

    async moderateWork(workId, status) {
        try {
            const response = await fetch(`/api/admin/user-works/${workId}/moderate?userId=${this.userId}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ status })
            });

            if (response.ok) {
                this.showMessage(`–†–∞–±–æ—Ç–∞ ${status === 'approved' ? '–æ–¥–æ–±—Ä–µ–Ω–∞' : '–æ—Ç–∫–ª–æ–Ω–µ–Ω–∞'}`, 'success');
                this.loadSectionContent('moderation');
            } else {
                throw new Error('–û—à–∏–±–∫–∞ –º–æ–¥–µ—Ä–∞—Ü–∏–∏');
            }
        } catch (error) {
            this.showError('–û—à–∏–±–∫–∞ –º–æ–¥–µ—Ä–∞—Ü–∏–∏ —Ä–∞–±–æ—Ç—ã: ' + error.message);
        }
    }

    async moderateReview(reviewId, status) {
        try {
            const response = await fetch(`/api/admin/reviews/${reviewId}/moderate?userId=${this.userId}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ status })
            });

            if (response.ok) {
                this.showMessage(`–û—Ç–∑—ã–≤ ${status === 'approved' ? '–æ–¥–æ–±—Ä–µ–Ω' : '–æ—Ç–∫–ª–æ–Ω–µ–Ω'}`, 'success');
                this.loadSectionContent('moderation');
            } else {
                throw new Error('–û—à–∏–±–∫–∞ –º–æ–¥–µ—Ä–∞—Ü–∏–∏');
            }
        } catch (error) {
            this.showError('–û—à–∏–±–∫–∞ –º–æ–¥–µ—Ä–∞—Ü–∏–∏ –æ—Ç–∑—ã–≤–∞: ' + error.message);
        }
    }

    showAdminForm() { this.showMessage('–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ', 'info'); }

    async removeAdmin(userId) {
        if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ–≥–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞?')) {
            try {
                const response = await fetch(`/api/admin/admins/${userId}?userId=${this.userId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    this.showMessage('–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä —É–¥–∞–ª–µ–Ω', 'success');
                    this.loadSectionContent('admins');
                } else {
                    throw new Error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è');
                }
            } catch (error) {
                this.showError('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞: ' + error.message);
            }
        }
    }

    async saveSettings(event) {
        event.preventDefault();
        
        try {
            const formData = new FormData(event.target);
            const settings = [];
            
            for (let [key, value] of formData.entries()) {
                settings.push({ key, value });
            }

            const response = await fetch(`/api/admin/settings?userId=${this.userId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ settings })
            });

            if (response.ok) {
                this.showMessage('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã', 'success');
            } else {
                throw new Error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
            }
        } catch (error) {
            this.showError('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫: ' + error.message);
        }
    }
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏
let admin;
document.addEventListener('DOMContentLoaded', function() {
    admin = new AdminPanel();
});
