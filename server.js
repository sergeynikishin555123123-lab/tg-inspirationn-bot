import express from 'express';
import TelegramBot from 'node-telegram-bot-api';
import cors from 'cors';
import bodyParser from 'body-parser';
import { fileURLToPath } from 'url';
import { dirname, join } from 'path';
import { readdirSync, existsSync } from 'fs';
import dotenv from 'dotenv';

dotenv.config();

const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);

const app = express();

// –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø—É—Ç–∏ –¥–ª—è TimeWeb
const APP_ROOT = process.cwd();

console.log('üé® –ú–∞—Å—Ç–µ—Ä—Å–∫–∞—è –í–¥–æ—Ö–Ω–æ–≤–µ–Ω–∏—è - –ó–∞–ø—É—Å–∫ —Å–∏—Å—Ç–µ–º—ã...');
console.log('üìÅ –¢–µ–∫—É—â–∞—è —Ä–∞–±–æ—á–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è:', APP_ROOT);

// –†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è in-memory –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —Å –ø–æ–ª–Ω—ã–º –Ω–∞–±–æ—Ä–æ–º –¥–∞–Ω–Ω—ã—Ö
let db = {
    users: [
        {
            id: 1,
            user_id: 12345,
            tg_first_name: '–¢–µ—Å—Ç–æ–≤—ã–π –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å',
            tg_username: 'test_user',
            sparks: 145.5,
            level: '–ó–Ω–∞—Ç–æ–∫',
            is_registered: true,
            class: '–•—É–¥–æ–∂–Ω–∏–∫–∏',
            character_id: 1,
            character_name: '–õ—É–∫–∞ –¶–≤–µ—Ç–Ω–æ–π',
            available_buttons: ['quiz', 'marathon', 'works', 'activities', 'posts', 'shop', 'invite', 'interactives', 'change_role'],
            registration_date: new Date().toISOString(),
            last_active: new Date().toISOString(),
            total_activities: 23,
            completed_quizzes: 5,
            completed_marathons: 2,
            uploaded_works: 3
        },
        {
            id: 2,
            user_id: 898508164,
            tg_first_name: '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä',
            tg_username: 'admin',
            sparks: 1250.0,
            level: '–ú–∞—Å—Ç–µ—Ä',
            is_registered: true,
            class: '–•—É–¥–æ–∂–Ω–∏–∫–∏',
            character_id: 1,
            character_name: '–õ—É–∫–∞ –¶–≤–µ—Ç–Ω–æ–π',
            available_buttons: ['quiz', 'marathon', 'works', 'activities', 'posts', 'shop', 'invite', 'interactives', 'change_role'],
            registration_date: new Date().toISOString(),
            last_active: new Date().toISOString(),
            total_activities: 156,
            completed_quizzes: 12,
            completed_marathons: 8,
            uploaded_works: 15
        },
        {
            id: 3,
            user_id: 987654321,
            tg_first_name: '–ú–∞—Ä–∏—è –¢–≤–æ—Ä—á–µ—Å–∫–∞—è',
            tg_username: 'maria_art',
            sparks: 78.2,
            level: '–ò—Å–∫–∞—Ç–µ–ª—å',
            is_registered: true,
            class: '–°—Ç–∏–ª–∏—Å—Ç—ã',
            character_id: 3,
            character_name: '–≠—Å—Ç–µ–ª–ª–∞ –ú–æ–¥–µ',
            available_buttons: ['quiz', 'marathon', 'works', 'activities', 'posts', 'shop', 'invite', 'interactives', 'change_role'],
            registration_date: new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString(),
            last_active: new Date().toISOString(),
            total_activities: 12,
            completed_quizzes: 3,
            completed_marathons: 1,
            uploaded_works: 2
        },
        {
            id: 4,
            user_id: 456789123,
            tg_first_name: '–ê–ª–µ–∫—Å–µ–π –†–µ–º–µ—Å–ª–µ–Ω–Ω–∏–∫',
            tg_username: 'alex_craft',
            sparks: 210.7,
            level: '–ó–Ω–∞—Ç–æ–∫',
            is_registered: true,
            class: '–ú–∞—Å—Ç–µ—Ä–∞',
            character_id: 4,
            character_name: '–ê—Ä—Ç–µ–º –†–µ–∑—á–∏–∫',
            available_buttons: ['quiz', 'marathon', 'works', 'activities', 'posts', 'shop', 'invite', 'interactives', 'change_role'],
            registration_date: new Date(Date.now() - 14 * 24 * 60 * 60 * 1000).toISOString(),
            last_active: new Date(Date.now() - 2 * 24 * 60 * 60 * 1000).toISOString(),
            total_activities: 34,
            completed_quizzes: 8,
            completed_marathons: 3,
            uploaded_works: 7
        },
        {
            id: 5,
            user_id: 789123456,
            tg_first_name: '–°–æ—Ñ–∏—è –ò—Å—Ç–æ—Ä–∏–∫',
            tg_username: 'sofia_history',
            sparks: 89.1,
            level: '–ò—Å–∫–∞—Ç–µ–ª—å',
            is_registered: true,
            class: '–ò—Å—Ç–æ—Ä–∏–∫–∏',
            character_id: 5,
            character_name: '–°–æ—Ñ–∏—è –•—Ä–æ–Ω–∏–∫',
            available_buttons: ['quiz', 'marathon', 'works', 'activities', 'posts', 'shop', 'invite', 'interactives', 'change_role'],
            registration_date: new Date(Date.now() - 3 * 24 * 60 * 60 * 1000).toISOString(),
            last_active: new Date().toISOString(),
            total_activities: 8,
            completed_quizzes: 2,
            completed_marathons: 0,
            uploaded_works: 1
        }
    ],
    roles: [
        {
            id: 1,
            name: '–•—É–¥–æ–∂–Ω–∏–∫–∏',
            description: '–¢–≤–æ—Ä—Ü—ã –∏–∑–æ–±—Ä–∞–∑–∏—Ç–µ–ª—å–Ω–æ–≥–æ –∏—Å–∫—É—Å—Å—Ç–≤–∞. –°–æ–∑–¥–∞—é—Ç –∫–∞—Ä—Ç–∏–Ω—ã, –∏–ª–ª—é—Å—Ç—Ä–∞—Ü–∏–∏, —Ä–∞–±–æ—Ç–∞—é—Ç —Å —Ü–≤–µ—Ç–æ–º –∏ –∫–æ–º–ø–æ–∑–∏—Ü–∏–µ–π.',
            icon: 'üé®',
            available_buttons: ['quiz', 'marathon', 'works', 'activities', 'posts', 'shop', 'invite', 'interactives', 'change_role'],
            is_active: true,
            created_at: new Date().toISOString(),
            color: '#FF6B6B',
            requirements: '–õ—é–±–æ–≤—å –∫ –≤–∏–∑—É–∞–ª—å–Ω–æ–º—É –∏—Å–∫—É—Å—Å—Ç–≤—É'
        },
        {
            id: 2,
            name: '–°—Ç–∏–ª–∏—Å—Ç—ã',
            description: '–ú–∞—Å—Ç–µ—Ä–∞ —Å–æ–∑–¥–∞–Ω–∏—è –æ–±—Ä–∞–∑–æ–≤ –∏ —Å—Ç–∏–ª–µ–π. –†–∞–±–æ—Ç–∞—é—Ç —Å –º–æ–¥–æ–π, –≤–Ω–µ—à–Ω–æ—Å—Ç—å—é –∏ –≥–∞—Ä–¥–µ—Ä–æ–±–æ–º.',
            icon: 'üëó',
            available_buttons: ['quiz', 'marathon', 'works', 'activities', 'posts', 'shop', 'invite', 'interactives', 'change_role'],
            is_active: true,
            created_at: new Date().toISOString(),
            color: '#4ECDC4',
            requirements: '–ß—É–≤—Å—Ç–≤–æ —Å—Ç–∏–ª—è –∏ –≤–∫—É—Å–∞'
        },
        {
            id: 3,
            name: '–ú–∞—Å—Ç–µ—Ä–∞',
            description: '–†–µ–º–µ—Å–ª–µ–Ω–Ω–∏–∫–∏ –ø—Ä–∏–∫–ª–∞–¥–Ω–æ–≥–æ –∏—Å–∫—É—Å—Å—Ç–≤–∞. –°–æ–∑–¥–∞—é—Ç –∏–∑–¥–µ–ª–∏—è –∏–∑ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤.',
            icon: 'üßµ',
            available_buttons: ['quiz', 'marathon', 'works', 'activities', 'posts', 'shop', 'invite', 'interactives', 'change_role'],
            is_active: true,
            created_at: new Date().toISOString(),
            color: '#45B7D1',
            requirements: '–£–º–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞—Ç—å —Ä—É–∫–∞–º–∏'
        },
        {
            id: 4,
            name: '–ò—Å—Ç–æ—Ä–∏–∫–∏',
            description: '–ó–Ω–∞—Ç–æ–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏ –∏—Å–∫—É—Å—Å—Ç–≤ –∏ –∫—É–ª—å—Ç—É—Ä—ã. –ò–∑—É—á–∞—é—Ç –∏ –∞–Ω–∞–ª–∏–∑–∏—Ä—É—é—Ç —Ö—É–¥–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ —ç–ø–æ—Ö–∏.',
            icon: 'üèõÔ∏è',
            available_buttons: ['quiz', 'marathon', 'works', 'activities', 'posts', 'shop', 'invite', 'interactives', 'change_role'],
            is_active: true,
            created_at: new Date().toISOString(),
            color: '#96CEB4',
            requirements: '–ò–Ω—Ç–µ—Ä–µ—Å –∫ –∏—Å—Ç–æ—Ä–∏–∏ –∏ –∞–Ω–∞–ª–∏–∑—É'
        },
        {
            id: 5,
            name: '–§–æ—Ç–æ–≥—Ä–∞—Ñ—ã',
            description: '–ú–∞—Å—Ç–µ—Ä–∞ —Å–≤–µ—Ç–æ–ø–∏—Å–∏. –°–æ–∑–¥–∞—é—Ç —Ö—É–¥–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –≤ —Ä–∞–∑–Ω—ã—Ö –∂–∞–Ω—Ä–∞—Ö.',
            icon: 'üì∏',
            available_buttons: ['quiz', 'marathon', 'works', 'activities', 'posts', 'shop', 'invite', 'interactives', 'change_role'],
            is_active: true,
            created_at: new Date().toISOString(),
            color: '#FECA57',
            requirements: '–ù–∞–±–ª—é–¥–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∏ —Ç–µ—Ö–Ω–∏–∫–∞'
        },
        {
            id: 6,
            name: '–î–∏–∑–∞–π–Ω–µ—Ä—ã',
            description: '–°–æ–∑–¥–∞—Ç–µ–ª–∏ –≤–∏–∑—É–∞–ª—å–Ω—ã—Ö —Ä–µ—à–µ–Ω–∏–π. –†–∞–±–æ—Ç–∞—é—Ç —Å –≥—Ä–∞—Ñ–∏–∫–æ–π, –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞–º–∏ –∏ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ–º.',
            icon: 'üíª',
            available_buttons: ['quiz', 'marathon', 'works', 'activities', 'posts', 'shop', 'invite', 'interactives', 'change_role'],
            is_active: true,
            created_at: new Date().toISOString(),
            color: '#FF9FF3',
            requirements: '–ö—Ä–µ–∞—Ç–∏–≤–Ω–æ–µ –º—ã—à–ª–µ–Ω–∏–µ'
        }
    ],
    characters: [
        { 
            id: 1, 
            role_id: 1, 
            name: '–õ—É–∫–∞ –¶–≤–µ—Ç–Ω–æ–π', 
            description: '–≠–∫—Å–ø–µ—Ä—Ç –ø–æ —Ü–≤–µ—Ç—É –∏ –∫–æ–º–ø–æ–∑–∏—Ü–∏–∏. –ü–æ–º–æ–≥–∞–µ—Ç –ø–æ–Ω—è—Ç—å –≥–∞—Ä–º–æ–Ω–∏—é –æ—Ç—Ç–µ–Ω–∫–æ–≤ –∏ —Å–æ–∑–¥–∞–≤–∞—Ç—å –≤—ã—Ä–∞–∑–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–∞–±–æ—Ç—ã.', 
            bonus_type: 'percent_bonus', 
            bonus_value: '10',
            bonus_description: '+10% –∫ –∏—Å–∫—Ä–∞–º –∑–∞ –∫–≤–∏–∑—ã',
            is_active: true,
            created_at: new Date().toISOString(),
            avatar: 'üé®',
            personality: '–≠–Ω–µ—Ä–≥–∏—á–Ω—ã–π –∏ –≤–¥–æ—Ö–Ω–æ–≤–ª—è—é—â–∏–π'
        },
        { 
            id: 2, 
            role_id: 1, 
            name: '–ú–∞—Ä–∏–Ω–∞ –ö–∏—Å—Ç—å', 
            description: '–°—Ç—Ä–æ–≥–∞—è –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å–Ω–∏—Ü–∞ –∞–∫–∞–¥–µ–º–∏—á–µ—Å–∫–æ–π –∂–∏–≤–æ–ø–∏—Å–∏. –£—á–∏—Ç –æ—Å–Ω–æ–≤–∞–º –∏ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–º—É –º–∞—Å—Ç–µ—Ä—Å—Ç–≤—É.', 
            bonus_type: 'forgiveness', 
            bonus_value: '1',
            bonus_description: '1 –ø—Ä–æ—â–µ–Ω–∏–µ –æ—à–∏–±–∫–∏ –≤ –∫–≤–∏–∑–∞—Ö',
            is_active: true,
            created_at: new Date().toISOString(),
            avatar: 'üë©‚Äçüé®',
            personality: '–¢—Ä–µ–±–æ–≤–∞—Ç–µ–ª—å–Ω–∞—è –∏ –º—É–¥—Ä–∞—è'
        },
        { 
            id: 3, 
            role_id: 2, 
            name: '–≠—Å—Ç–µ–ª–ª–∞ –ú–æ–¥–µ', 
            description: '–ë—ã–≤—à–∏–π —Å—Ç–∏–ª–∏—Å—Ç –∑–Ω–∞–º–µ–Ω–∏—Ç–æ—Å—Ç–µ–π. –û–±—É—á–∞–µ—Ç —Å–æ–∑–¥–∞–Ω–∏—é –≥–∞—Ä–º–æ–Ω–∏—á–Ω—ã—Ö –æ–±—Ä–∞–∑–æ–≤ –∏ —Ä–∞–±–æ—Ç–µ —Å –¥–µ—Ç–∞–ª—è–º–∏.', 
            bonus_type: 'percent_bonus', 
            bonus_value: '5',
            bonus_description: '+5% –∫ –∏—Å–∫—Ä–∞–º –∑–∞ –≤—Å–µ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏',
            is_active: true,
            created_at: new Date().toISOString(),
            avatar: 'üëó',
            personality: '–≠–ª–µ–≥–∞–Ω—Ç–Ω–∞—è –∏ –≤–Ω–∏–º–∞—Ç–µ–ª—å–Ω–∞—è'
        },
        { 
            id: 4, 
            role_id: 3, 
            name: '–ê—Ä—Ç–µ–º –†–µ–∑—á–∏–∫', 
            description: '–ú–∞—Å—Ç–µ—Ä –ø–æ –¥–µ—Ä–µ–≤—É –∏ –∫–µ—Ä–∞–º–∏–∫–µ —Å 20-–ª–µ—Ç–Ω–∏–º –æ–ø—ã—Ç–æ–º. –£—á–∏—Ç —Ç–µ—Ä–ø–µ–Ω–∏—é –∏ —Ä–∞–±–æ—Ç–µ —Å –º–∞—Ç–µ—Ä–∏–∞–ª–æ–º.', 
            bonus_type: 'random_gift', 
            bonus_value: '1-3',
            bonus_description: '–°–ª—É—á–∞–π–Ω—ã–π –ø–æ–¥–∞—Ä–æ–∫ –∫–∞–∂–¥—É—é –Ω–µ–¥–µ–ª—é',
            is_active: true,
            created_at: new Date().toISOString(),
            avatar: 'üî®',
            personality: '–°–ø–æ–∫–æ–π–Ω—ã–π –∏ –º–µ—Ç–æ–¥–∏—á–Ω—ã–π'
        },
        { 
            id: 5, 
            role_id: 4, 
            name: '–°–æ—Ñ–∏—è –•—Ä–æ–Ω–∏–∫', 
            description: '–ò—Å–∫—É—Å—Å—Ç–≤–æ–≤–µ–¥ –∏ –∏—Å—Ç–æ—Ä–∏–∫ –∫—É–ª—å—Ç—É—Ä—ã. –ó–Ω–∞–µ—Ç –≤—Å–µ –æ —Ö—É–¥–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö —ç–ø–æ—Ö–∞—Ö –∏ —Å—Ç–∏–ª—è—Ö.', 
            bonus_type: 'secret_advice', 
            bonus_value: '2weeks',
            bonus_description: '–°–µ–∫—Ä–µ—Ç–Ω—ã–µ —Å–æ–≤–µ—Ç—ã –∫–∞–∂–¥—ã–µ 2 –Ω–µ–¥–µ–ª–∏',
            is_active: true,
            created_at: new Date().toISOString(),
            avatar: 'üìö',
            personality: '–≠—Ä—É–¥–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –∏ —â–µ–¥—Ä–∞—è'
        },
        { 
            id: 6, 
            role_id: 5, 
            name: '–í–∏–∫—Ç–æ—Ä –û–±—ä–µ–∫—Ç–∏–≤', 
            description: '–§–æ—Ç–æ–≥—Ä–∞—Ñ-–ø—É—Ç–µ—à–µ—Å—Ç–≤–µ–Ω–Ω–∏–∫. –°–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è –Ω–∞ –ø–µ–π–∑–∞–∂–Ω–æ–π –∏ —É–ª–∏—á–Ω–æ–π —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏.', 
            bonus_type: 'percent_bonus', 
            bonus_value: '8',
            bonus_description: '+8% –∫ –∏—Å–∫—Ä–∞–º –∑–∞ —Ä–∞–±–æ—Ç—ã',
            is_active: true,
            created_at: new Date().toISOString(),
            avatar: 'üì∑',
            personality: '–ê–≤–∞–Ω—Ç—é—Ä–Ω—ã–π –∏ –Ω–∞–±–ª—é–¥–∞—Ç–µ–ª—å–Ω—ã–π'
        },
        { 
            id: 7, 
            role_id: 6, 
            name: '–ö–∏—Ä–∏–ª–ª –ü–∏–∫—Å–µ–ª—å', 
            description: '–î–∏–∑–∞–π–Ω–µ—Ä —Ü–∏—Ñ—Ä–æ–≤—ã—Ö –ø—Ä–æ–¥—É–∫—Ç–æ–≤. –≠–∫—Å–ø–µ—Ä—Ç –ø–æ UX/UI –∏ –±—Ä–µ–Ω–¥–∏–Ω–≥—É.', 
            bonus_type: 'forgiveness', 
            bonus_value: '2',
            bonus_description: '2 –ø—Ä–æ—â–µ–Ω–∏—è –æ—à–∏–±–æ–∫ –≤ –º–µ—Å—è—Ü',
            is_active: true,
            created_at: new Date().toISOString(),
            avatar: 'üíª',
            personality: '–ò–Ω–Ω–æ–≤–∞—Ü–∏–æ–Ω–Ω—ã–π –∏ –ø—Ä–∞–∫—Ç–∏—á–Ω—ã–π'
        }
    ],
    quizzes: [
        {
            id: 1,
            title: "üé® –û—Å–Ω–æ–≤—ã –∂–∏–≤–æ–ø–∏—Å–∏",
            description: "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–≤–æ–∏ –∑–Ω–∞–Ω–∏—è –æ—Å–Ω–æ–≤ –∂–∏–≤–æ–ø–∏—Å–∏: —Ü–≤–µ—Ç–∞, –∫–æ–º–ø–æ–∑–∏—Ü–∏—è, —Ç–µ—Ö–Ω–∏–∫–∏",
            questions: [
                {
                    id: 1,
                    question: "–ö—Ç–æ –Ω–∞–ø–∏—Å–∞–ª –∑–Ω–∞–º–µ–Ω–∏—Ç—É—é –∫–∞—Ä—Ç–∏–Ω—É '–ú–æ–Ω–∞ –õ–∏–∑–∞'?",
                    options: ["–í–∏–Ω—Å–µ–Ω—Ç –í–∞–Ω –ì–æ–≥", "–õ–µ–æ–Ω–∞—Ä–¥–æ –¥–∞ –í–∏–Ω—á–∏", "–ü–∞–±–ª–æ –ü–∏–∫–∞—Å—Å–æ", "–ö–ª–æ–¥ –ú–æ–Ω–µ"],
                    correctAnswer: 1,
                    explanation: "–ú–æ–Ω–∞ –õ–∏–∑–∞ –±—ã–ª–∞ –Ω–∞–ø–∏—Å–∞–Ω–∞ –õ–µ–æ–Ω–∞—Ä–¥–æ –¥–∞ –í–∏–Ω—á–∏ –≤ –ø–µ—Ä–∏–æ–¥ 1503-1506 –≥–æ–¥–æ–≤."
                },
                {
                    id: 2,
                    question: "–ö–∞–∫–∏–µ —Ç—Ä–∏ —Ü–≤–µ—Ç–∞ —è–≤–ª—è—é—Ç—Å—è –æ—Å–Ω–æ–≤–Ω—ã–º–∏ –≤ –∂–∏–≤–æ–ø–∏—Å–∏?",
                    options: ["–ö—Ä–∞—Å–Ω—ã–π, —Å–∏–Ω–∏–π, –∑–µ–ª–µ–Ω—ã–π", "–ö—Ä–∞—Å–Ω—ã–π, –∂–µ–ª—Ç—ã–π, —Å–∏–Ω–∏–π", "–§–∏–æ–ª–µ—Ç–æ–≤—ã–π, –æ—Ä–∞–Ω–∂–µ–≤—ã–π, –∑–µ–ª–µ–Ω—ã–π", "–ß–µ—Ä–Ω—ã–π, –±–µ–ª—ã–π, —Å–µ—Ä—ã–π"],
                    correctAnswer: 1,
                    explanation: "–û—Å–Ω–æ–≤–Ω—ã–µ —Ü–≤–µ—Ç–∞ - –∫—Ä–∞—Å–Ω—ã–π, –∂–µ–ª—Ç—ã–π –∏ —Å–∏–Ω–∏–π. –ò–∑ –Ω–∏—Ö –º–æ–∂–Ω–æ –ø–æ–ª—É—á–∏—Ç—å –≤—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Ü–≤–µ—Ç–∞."
                },
                {
                    id: 3,
                    question: "–ß—Ç–æ —Ç–∞–∫–æ–µ –∫–æ–º–ø–æ–∑–∏—Ü–∏—è –≤ –∂–∏–≤–æ–ø–∏—Å–∏?",
                    options: ["–†–∞–∑–º–µ—Ä –∫–∞—Ä—Ç–∏–Ω—ã", "–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –Ω–∞ –∫–∞—Ä—Ç–∏–Ω–µ", "–ù–∞–∑–≤–∞–Ω–∏–µ –∫–∞—Ä—Ç–∏–Ω—ã", "–¢–µ—Ö–Ω–∏–∫–∞ –Ω–∞–Ω–µ—Å–µ–Ω–∏—è –∫—Ä–∞—Å–∫–∏"],
                    correctAnswer: 1,
                    explanation: "–ö–æ–º–ø–æ–∑–∏—Ü–∏—è - —ç—Ç–æ –≥–∞—Ä–º–æ–Ω–∏—á–Ω–æ–µ —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –∏—Å–∫—É—Å—Å—Ç–≤–∞."
                },
                {
                    id: 4,
                    question: "–ö–∞–∫–∞—è —Ç–µ—Ö–Ω–∏–∫–∞ –∂–∏–≤–æ–ø–∏—Å–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –≤–æ–¥–æ—Ä–∞—Å—Ç–≤–æ—Ä–∏–º—ã–µ –∫—Ä–∞—Å–∫–∏?",
                    options: ["–ú–∞—Å–ª—è–Ω–∞—è –∂–∏–≤–æ–ø–∏—Å—å", "–ê–∫–≤–∞—Ä–µ–ª—å", "–ê–∫—Ä–∏–ª", "–¢–µ–º–ø–µ—Ä–∞"],
                    correctAnswer: 1,
                    explanation: "–ê–∫–≤–∞—Ä–µ–ª—å - —ç—Ç–æ —Ç–µ—Ö–Ω–∏–∫–∞ –∂–∏–≤–æ–ø–∏—Å–∏ –≤–æ–¥–æ—Ä–∞—Å—Ç–≤–æ—Ä–∏–º—ã–º–∏ –∫—Ä–∞—Å–∫–∞–º–∏ –Ω–∞ –±—É–º–∞–≥–µ."
                },
                {
                    id: 5,
                    question: "–ß—Ç–æ —Ç–∞–∫–æ–µ '—Å–≤–µ—Ç–æ—Ç–µ–Ω—å' –≤ –∂–∏–≤–æ–ø–∏—Å–∏?",
                    options: ["–ù–∞–∑–≤–∞–Ω–∏–µ –∫–∞—Ä—Ç–∏–Ω—ã", "–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å–≤–µ—Ç–∞ –∏ —Ç–µ–Ω–∏", "–¢–∏–ø –∫–∏—Å—Ç–∏", "–°—Ç–∏–ª—å –∂–∏–≤–æ–ø–∏—Å–∏"],
                    correctAnswer: 1,
                    explanation: "–°–≤–µ—Ç–æ—Ç–µ–Ω—å - —ç—Ç–æ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å–≤–µ—Ç–ª—ã—Ö –∏ —Ç–µ–º–Ω—ã—Ö —É—á–∞—Å—Ç–∫–æ–≤ –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–∏."
                }
            ],
            sparks_per_correct: 2,
            sparks_perfect_bonus: 10,
            cooldown_hours: 24,
            allow_retake: true,
            is_active: true,
            difficulty: 'beginner',
            category: 'painting',
            duration_minutes: 10,
            created_at: new Date().toISOString(),
            attempts_count: 156,
            average_score: 3.8
        },
        {
            id: 2,
            title: "üëó –ò—Å—Ç–æ—Ä–∏—è –º–æ–¥—ã –∏ —Å—Ç–∏–ª—è",
            description: "–£–∑–Ω–∞–π—Ç–µ –æ –∫–ª—é—á–µ–≤—ã—Ö –º–æ–º–µ–Ω—Ç–∞—Ö –≤ –∏—Å—Ç–æ—Ä–∏–∏ –º–æ–¥—ã –∏ —Å–æ–∑–¥–∞–Ω–∏—è —Å—Ç–∏–ª—è",
            questions: [
                {
                    id: 1,
                    question: "–í –∫–∞–∫–æ–º –≤–µ–∫–µ –ø–æ—è–≤–∏–ª–æ—Å—å –ø–æ–Ω—è—Ç–∏–µ '–≤—ã—Å–æ–∫–∞—è –º–æ–¥–∞' (Haute Couture)?",
                    options: ["XVIII –≤–µ–∫", "XIX –≤–µ–∫", "XX –≤–µ–∫", "XXI –≤–µ–∫"],
                    correctAnswer: 1,
                    explanation: "–ü–æ–Ω—è—Ç–∏–µ –≤—ã—Å–æ–∫–æ–π –º–æ–¥—ã –ø–æ—è–≤–∏–ª–æ—Å—å –≤ XIX –≤–µ–∫–µ –≤ –ü–∞—Ä–∏–∂–µ."
                },
                {
                    id: 2,
                    question: "–ö—Ç–æ —Å—á–∏—Ç–∞–µ—Ç—Å—è –æ—Å–Ω–æ–≤–∞—Ç–µ–ª–µ–º –¥–æ–º–∞ –º–æ–¥—ã Chanel?",
                    options: ["–ö–æ–∫–æ –®–∞–Ω–µ–ª—å", "–ö—Ä–∏—Å—Ç–∏–∞–Ω –î–∏–æ—Ä", "–ò–≤ –°–µ–Ω-–õ–æ—Ä–∞–Ω", "–ñ–∏–≤–∞–Ω—à–∏"],
                    correctAnswer: 0,
                    explanation: "–ö–æ–∫–æ –®–∞–Ω–µ–ª—å –æ—Å–Ω–æ–≤–∞–ª–∞ –¥–æ–º –º–æ–¥—ã Chanel –≤ 1909 –≥–æ–¥—É."
                },
                {
                    id: 3,
                    question: "–ß—Ç–æ —Ç–∞–∫–æ–µ '—Ç–æ—Ç–∞–ª –ª—É–∫' –≤ —Å—Ç–∏–ª–∏—Å—Ç–∏–∫–µ?",
                    options: ["–ü–æ–ª–Ω—ã–π –æ–±—Ä–∞–∑ –≤ –æ–¥–Ω–æ–º —Ü–≤–µ—Ç–µ", "–î–æ—Ä–æ–≥–æ–π –Ω–∞—Ä—è–¥", "–í–∏–Ω—Ç–∞–∂–Ω—ã–π —Å—Ç–∏–ª—å", "–°–ø–æ—Ä—Ç–∏–≤–Ω—ã–π –∫–æ—Å—Ç—é–º"],
                    correctAnswer: 0,
                    explanation: "–¢–æ—Ç–∞–ª –ª—É–∫ - —ç—Ç–æ –æ–±—Ä–∞–∑, –ø–æ–ª–Ω–æ—Å—Ç—å—é –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–π –≤ –æ–¥–Ω–æ–º —Ü–≤–µ—Ç–µ."
                },
                {
                    id: 4,
                    question: "–ö–∞–∫–æ–π –∞–∫—Å–µ—Å—Å—É–∞—Ä —Å—Ç–∞–ª —Å–∏–º–≤–æ–ª–æ–º —Å—Ç–∏–ª—è –û–¥—Ä–∏ –•–µ–ø–±–µ—Ä–Ω?",
                    options: ["–®–ª—è–ø–∞", "–ü–µ—Ä—á–∞—Ç–∫–∏", "–û—á–∫–∏", "–®–∞—Ä—Ñ"],
                    correctAnswer: 2,
                    explanation: "–û—á–∫–∏-—Å—Ç—Ä–µ–ª–∫–∏ —Å—Ç–∞–ª–∏ –≤–∏–∑–∏—Ç–Ω–æ–π –∫–∞—Ä—Ç–æ—á–∫–æ–π —Å—Ç–∏–ª—è –û–¥—Ä–∏ –•–µ–ø–±–µ—Ä–Ω."
                },
                {
                    id: 5,
                    question: "–ß—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç —Ç–µ—Ä–º–∏–Ω '–∫–∞–ø—Å—É–ª—å–Ω—ã–π –≥–∞—Ä–¥–µ—Ä–æ–±'?",
                    options: ["–ì–∞—Ä–¥–µ—Ä–æ–± –¥–ª—è –ø—É—Ç–µ—à–µ—Å—Ç–≤–∏–π", "–ú–∏–Ω–∏–º–∞–ª–∏—Å—Ç–∏—á–Ω—ã–π –Ω–∞–±–æ—Ä —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ–π –æ–¥–µ–∂–¥—ã", "–°–ø–æ—Ä—Ç–∏–≤–Ω–∞—è –æ–¥–µ–∂–¥–∞", "–í–µ—Ä—Ö–Ω—è—è –æ–¥–µ–∂–¥–∞"],
                    correctAnswer: 1,
                    explanation: "–ö–∞–ø—Å—É–ª—å–Ω—ã–π –≥–∞—Ä–¥–µ—Ä–æ–± - —ç—Ç–æ –º–∏–Ω–∏–º–∞–ª–∏—Å—Ç–∏—á–Ω—ã–π –Ω–∞–±–æ—Ä –≤–µ—â–µ–π, –∫–æ—Ç–æ—Ä—ã–µ –ª–µ–≥–∫–æ –∫–æ–º–±–∏–Ω–∏—Ä—É—é—Ç—Å—è."
                }
            ],
            sparks_per_correct: 2,
            sparks_perfect_bonus: 10,
            cooldown_hours: 24,
            allow_retake: true,
            is_active: true,
            difficulty: 'intermediate',
            category: 'fashion',
            duration_minutes: 8,
            created_at: new Date().toISOString(),
            attempts_count: 89,
            average_score: 3.2
        },
        {
            id: 3,
            title: "üèõÔ∏è –ò—Å–∫—É—Å—Å—Ç–≤–æ —ç–ø–æ—Ö–∏ –í–æ–∑—Ä–æ–∂–¥–µ–Ω–∏—è",
            description: "–ü–æ–≥—Ä—É–∑–∏—Ç–µ—Å—å –≤ –º–∏—Ä –≤–µ–ª–∏–∫–∏—Ö –º–∞—Å—Ç–µ—Ä–æ–≤ –†–µ–Ω–µ—Å—Å–∞–Ω—Å–∞ –∏ –∏—Ö —à–µ–¥–µ–≤—Ä–æ–≤",
            questions: [
                {
                    id: 1,
                    question: "–í –∫–∞–∫–æ–º –≥–æ—Ä–æ–¥–µ –Ω–∞—á–∞–ª–æ—Å—å –∏—Ç–∞–ª—å—è–Ω—Å–∫–æ–µ –í–æ–∑—Ä–æ–∂–¥–µ–Ω–∏–µ?",
                    options: ["–†–∏–º", "–í–µ–Ω–µ—Ü–∏—è", "–§–ª–æ—Ä–µ–Ω—Ü–∏—è", "–ú–∏–ª–∞–Ω"],
                    correctAnswer: 2,
                    explanation: "–ò—Ç–∞–ª—å—è–Ω—Å–∫–æ–µ –í–æ–∑—Ä–æ–∂–¥–µ–Ω–∏–µ –Ω–∞—á–∞–ª–æ—Å—å –≤–æ –§–ª–æ—Ä–µ–Ω—Ü–∏–∏ –≤ XIV –≤–µ–∫–µ."
                },
                {
                    id: 2,
                    question: "–ö—Ç–æ —Ä–∞—Å–ø–∏—Å–∞–ª –ø–æ—Ç–æ–ª–æ–∫ –°–∏–∫—Å—Ç–∏–Ω—Å–∫–æ–π –∫–∞–ø–µ–ª–ª—ã?",
                    options: ["–õ–µ–æ–Ω–∞—Ä–¥–æ –¥–∞ –í–∏–Ω—á–∏", "–†–∞—Ñ–∞—ç–ª—å", "–ú–∏–∫–µ–ª–∞–Ω–¥–∂–µ–ª–æ", "–ë–æ—Ç—Ç–∏—á–µ–ª–ª–∏"],
                    correctAnswer: 2,
                    explanation: "–ú–∏–∫–µ–ª–∞–Ω–¥–∂–µ–ª–æ —Ä–∞—Å–ø–∏—Å–∞–ª –ø–æ—Ç–æ–ª–æ–∫ –°–∏–∫—Å—Ç–∏–Ω—Å–∫–æ–π –∫–∞–ø–µ–ª–ª—ã –≤ 1508-1512 –≥–æ–¥–∞—Ö."
                },
                {
                    id: 3,
                    question: "–ö–∞–∫–∞—è –∫–∞—Ä—Ç–∏–Ω–∞ –õ–µ–æ–Ω–∞—Ä–¥–æ –¥–∞ –í–∏–Ω—á–∏ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ –õ—É–≤—Ä–µ?",
                    options: ["–¢–∞–π–Ω–∞—è –≤–µ—á–µ—Ä—è", "–ú–æ–Ω–∞ –õ–∏–∑–∞", "–í–∏—Ç—Ä—É–≤–∏–∞–Ω—Å–∫–∏–π —á–µ–ª–æ–≤–µ–∫", "–î–∞–º–∞ —Å –≥–æ—Ä–Ω–æ—Å—Ç–∞–µ–º"],
                    correctAnswer: 1,
                    explanation: "–ú–æ–Ω–∞ –õ–∏–∑–∞ (–î–∂–æ–∫–æ–Ω–¥–∞) –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ –õ—É–≤—Ä–µ —Å 1797 –≥–æ–¥–∞."
                },
                {
                    id: 4,
                    question: "–ß—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç —Ç–µ—Ä–º–∏–Ω '—Å—Ñ—É–º–∞—Ç–æ'?",
                    options: ["–¢–µ—Ö–Ω–∏–∫–∞ —Ä–µ–∑—å–±—ã", "–°—Ç–∏–ª—å –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã", "–ñ–∏–≤–æ–ø–∏—Å–Ω–∞—è —Ç–µ—Ö–Ω–∏–∫–∞", "–ú—É–∑—ã–∫–∞–ª—å–Ω—ã–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç"],
                    correctAnswer: 2,
                    explanation: "–°—Ñ—É–º–∞—Ç–æ - —Ç–µ—Ö–Ω–∏–∫–∞ –º—è–≥–∫–∏—Ö –ø–µ—Ä–µ—Ö–æ–¥–æ–≤ –º–µ–∂–¥—É —Ü–≤–µ—Ç–∞–º–∏ –∏ —Ç–æ–Ω–∞–º–∏."
                },
                {
                    id: 5,
                    question: "–ö—Ç–æ –±—ã–ª —É—á–∏—Ç–µ–ª–µ–º –õ–µ–æ–Ω–∞—Ä–¥–æ –¥–∞ –í–∏–Ω—á–∏?",
                    options: ["–ú–∏–∫–µ–ª–∞–Ω–¥–∂–µ–ª–æ", "–í–µ—Ä—Ä–æ–∫–∫—å–æ", "–ë–æ—Ç—Ç–∏—á–µ–ª–ª–∏", "–î–æ–Ω–∞—Ç–µ–ª–ª–æ"],
                    correctAnswer: 1,
                    explanation: "–ê–Ω–¥—Ä–µ–∞ –¥–µ–ª—å –í–µ—Ä—Ä–æ–∫–∫—å–æ –±—ã–ª —É—á–∏—Ç–µ–ª–µ–º –õ–µ–æ–Ω–∞—Ä–¥–æ –¥–∞ –í–∏–Ω—á–∏."
                }
            ],
            sparks_per_correct: 3,
            sparks_perfect_bonus: 15,
            cooldown_hours: 48,
            allow_retake: true,
            is_active: true,
            difficulty: 'advanced',
            category: 'art_history',
            duration_minutes: 12,
            created_at: new Date().toISOString(),
            attempts_count: 67,
            average_score: 3.1
        }
    ],
    marathons: [
        {
            id: 1,
            title: "üèÉ‚Äç‚ôÇÔ∏è –ú–∞—Ä–∞—Ñ–æ–Ω –∞–∫–≤–∞—Ä–µ–ª–∏ –¥–ª—è –Ω–∞—á–∏–Ω–∞—é—â–∏—Ö",
            description: "7-–¥–Ω–µ–≤–Ω—ã–π –∏–Ω—Ç–µ–Ω—Å–∏–≤ –ø–æ –æ—Å–Ω–æ–≤–∞–º –∞–∫–≤–∞—Ä–µ–ª—å–Ω–æ–π –∂–∏–≤–æ–ø–∏—Å–∏. –ù–∞—É—á–∏—Ç–µ—Å—å —Ä–∞–±–æ—Ç–∞—Ç—å —Å —Ü–≤–µ—Ç–æ–º –∏ –≤–æ–¥–æ–π.",
            duration_days: 7,
            tasks: [
                { 
                    day: 1, 
                    title: "–û—Å–Ω–æ–≤–Ω—ã–µ —Ç–µ—Ö–Ω–∏–∫–∏ –∞–∫–≤–∞—Ä–µ–ª–∏", 
                    description: "–ò–∑—É—á–∏—Ç–µ –æ—Å–Ω–æ–≤–Ω—ã–µ —Ç–µ—Ö–Ω–∏–∫–∏ —Ä–∞–±–æ—Ç—ã —Å –∞–∫–≤–∞—Ä–µ–ª—å—é: –∑–∞–ª–∏–≤–∫–∞, –ª–µ—Å—Å–∏—Ä–æ–≤–∫–∞, —Ä–∞–±–æ—Ç–∞ –ø–æ-–º–æ–∫—Ä–æ–º—É",
                    requires_submission: true,
                    submission_type: "image",
                    instructions: "–°–æ–∑–¥–∞–π—Ç–µ –Ω–µ–±–æ–ª—å—à—É—é —Ä–∞–±–æ—Ç—É, –¥–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä—É—é—â—É—é —Ç—Ä–∏ –æ—Å–Ω–æ–≤–Ω—ã–µ —Ç–µ—Ö–Ω–∏–∫–∏ –∞–∫–≤–∞—Ä–µ–ª–∏",
                    tips: ["–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—É—é –±—É–º–∞–≥—É", "–≠–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ —Å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –≤–æ–¥—ã", "–ù–µ –±–æ–π—Ç–µ—Å—å –æ—à–∏–±–æ–∫"]
                },
                { 
                    day: 2, 
                    title: "–¶–≤–µ—Ç–æ–≤–æ–π –∫—Ä—É–≥ –∏ —Å–º–µ—à–∏–≤–∞–Ω–∏–µ", 
                    description: "–û—Å–≤–æ–π—Ç–µ —Å–æ–∑–¥–∞–Ω–∏–µ —Ü–≤–µ—Ç–æ–≤–æ–≥–æ –∫—Ä—É–≥–∞ –∏ –ø—Ä–∏–Ω—Ü–∏–ø—ã —Å–º–µ—à–∏–≤–∞–Ω–∏—è —Ü–≤–µ—Ç–æ–≤",
                    requires_submission: true,
                    submission_type: "image",
                    instructions: "–°–æ–∑–¥–∞–π—Ç–µ —Ü–≤–µ—Ç–æ–≤–æ–π –∫—Ä—É–≥ –∏–∑ 12 —Ü–≤–µ—Ç–æ–≤",
                    tips: ["–ù–∞—á–Ω–∏—Ç–µ —Å –æ—Å–Ω–æ–≤–Ω—ã—Ö —Ü–≤–µ—Ç–æ–≤", "–î–æ–±–∞–≤–ª—è–π—Ç–µ —Ü–≤–µ—Ç–∞ –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ", "–°–ª–µ–¥–∏—Ç–µ –∑–∞ —á–∏—Å—Ç–æ—Ç–æ–π –∫–∏—Å—Ç–µ–π"]
                },
                { 
                    day: 3, 
                    title: "–†–∞–±–æ—Ç–∞ —Å —Ç–æ–Ω–æ–º", 
                    description: "–ù–∞—É—á–∏—Ç–µ—Å—å —Å–æ–∑–¥–∞–≤–∞—Ç—å —Ç–æ–Ω–∞–ª—å–Ω—ã–µ –≥—Ä–∞–¥–∞—Ü–∏–∏ –æ—Ç —Å–≤–µ—Ç–ª–æ–≥–æ –∫ —Ç–µ–º–Ω–æ–º—É",
                    requires_submission: true,
                    submission_type: "image",
                    instructions: "–°–æ–∑–¥–∞–π—Ç–µ —Ç–æ–Ω–∞–ª—å–Ω—É—é —à–∫–∞–ª—É –∏–∑ 10 –≥—Ä–∞–¥–∞—Ü–∏–π –æ–¥–Ω–æ–≥–æ —Ü–≤–µ—Ç–∞",
                    tips: ["–ù–∞—á–∏–Ω–∞–π—Ç–µ —Å —Å–≤–µ—Ç–ª—ã—Ö —Ç–æ–Ω–æ–≤", "–î–∞–≤–∞–π—Ç–µ —Å–ª–æ—è–º –≤—ã—Å–æ—Ö–Ω—É—Ç—å", "–ü—Ä–∞–∫—Ç–∏–∫—É–π—Ç–µ –∫–æ–Ω—Ç—Ä–æ–ª—å –Ω–∞–¥ –Ω–∞—Å—ã—â–µ–Ω–Ω–æ—Å—Ç—å—é"]
                },
                { 
                    day: 4, 
                    title: "–ü—Ä–æ—Å—Ç–æ–π –ø–µ–π–∑–∞–∂", 
                    description: "–°–æ–∑–¥–∞–π—Ç–µ —Å–≤–æ–π –ø–µ—Ä–≤—ã–π –∞–∫–≤–∞—Ä–µ–ª—å–Ω—ã–π –ø–µ–π–∑–∞–∂ —Å –Ω–µ–±–æ–º –∏ –∑–µ–º–ª–µ–π",
                    requires_submission: true,
                    submission_type: "image",
                    instructions: "–ù–∞—Ä–∏—Å—É–π—Ç–µ –ø—Ä–æ—Å—Ç–æ–π –ø–µ–π–∑–∞–∂ —Å –Ω–µ–±–æ–º, –≥–æ—Ä–∞–º–∏/–¥–µ—Ä–µ–≤—å—è–º–∏ –∏ –ø–µ—Ä–µ–¥–Ω–∏–º –ø–ª–∞–Ω–æ–º",
                    tips: ["–†–∞–±–æ—Ç–∞–π—Ç–µ –æ—Ç –æ–±—â–µ–≥–æ –∫ —á–∞—Å—Ç–Ω–æ–º—É", "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ç–µ—Ö–Ω–∏–∫—É –ø–æ-–º–æ–∫—Ä–æ–º—É –¥–ª—è –Ω–µ–±–∞", "–°–æ—Ö—Ä–∞–Ω—è–π—Ç–µ —Å–≤–µ–∂–µ—Å—Ç—å –∫—Ä–∞—Å–æ–∫"]
                },
                { 
                    day: 5, 
                    title: "–ë–æ—Ç–∞–Ω–∏—á–µ—Å–∫–∞—è –∏–ª–ª—é—Å—Ç—Ä–∞—Ü–∏—è", 
                    description: "–ù–∞—É—á–∏—Ç–µ—Å—å —Ä–∏—Å–æ–≤–∞—Ç—å —Ä–∞—Å—Ç–µ–Ω–∏—è –∏ —Ü–≤–µ—Ç—ã –∞–∫–≤–∞—Ä–µ–ª—å—é",
                    requires_submission: true,
                    submission_type: "image",
                    instructions: "–í—ã–±–µ—Ä–∏—Ç–µ —Ü–≤–µ—Ç–æ–∫ –∏–ª–∏ —Ä–∞—Å—Ç–µ–Ω–∏–µ –∏ —Å–æ–∑–¥–∞–π—Ç–µ –µ–≥–æ –∞–∫–≤–∞—Ä–µ–ª—å–Ω—É—é –∏–ª–ª—é—Å—Ç—Ä–∞—Ü–∏—é",
                    tips: ["–í–Ω–∏–º–∞—Ç–µ–ª—å–Ω–æ –∏–∑—É—á–∞–π—Ç–µ —Ñ–æ—Ä–º—É", "–ù–∞—á–∏–Ω–∞–π—Ç–µ —Å –ª–µ–≥–∫–æ–≥–æ –∫–∞—Ä–∞–Ω–¥–∞—à–Ω–æ–≥–æ –Ω–∞–±—Ä–æ—Å–∫–∞", "–ü–µ—Ä–µ–¥–∞–≤–∞–π—Ç–µ —Ç–µ–∫—Å—Ç—É—Ä—É –ª–µ–ø–µ—Å—Ç–∫–æ–≤"]
                },
                { 
                    day: 6, 
                    title: "–ì–æ—Ä–æ–¥—Å–∫–æ–π —Å–∫–µ—Ç—á–∏–Ω–≥", 
                    description: "–û—Å–≤–æ–π—Ç–µ —Ç–µ—Ö–Ω–∏–∫—É –±—ã—Å—Ç—Ä—ã—Ö –≥–æ—Ä–æ–¥—Å–∫–∏—Ö –∑–∞—Ä–∏—Å–æ–≤–æ–∫ –∞–∫–≤–∞—Ä–µ–ª—å—é",
                    requires_submission: true,
                    submission_type: "image",
                    instructions: "–°–æ–∑–¥–∞–π—Ç–µ —Å–∫–µ—Ç—á –≥–æ—Ä–æ–¥—Å–∫–æ–≥–æ –ø–µ–π–∑–∞–∂–∞ –∏–ª–∏ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–æ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞",
                    tips: ["–ù–µ —Å—Ç—Ä–µ–º–∏—Ç–µ—Å—å –∫ –∏–¥–µ–∞–ª—å–Ω–æ–π —Ç–æ—á–Ω–æ—Å—Ç–∏", "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –≤—ã—Ä–∞–∑–∏—Ç–µ–ª—å–Ω—ã–µ –ª–∏–Ω–∏–∏", "–î–æ–±–∞–≤—å—Ç–µ –Ω–µ–º–Ω–æ–≥–æ —Ü–≤–µ—Ç–∞"]
                },
                { 
                    day: 7, 
                    title: "–§–∏–Ω–∞–ª—å–Ω–∞—è —Ä–∞–±–æ—Ç–∞", 
                    description: "–°–æ–∑–¥–∞–π—Ç–µ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—É—é –∞–∫–≤–∞—Ä–µ–ª—å–Ω—É—é —Ä–∞–±–æ—Ç—É, –∏—Å–ø–æ–ª—å–∑—É—è –≤—Å–µ –∏–∑—É—á–µ–Ω–Ω—ã–µ —Ç–µ—Ö–Ω–∏–∫–∏",
                    requires_submission: true,
                    submission_type: "image",
                    instructions: "–°–æ–∑–¥–∞–π—Ç–µ —Ä–∞–±–æ—Ç—É –Ω–∞ —Å–≤–æ–±–æ–¥–Ω—É—é —Ç–µ–º—É, –¥–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä—É—é—â—É—é –≤–∞—à–∏ –Ω–∞–≤—ã–∫–∏",
                    tips: ["–ü–ª–∞–Ω–∏—Ä—É–π—Ç–µ –∫–æ–º–ø–æ–∑–∏—Ü–∏—é –∑–∞—Ä–∞–Ω–µ–µ", "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ä–∞–∑–Ω—ã–µ —Ç–µ—Ö–Ω–∏–∫–∏", "–ù–µ –∑–∞–±—ã–≤–∞–π—Ç–µ –ø—Ä–æ —Å–≤–µ—Ç –∏ —Ç–µ–Ω—å"]
                }
            ],
            sparks_per_day: 10,
            sparks_completion_bonus: 50,
            is_active: true,
            difficulty: 'beginner',
            category: 'painting',
            participants_count: 234,
            completion_rate: 68,
            created_at: new Date().toISOString(),
            cover_image: '',
            requirements: "–ù–∞–ª–∏—á–∏–µ –±–∞–∑–æ–≤—ã—Ö –∞–∫–≤–∞—Ä–µ–ª—å–Ω—ã—Ö –∫—Ä–∞—Å–æ–∫, –∫–∏—Å—Ç–µ–π –∏ –±—É–º–∞–≥–∏"
        },
        {
            id: 2,
            title: "üí´ –ú–∞—Ä–∞—Ñ–æ–Ω —Å–æ–∑–¥–∞–Ω–∏—è –ª–∏—á–Ω–æ–≥–æ —Å—Ç–∏–ª—è",
            description: "21 –¥–µ–Ω—å –¥–ª—è —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–∏ –≤–∞—à–µ–≥–æ –≥–∞—Ä–¥–µ—Ä–æ–±–∞ –∏ —Å–æ–∑–¥–∞–Ω–∏—è —É–Ω–∏–∫–∞–ª—å–Ω–æ–≥–æ —Å—Ç–∏–ª—è",
            duration_days: 21,
            tasks: [
                { 
                    day: 1, 
                    title: "–ê–Ω–∞–ª–∏–∑ —Ç–µ–∫—É—â–µ–≥–æ –≥–∞—Ä–¥–µ—Ä–æ–±–∞", 
                    description: "–†–∞–∑–±–µ—Ä–∏—Ç–µ —Å–≤–æ–π –≥–∞—Ä–¥–µ—Ä–æ–± –∏ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç–µ —á—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç, –∞ —á—Ç–æ –Ω–µ—Ç",
                    requires_submission: true,
                    submission_type: "text",
                    instructions: "–û–ø–∏—à–∏—Ç–µ 5 –≤–µ—â–µ–π, –∫–æ—Ç–æ—Ä—ã–µ –≤—ã –Ω–æ—Å–∏–ª–∏ —á–∞—â–µ –≤—Å–µ–≥–æ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–π –º–µ—Å—è—Ü –∏ –ø–æ—á–µ–º—É"
                },
                { 
                    day: 2, 
                    title: "–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ü–≤–µ—Ç–æ—Ç–∏–ø–∞", 
                    description: "–£–∑–Ω–∞–π—Ç–µ —Å–≤–æ–π —Ü–≤–µ—Ç–æ—Ç–∏–ø –∏ –ø–æ–¥—Ö–æ–¥—è—â–∏–µ –≤–∞–º —Ü–≤–µ—Ç–∞",
                    requires_submission: true,
                    submission_type: "text",
                    instructions: "–û–ø—Ä–µ–¥–µ–ª–∏—Ç–µ —Å–≤–æ–π —Ü–≤–µ—Ç–æ—Ç–∏–ø –∏ —Å–æ—Å—Ç–∞–≤—å—Ç–µ —Å–ø–∏—Å–æ–∫ 5 —Å–∞–º—ã—Ö –ø–æ–¥—Ö–æ–¥—è—â–∏—Ö –≤–∞–º —Ü–≤–µ—Ç–æ–≤"
                },
                // ... –æ—Å—Ç–∞–ª—å–Ω—ã–µ –¥–Ω–∏ –º–∞—Ä–∞—Ñ–æ–Ω–∞
            ],
            sparks_per_day: 7,
            sparks_completion_bonus: 100,
            is_active: true,
            difficulty: 'intermediate',
            category: 'fashion',
            participants_count: 189,
            completion_rate: 45,
            created_at: new Date().toISOString(),
            cover_image: '',
            requirements: "–ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞–º —Å –≥–∞—Ä–¥–µ—Ä–æ–±–æ–º"
        }
    ],
    shop_items: [
        {
            id: 1,
            title: "üé® –ü–æ–ª–Ω—ã–π –∫—É—Ä—Å –∞–∫–≤–∞—Ä–µ–ª–∏ –¥–ª—è –Ω–∞—á–∏–Ω–∞—é—â–∏—Ö",
            description: "15 –ø–æ–¥—Ä–æ–±–Ω—ã—Ö –≤–∏–¥–µ–æ—É—Ä–æ–∫–æ–≤ –ø–æ –æ—Å–Ω–æ–≤–∞–º –∞–∫–≤–∞—Ä–µ–ª—å–Ω–æ–π –∂–∏–≤–æ–ø–∏—Å–∏. –û—Ç –±–∞–∑–æ–≤—ã—Ö —Ç–µ—Ö–Ω–∏–∫ –¥–æ —Å–ª–æ–∂–Ω—ã—Ö —Ä–∞–±–æ—Ç.",
            type: "video_course",
            file_url: "",
            preview_url: "",
            price: 45,
            content_text: "–í —ç—Ç–æ–º –∫—É—Ä—Å–µ –≤—ã –Ω–∞—É—á–∏—Ç–µ—Å—å: –æ—Å–Ω–æ–≤–Ω—ã–º —Ç–µ—Ö–Ω–∏–∫–∞–º –∞–∫–≤–∞—Ä–µ–ª–∏, —Å–º–µ—à–∏–≤–∞–Ω–∏—é —Ü–≤–µ—Ç–æ–≤, —Å–æ–∑–¥–∞–Ω–∏—é –∫–æ–º–ø–æ–∑–∏—Ü–∏–∏, —Ä–∞–±–æ—Ç–µ —Å–æ —Å–≤–µ—Ç–æ–º –∏ —Ç–µ–Ω—å—é, —Ä–∏—Å–æ–≤–∞–Ω–∏—é –ø–µ–π–∑–∞–∂–µ–π –∏ –ø–æ—Ä—Ç—Ä–µ—Ç–æ–≤.",
            is_active: true,
            category: "painting",
            difficulty: "beginner",
            duration: "15 —É—Ä–æ–∫–æ–≤",
            instructor: "–õ—É–∫–∞ –¶–≤–µ—Ç–Ω–æ–π",
            rating: 4.8,
            students_count: 567,
            created_at: new Date().toISOString(),
            features: ["–ü–æ–∂–∏–∑–Ω–µ–Ω–Ω—ã–π –¥–æ—Å—Ç—É–ø", "–ü–æ–¥–¥–µ—Ä–∂–∫–∞ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è", "–î–æ–º–∞—à–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è", "–°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏"]
        },
        {
            id: 2,
            title: "üëó –ì–∞–π–¥ –ø–æ —Å–æ–∑–¥–∞–Ω–∏—é –∫–∞–ø—Å—É–ª—å–Ω–æ–≥–æ –≥–∞—Ä–¥–µ—Ä–æ–±–∞",
            description: "–ü–æ—à–∞–≥–æ–≤–æ–µ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ —Å–æ–∑–¥–∞–Ω–∏—é —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ–≥–æ –≥–∞—Ä–¥–µ—Ä–æ–±–∞ –Ω–∞ –≤—Å–µ —Å–µ–∑–æ–Ω—ã.",
            type: "ebook",
            file_url: "",
            preview_url: "",
            price: 25,
            content_text: "–í —ç—Ç–æ–º —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–µ –≤—ã –Ω–∞–π–¥–µ—Ç–µ: –ø—Ä–∏–Ω—Ü–∏–ø—ã —Å–æ–∑–¥–∞–Ω–∏—è –∫–∞–ø—Å—É–ª—å–Ω–æ–≥–æ –≥–∞—Ä–¥–µ—Ä–æ–±–∞, –ø–æ–¥–±–æ—Ä–∫—É –±–∞–∑–æ–≤—ã—Ö –≤–µ—â–µ–π, —Å–µ–∑–æ–Ω–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏, —Å–æ–≤–µ—Ç—ã –ø–æ –∫–æ–º–±–∏–Ω–∞—Ü–∏—è–º.",
            is_active: true,
            category: "fashion",
            difficulty: "beginner",
            duration: "85 —Å—Ç—Ä–∞–Ω–∏—Ü",
            instructor: "–≠—Å—Ç–µ–ª–ª–∞ –ú–æ–¥–µ",
            rating: 4.6,
            students_count: 324,
            created_at: new Date().toISOString(),
            features: ["PDF —Ñ–æ—Ä–º–∞—Ç", "–ß–µ–∫-–ª–∏—Å—Ç—ã", "–ì–æ—Ç–æ–≤—ã–µ —Å—Ö–µ–º—ã –∫–æ–º–ø–ª–µ–∫—Ç–æ–≤"]
        },
        {
            id: 3,
            title: "üèõÔ∏è –ò—Å—Ç–æ—Ä–∏—è –∏—Å–∫—É—Å—Å—Ç–≤: –æ—Ç –∞–Ω—Ç–∏—á–Ω–æ—Å—Ç–∏ –¥–æ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω–æ—Å—Ç–∏",
            description: "–ò—Å—á–µ—Ä–ø—ã–≤–∞—é—â–∏–π –∫—É—Ä—Å –ø–æ –∏—Å—Ç–æ—Ä–∏–∏ –∏—Å–∫—É—Å—Å—Ç–≤ —Å –ø—Ä–∏–º–µ—Ä–∞–º–∏ –∏ –∞–Ω–∞–ª–∏–∑–æ–º —à–µ–¥–µ–≤—Ä–æ–≤.",
            type: "video_course",
            file_url: "",
            preview_url: "",
            price: 60,
            content_text: "–ö—É—Ä—Å –æ—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç: –∏—Å–∫—É—Å—Å—Ç–≤–æ –î—Ä–µ–≤–Ω–µ–≥–æ –º–∏—Ä–∞, –°—Ä–µ–¥–Ω–µ–≤–µ–∫–æ–≤—å–µ, –í–æ–∑—Ä–æ–∂–¥–µ–Ω–∏–µ, –±–∞—Ä–æ–∫–∫–æ, –∫–ª–∞—Å—Å–∏—Ü–∏–∑–º, –º–æ–¥–µ—Ä–Ω –∏ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–µ –∏—Å–∫—É—Å—Å—Ç–≤–æ.",
            is_active: true,
            category: "art_history",
            difficulty: "intermediate",
            duration: "20 —É—Ä–æ–∫–æ–≤",
            instructor: "–°–æ—Ñ–∏—è –•—Ä–æ–Ω–∏–∫",
            rating: 4.9,
            students_count: 278,
            created_at: new Date().toISOString(),
            features: ["–•—Ä–æ–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π –ø–æ–¥—Ö–æ–¥", "–ê–Ω–∞–ª–∏–∑ –∫–ª—é—á–µ–≤—ã—Ö —Ä–∞–±–æ—Ç", "–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–µ —Ç–µ—Å—Ç—ã", "–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º–∞—è –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä–∞"]
        },
        {
            id: 4,
            title: "üì∏ –û—Å–Ω–æ–≤—ã –∫–æ–º–ø–æ–∑–∏—Ü–∏–∏ –≤ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏",
            description: "–ù–∞—É—á–∏—Ç–µ—Å—å —Å–æ–∑–¥–∞–≤–∞—Ç—å –≥–∞—Ä–º–æ–Ω–∏—á–Ω—ã–µ –∏ –≤—ã—Ä–∞–∑–∏—Ç–µ–ª—å–Ω—ã–µ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ —Å –ø–æ–º–æ—â—å—é –ø—Ä–∞–≤–∏–ª –∫–æ–º–ø–æ–∑–∏—Ü–∏–∏.",
            type: "video_course",
            file_url: "",
            preview_url: "",
            price: 35,
            content_text: "–í –∫—É—Ä—Å–µ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω—ã: –ø—Ä–∞–≤–∏–ª–æ —Ç—Ä–µ—Ç–µ–π, –∑–æ–ª–æ—Ç–æ–µ —Å–µ—á–µ–Ω–∏–µ, –≤–µ–¥—É—â–∏–µ –ª–∏–Ω–∏–∏, —Ä–∞–±–æ—Ç–∞ —Å —Ñ–æ–Ω–æ–º, –±–∞–ª–∞–Ω—Å –∏ –∫–æ–Ω—Ç—Ä–∞—Å—Ç.",
            is_active: true,
            category: "photography",
            difficulty: "beginner",
            duration: "12 —É—Ä–æ–∫–æ–≤",
            instructor: "–í–∏–∫—Ç–æ—Ä –û–±—ä–µ–∫—Ç–∏–≤",
            rating: 4.7,
            students_count: 412,
            created_at: new Date().toISOString(),
            features: ["–ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –∑–∞–¥–∞–Ω–∏—è", "–†–∞–∑–±–æ—Ä —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π", "–°–æ–≤–µ—Ç—ã –ø–æ –æ–±—Ä–∞–±–æ—Ç–∫–µ"]
        }
    ],
    activities: [
        {
            id: 1,
            user_id: 12345,
            activity_type: 'registration',
            sparks_earned: 10,
            description: '–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –≤ —Å–∏—Å—Ç–µ–º–µ',
            created_at: new Date(Date.now() - 30 * 24 * 60 * 60 * 1000).toISOString()
        },
        {
            id: 2,
            user_id: 12345,
            activity_type: 'quiz',
            sparks_earned: 8,
            description: '–ö–≤–∏–∑: –û—Å–Ω–æ–≤—ã –∂–∏–≤–æ–ø–∏—Å–∏ - 4/5 –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤',
            created_at: new Date(Date.now() - 25 * 24 * 60 * 60 * 1000).toISOString()
        },
        {
            id: 3,
            user_id: 12345,
            activity_type: 'work_upload',
            sparks_earned: 5,
            description: '–ó–∞–≥—Ä—É–∑–∫–∞ —Ä–∞–±–æ—Ç—ã: "–ü–µ—Ä–≤—ã–π –∞–∫–≤–∞—Ä–µ–ª—å–Ω—ã–π —ç—Ç—é–¥"',
            created_at: new Date(Date.now() - 20 * 24 * 60 * 60 * 1000).toISOString()
        },
        {
            id: 4,
            user_id: 12345,
            activity_type: 'work_approved',
            sparks_earned: 15,
            description: '–†–∞–±–æ—Ç–∞ –æ–¥–æ–±—Ä–µ–Ω–∞: "–ü–µ—Ä–≤—ã–π –∞–∫–≤–∞—Ä–µ–ª—å–Ω—ã–π —ç—Ç—é–¥"',
            created_at: new Date(Date.now() - 18 * 24 * 60 * 60 * 1000).toISOString()
        },
        {
            id: 5,
            user_id: 12345,
            activity_type: 'marathon_day',
            sparks_earned: 7,
            description: '–ú–∞—Ä–∞—Ñ–æ–Ω –∞–∫–≤–∞—Ä–µ–ª–∏: –¥–µ–Ω—å 1 –∑–∞–≤–µ—Ä—à–µ–Ω',
            created_at: new Date(Date.now() - 15 * 24 * 60 * 60 * 1000).toISOString()
        }
    ],
    admins: [
        { 
            id: 1, 
            user_id: 898508164, 
            username: 'admin', 
            role: 'superadmin', 
            permissions: ['all'],
            created_at: new Date().toISOString(),
            last_login: new Date().toISOString()
        },
        { 
            id: 2, 
            user_id: 111111111, 
            username: 'moderator1', 
            role: 'moderator', 
            permissions: ['users', 'content', 'moderation'],
            created_at: new Date().toISOString(),
            last_login: new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString()
        }
    ],
    purchases: [
        {
            id: 1,
            user_id: 12345,
            item_id: 2,
            price_paid: 25,
            purchased_at: new Date(Date.now() - 10 * 24 * 60 * 60 * 1000).toISOString(),
            status: 'completed'
        },
        {
            id: 2,
            user_id: 987654321,
            item_id: 1,
            price_paid: 45,
            purchased_at: new Date(Date.now() - 5 * 24 * 60 * 60 * 1000).toISOString(),
            status: 'completed'
        }
    ],
    channel_posts: [
        {
            id: 1,
            post_id: "post_art_basics",
            title: "üé® –û—Å–Ω–æ–≤—ã –∫–æ–º–ø–æ–∑–∏—Ü–∏–∏ –≤ –∂–∏–≤–æ–ø–∏—Å–∏",
            content: "–°–µ–≥–æ–¥–Ω—è –ø–æ–≥–æ–≤–æ—Ä–∏–º –æ —Ñ—É–Ω–¥–∞–º–µ–Ω—Ç–∞–ª—å–Ω—ã—Ö –ø—Ä–∏–Ω—Ü–∏–ø–∞—Ö –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –∫–æ–º–ø–æ–∑–∏—Ü–∏–∏. –ö–æ–º–ø–æ–∑–∏—Ü–∏—è - —ç—Ç–æ –¥—É—à–∞ –∫–∞—Ä—Ç–∏–Ω—ã, —Ç–æ, —á—Ç–æ –¥–µ–ª–∞–µ—Ç –µ–µ –≥–∞—Ä–º–æ–Ω–∏—á–Ω–æ–π –∏ –≤—ã—Ä–∞–∑–∏—Ç–µ–ª—å–Ω–æ–π.\n\n**–ö–ª—é—á–µ–≤—ã–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã:**\n‚Ä¢ –ü—Ä–∞–≤–∏–ª–æ —Ç—Ä–µ—Ç–µ–π\n‚Ä¢ –ó–æ–ª–æ—Ç–æ–µ —Å–µ—á–µ–Ω–∏–µ\n‚Ä¢ –ë–∞–ª–∞–Ω—Å –∏ –∫–æ–Ω—Ç—Ä–∞—Å—Ç\n‚Ä¢ –í–µ–¥—É—â–∏–µ –ª–∏–Ω–∏–∏\n\n–ü—Ä–∞–∫—Ç–∏–∫—É–π—Ç–µ—Å—å –Ω–∞ –ø—Ä–æ—Å—Ç—ã—Ö –Ω–∞–±—Ä–æ—Å–∫–∞—Ö, –ø—Ä–µ–∂–¥–µ —á–µ–º –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç—å –∫ —Å–ª–æ–∂–Ω—ã–º —Ä–∞–±–æ—Ç–∞–º!",
            image_url: "",
            video_url: null,
            media_type: 'text',
            admin_id: 898508164,
            is_active: true,
            created_at: new Date(Date.now() - 2 * 24 * 60 * 60 * 1000).toISOString(),
            telegram_message_id: null,
            action_type: 'quiz',
            action_target: 1,
            likes_count: 23,
            comments_count: 8
        },
        {
            id: 2,
            post_id: "post_color_theory",
            title: "üåà –¢–µ–æ—Ä–∏—è —Ü–≤–µ—Ç–∞ –¥–ª—è —Ö—É–¥–æ–∂–Ω–∏–∫–æ–≤",
            content: "–¶–≤–µ—Ç - –º–æ—â–Ω—ã–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –≤ —Ä—É–∫–∞—Ö —Ö—É–¥–æ–∂–Ω–∏–∫–∞. –ü–æ–Ω–∏–º–∞–Ω–∏–µ —Ç–µ–æ—Ä–∏–∏ —Ü–≤–µ—Ç–∞ –ø–æ–º–æ–∂–µ—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å –≥–∞—Ä–º–æ–Ω–∏—á–Ω—ã–µ —Ä–∞–±–æ—Ç—ã.\n\n**–û—Å–Ω–æ–≤–Ω—ã–µ –ø–æ–Ω—è—Ç–∏—è:**\n‚Ä¢ –¶–≤–µ—Ç–æ–≤–æ–π –∫—Ä—É–≥\n‚Ä¢ –¢–µ–ø–ª—ã–µ –∏ —Ö–æ–ª–æ–¥–Ω—ã–µ —Ü–≤–µ—Ç–∞\n‚Ä¢ –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ü–≤–µ—Ç–∞\n‚Ä¢ –¶–≤–µ—Ç–æ–≤–∞—è –≥–∞—Ä–º–æ–Ω–∏—è\n\n–≠–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ —Å —Ü–≤–µ—Ç–∞–º–∏ –∏ –Ω–µ –±–æ–π—Ç–µ—Å—å –Ω–∞—Ä—É—à–∞—Ç—å –ø—Ä–∞–≤–∏–ª–∞!",
            image_url: "",
            video_url: null,
            media_type: 'text',
            admin_id: 898508164,
            is_active: true,
            created_at: new Date(Date.now() - 5 * 24 * 60 * 60 * 1000).toISOString(),
            telegram_message_id: null,
            action_type: 'marathon',
            action_target: 1,
            likes_count: 45,
            comments_count: 12
        }
    ],
    post_reviews: [
        {
            id: 1,
            user_id: 12345,
            post_id: "post_art_basics",
            review_text: "–û—Ç–ª–∏—á–Ω—ã–π –ø–æ—Å—Ç! –û—Å–æ–±–µ–Ω–Ω–æ –ø–æ–ª–µ–∑–Ω–æ –ø—Ä–∞–≤–∏–ª–æ —Ç—Ä–µ—Ç–µ–π. –£–∂–µ –ø–æ–ø—Ä–æ–±–æ–≤–∞–ª –Ω–∞ –ø—Ä–∞–∫—Ç–∏–∫–µ - –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Ä–∞–±–æ—Ç–∞–µ—Ç!",
            rating: 5,
            status: 'approved',
            created_at: new Date(Date.now() - 1 * 24 * 60 * 60 * 1000).toISOString(),
            moderated_at: new Date(Date.now() - 1 * 24 * 60 * 60 * 1000).toISOString(),
            moderator_id: 898508164,
            admin_comment: null
        },
        {
            id: 2,
            user_id: 987654321,
            post_id: "post_color_theory",
            review_text: "–°–ø–∞—Å–∏–±–æ –∑–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö —Ü–≤–µ—Ç–∞—Ö! –ù–∏–∫–æ–≥–¥–∞ –Ω–µ –¥—É–º–∞–ª–∞, —á—Ç–æ –æ—Ä–∞–Ω–∂–µ–≤—ã–π –∏ —Å–∏–Ω–∏–π —Ç–∞–∫ —Ö–æ—Ä–æ—à–æ —Å–æ—á–µ—Ç–∞—é—Ç—Å—è.",
            rating: 5,
            status: 'approved',
            created_at: new Date(Date.now() - 3 * 24 * 60 * 60 * 1000).toISOString(),
            moderated_at: new Date(Date.now() - 2 * 24 * 60 * 60 * 1000).toISOString(),
            moderator_id: 898508164,
            admin_comment: null
        }
    ],
    user_works: [
        {
            id: 1,
            user_id: 12345,
            title: "–ü–µ—Ä–≤—ã–π –∞–∫–≤–∞—Ä–µ–ª—å–Ω—ã–π —ç—Ç—é–¥",
            description: "–ú–æ—è –ø–µ—Ä–≤–∞—è —Ä–∞–±–æ—Ç–∞ –≤ —Ç–µ—Ö–Ω–∏–∫–µ –∞–∫–≤–∞—Ä–µ–ª–∏. –ü—ã—Ç–∞–ª—Å—è –ø–µ—Ä–µ–¥–∞—Ç—å –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ –æ—Å–µ–Ω–Ω–µ–≥–æ –¥–Ω—è.",
            image_url: "",
            type: 'image',
            status: 'approved',
            created_at: new Date(Date.now() - 20 * 24 * 60 * 60 * 1000).toISOString(),
            moderated_at: new Date(Date.now() - 18 * 24 * 60 * 60 * 1000).toISOString(),
            moderator_id: 898508164,
            admin_comment: "–û—Ç–ª–∏—á–Ω–∞—è —Ä–∞–±–æ—Ç–∞ –¥–ª—è –ø–µ—Ä–≤–æ–≥–æ —Ä–∞–∑–∞! –•–æ—Ä–æ—à–æ –ø–µ—Ä–µ–¥–∞–Ω–∞ –∞—Ç–º–æ—Å—Ñ–µ—Ä–∞.",
            category: 'painting',
            tags: ['–∞–∫–≤–∞—Ä–µ–ª—å', '–ø–µ–π–∑–∞–∂', '–æ—Å–µ–Ω—å'],
            likes_count: 8,
            comments_count: 3
        },
        {
            id: 2,
            user_id: 987654321,
            title: "–ë–æ—Ç–∞–Ω–∏—á–µ—Å–∫–∞—è –∏–ª–ª—é—Å—Ç—Ä–∞—Ü–∏—è —Ä–æ–∑—ã",
            description: "–ò–ª–ª—é—Å—Ç—Ä–∞—Ü–∏—è —Ä–æ–∑—ã –≤ —Ç–µ—Ö–Ω–∏–∫–µ –∞–∫–≤–∞—Ä–µ–ª–∏. –£–ø–æ—Ä –Ω–∞ –ø–µ—Ä–µ–¥–∞—á—É —Ç–µ–∫—Å—Ç—É—Ä—ã –ª–µ–ø–µ—Å—Ç–∫–æ–≤.",
            image_url: "",
            type: 'image',
            status: 'approved',
            created_at: new Date(Date.now() - 12 * 24 * 60 * 60 * 1000).toISOString(),
            moderated_at: new Date(Date.now() - 10 * 24 * 60 * 60 * 1000).toISOString(),
            moderator_id: 898508164,
            admin_comment: "–ü—Ä–µ–∫—Ä–∞—Å–Ω–∞—è —Ä–∞–±–æ—Ç–∞! –û—Ç–ª–∏—á–Ω–æ –ø–µ—Ä–µ–¥–∞–Ω–∞ —Ç–µ–∫—Å—Ç—É—Ä–∞ –∏ –æ–±—ä–µ–º.",
            category: 'illustration',
            tags: ['–∞–∫–≤–∞—Ä–µ–ª—å', '–±–æ—Ç–∞–Ω–∏–∫–∞', '—Ü–≤–µ—Ç—ã'],
            likes_count: 15,
            comments_count: 6
        },
        {
            id: 3,
            user_id: 456789123,
            title: "–ì–æ—Ä–æ–¥—Å–∫–æ–π —Å–∫–µ—Ç—á",
            description: "–ë—ã—Å—Ç—Ä–∞—è –∑–∞—Ä–∏—Å–æ–≤–∫–∞ —É–ª–æ—á–∫–∏ —Å—Ç–∞—Ä–æ–≥–æ –≥–æ—Ä–æ–¥–∞. –¢—É—à—å, –∞–∫–≤–∞—Ä–µ–ª—å.",
            image_url: "",
            type: 'image',
            status: 'pending',
            created_at: new Date(Date.now() - 2 * 24 * 60 * 60 * 1000).toISOString(),
            moderated_at: null,
            moderator_id: null,
            admin_comment: null,
            category: 'sketch',
            tags: ['—Å–∫–µ—Ç—á–∏–Ω–≥', '–≥–æ—Ä–æ–¥', '–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞'],
            likes_count: 0,
            comments_count: 0
        }
    ],
    work_reviews: [],
    marathon_completions: [
        {
            id: 1,
            user_id: 12345,
            marathon_id: 1,
            current_day: 3,
            progress: 42,
            completed: false,
            started_at: new Date(Date.now() - 15 * 24 * 60 * 60 * 1000).toISOString(),
            last_activity: new Date(Date.now() - 2 * 24 * 60 * 60 * 1000).toISOString()
        },
        {
            id: 2,
            user_id: 987654321,
            marathon_id: 1,
            current_day: 7,
            progress: 100,
            completed: true,
            started_at: new Date(Date.now() - 20 * 24 * 60 * 60 * 1000).toISOString(),
            completed_at: new Date(Date.now() - 5 * 24 * 60 * 60 * 1000).toISOString(),
            last_activity: new Date(Date.now() - 5 * 24 * 60 * 60 * 1000).toISOString()
        }
    ],
    quiz_completions: [
        {
            id: 1,
            user_id: 12345,
            quiz_id: 1,
            completed_at: new Date(Date.now() - 25 * 24 * 60 * 60 * 1000).toISOString(),
            score: 4,
            total_questions: 5,
            sparks_earned: 8,
            perfect_score: false,
            time_spent: 420
        },
        {
            id: 2,
            user_id: 987654321,
            quiz_id: 1,
            completed_at: new Date(Date.now() - 10 * 24 * 60 * 60 * 1000).toISOString(),
            score: 5,
            total_questions: 5,
            sparks_earned: 15,
            perfect_score: true,
            time_spent: 380
        },
        {
            id: 3,
            user_id: 12345,
            quiz_id: 2,
            completed_at: new Date(Date.now() - 8 * 24 * 60 * 60 * 1000).toISOString(),
            score: 3,
            total_questions: 5,
            sparks_earned: 6,
            perfect_score: false,
            time_spent: 320
        }
    ],
    daily_reviews: [
        {
            id: 1,
            user_id: 12345,
            date: new Date(Date.now() - 1 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
            type: 'daily_comment'
        },
        {
            id: 2,
            user_id: 987654321,
            date: new Date().toISOString().split('T')[0],
            type: 'daily_comment'
        }
    ],
    interactives: [
        {
            id: 1,
            title: "üé® –£–≥–∞–¥–∞–π —ç–ø–æ—Ö—É –∫–∞—Ä—Ç–∏–Ω—ã",
            description: "–û–ø—Ä–µ–¥–µ–ª–∏—Ç–µ —Ö—É–¥–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—É—é —ç–ø–æ—Ö—É –ø–æ —Ñ—Ä–∞–≥–º–µ–Ω—Ç—É –∏–∑–≤–µ—Å—Ç–Ω–æ–π –∫–∞—Ä—Ç–∏–Ω—ã",
            type: "guess_era",
            category: "art_history",
            image_url: "",
            question: "–ö–∞–∫–æ–π —ç–ø–æ—Ö–µ –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∏—Ç —ç—Ç–æ—Ç —Ñ—Ä–∞–≥–º–µ–Ω—Ç?",
            options: ["–†–µ–Ω–µ—Å—Å–∞–Ω—Å", "–ë–∞—Ä–æ–∫–∫–æ", "–ò–º–ø—Ä–µ—Å—Å–∏–æ–Ω–∏–∑–º", "–ö—É–±–∏–∑–º"],
            correct_answer: 0,
            sparks_reward: 5,
            allow_retake: false,
            is_active: true,
            difficulty: 'intermediate',
            created_at: new Date().toISOString(),
            attempts_count: 134,
            success_rate: 62
        },
        {
            id: 2,
            title: "üåà –°–æ–±–µ—Ä–∏ –ø–∞–ª–∏—Ç—Ä—É",
            description: "–°–æ–∑–¥–∞–π—Ç–µ –≥–∞—Ä–º–æ–Ω–∏—á–Ω—É—é —Ü–≤–µ—Ç–æ–≤—É—é –ø–∞–ª–∏—Ç—Ä—É –¥–ª—è –∑–∞–¥–∞–Ω–Ω–æ–≥–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è",
            type: "color_palette",
            category: "color_theory",
            image_url: "",
            question: "–°–æ–∑–¥–∞–π—Ç–µ –ø–∞–ª–∏—Ç—Ä—É –¥–ª—è —Å–ø–æ–∫–æ–π–Ω–æ–≥–æ –∏ —É–º–∏—Ä–æ—Ç–≤–æ—Ä–µ–Ω–Ω–æ–≥–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è",
            options: ["–¢–µ–ø–ª—ã–µ –ø–∞—Å—Ç–µ–ª—å–Ω—ã–µ —Ç–æ–Ω–∞", "–Ø—Ä–∫–∏–µ –∫–æ–Ω—Ç—Ä–∞—Å—Ç–Ω—ã–µ —Ü–≤–µ—Ç–∞", "–•–æ–ª–æ–¥–Ω—ã–µ –Ω–∞—Å—ã—â–µ–Ω–Ω—ã–µ –æ—Ç—Ç–µ–Ω–∫–∏", "–ú–æ–Ω–æ—Ö—Ä–æ–º–Ω–∞—è –≥–∞–º–º–∞"],
            correct_answer: 0,
            sparks_reward: 4,
            allow_retake: true,
            is_active: true,
            difficulty: 'beginner',
            created_at: new Date().toISOString(),
            attempts_count: 278,
            success_rate: 78
        },
        {
            id: 3,
            title: "üëó –°–æ—Å—Ç–∞–≤—å –æ–±—Ä–∞–∑",
            description: "–°–æ–∑–¥–∞–π—Ç–µ –≥–∞—Ä–º–æ–Ω–∏—á–Ω—ã–π –æ–±—Ä–∞–∑ –∏–∑ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –æ–¥–µ–∂–¥—ã",
            type: "outfit_builder",
            category: "fashion",
            image_url: "",
            question: "–ö–∞–∫–æ–π –æ–±—Ä–∞–∑ –ª—É—á—à–µ –≤—Å–µ–≥–æ –ø–æ–¥–æ–π–¥–µ—Ç –¥–ª—è –¥–µ–ª–æ–≤–æ–π –≤—Å—Ç—Ä–µ—á–∏?",
            options: ["–ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π –∫–æ—Å—Ç—é–º", "–ö—ç–∂—É–∞–ª —Å –¥–∂–∏–Ω—Å–∞–º–∏", "–í–µ—á–µ—Ä–Ω–µ–µ –ø–ª–∞—Ç—å–µ", "–°–ø–æ—Ä—Ç–∏–≤–Ω—ã–π —Å—Ç–∏–ª—å"],
            correct_answer: 0,
            sparks_reward: 4,
            allow_retake: true,
            is_active: true,
            difficulty: 'beginner',
            created_at: new Date().toISOString(),
            attempts_count: 189,
            success_rate: 85
        }
    ],
    interactive_completions: [
        {
            id: 1,
            user_id: 12345,
            interactive_id: 1,
            completed_at: new Date(Date.now() - 5 * 24 * 60 * 60 * 1000).toISOString(),
            score: 1,
            sparks_earned: 5,
            answer: 0,
            time_spent: 45
        },
        {
            id: 2,
            user_id: 987654321,
            interactive_id: 2,
            completed_at: new Date(Date.now() - 3 * 24 * 60 * 60 * 1000).toISOString(),
            score: 1,
            sparks_earned: 4,
            answer: 0,
            time_spent: 60
        }
    ],
    interactive_submissions: [],
    marathon_submissions: [
        {
            id: 1,
            user_id: 12345,
            marathon_id: 1,
            day: 1,
            submission_text: "–ü–æ–ø—Ä–æ–±–æ–≤–∞–ª –≤—Å–µ —Ç—Ä–∏ —Ç–µ—Ö–Ω–∏–∫–∏. –ë–æ–ª—å—à–µ –≤—Å–µ–≥–æ –ø–æ–Ω—Ä–∞–≤–∏–ª–∞—Å—å —Ä–∞–±–æ—Ç–∞ –ø–æ-–º–æ–∫—Ä–æ–º—É - –ø–æ–ª—É—á–∞—é—Ç—Å—è –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã–µ —Ä–∞–∑–≤–æ–¥—ã.",
            submission_image: "",
            submitted_at: new Date(Date.now() - 15 * 24 * 60 * 60 * 1000).toISOString(),
            status: 'approved',
            moderator_comment: "–û—Ç–ª–∏—á–Ω–æ–µ –Ω–∞—á–∞–ª–æ! –í–∏–¥–Ω–æ, —á—Ç–æ —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–ª–∏ —Å —Ç–µ—Ö–Ω–∏–∫–∞–º–∏."
        },
        {
            id: 2,
            user_id: 12345,
            marathon_id: 1,
            day: 2,
            submission_text: "–°–æ–∑–¥–∞–ª —Ü–≤–µ—Ç–æ–≤–æ–π –∫—Ä—É–≥. –ë—ã–ª–æ —Å–ª–æ–∂–Ω–æ –¥–æ–±–∏—Ç—å—Å—è —á–∏—Å—Ç—ã—Ö –ø–µ—Ä–µ—Ö–æ–¥–æ–≤ –º–µ–∂–¥—É —Ü–≤–µ—Ç–∞–º–∏.",
            submission_image: "",
            submitted_at: new Date(Date.now() - 14 * 24 * 60 * 60 * 1000).toISOString(),
            status: 'approved',
            moderator_comment: "–•–æ—Ä–æ—à–∞—è —Ä–∞–±–æ—Ç–∞! –¶–≤–µ—Ç–∞ —á–∏—Å—Ç—ã–µ, –ø–µ—Ä–µ—Ö–æ–¥—ã –ø–ª–∞–≤–Ω—ã–µ."
        }
    ],
    user_sessions: [],
    notifications: [
        {
            id: 1,
            user_id: 12345,
            title: "üéâ –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!",
            message: "–í—ã —É—Å–ø–µ—à–Ω–æ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–ª–∏—Å—å –≤ –ú–∞—Å—Ç–µ—Ä—Å–∫–æ–π –í–¥–æ—Ö–Ω–æ–≤–µ–Ω–∏—è!",
            type: "welcome",
            is_read: true,
            created_at: new Date(Date.now() - 30 * 24 * 60 * 60 * 1000).toISOString()
        },
        {
            id: 2,
            user_id: 12345,
            title: "‚ú® –ù–æ–≤–∞—è –Ω–∞–≥—Ä–∞–¥–∞!",
            message: "–í—ã –ø–æ–ª—É—á–∏–ª–∏ 15 –∏—Å–∫—Ä –∑–∞ –æ–¥–æ–±—Ä–µ–Ω–Ω—É—é —Ä–∞–±–æ—Ç—É!",
            type: "reward",
            is_read: true,
            created_at: new Date(Date.now() - 18 * 24 * 60 * 60 * 1000).toISOString()
        },
        {
            id: 3,
            user_id: 12345,
            title: "üèÉ‚Äç‚ôÇÔ∏è –ü—Ä–æ–¥–æ–ª–∂–∞–π—Ç–µ –º–∞—Ä–∞—Ñ–æ–Ω!",
            message: "–ù–µ –∑–∞–±—É–¥—å—Ç–µ –∑–∞–≤–µ—Ä—à–∏—Ç—å 3 –¥–µ–Ω—å –º–∞—Ä–∞—Ñ–æ–Ω–∞ –∞–∫–≤–∞—Ä–µ–ª–∏",
            type: "reminder",
            is_read: false,
            created_at: new Date(Date.now() - 2 * 24 * 60 * 60 * 1000).toISOString()
        }
    ],
    achievements: [
        {
            id: 1,
            title: "–ü–µ—Ä–≤—ã–π —à–∞–≥",
            description: "–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è –≤ —Å–∏—Å—Ç–µ–º–µ",
            icon: "üë£",
            sparks_reward: 10,
            condition_type: "registration",
            condition_value: "1",
            is_active: true
        },
        {
            id: 2,
            title: "–õ—é–±–æ–∑–Ω–∞—Ç–µ–ª—å–Ω—ã–π",
            description: "–ü—Ä–æ–π–¥–∏—Ç–µ –ø–µ—Ä–≤—ã–π –∫–≤–∏–∑",
            icon: "üéØ",
            sparks_reward: 15,
            condition_type: "quiz_completion",
            condition_value: "1",
            is_active: true
        },
        {
            id: 3,
            title: "–¢–≤–æ—Ä–µ—Ü",
            description: "–ó–∞–≥—Ä—É–∑–∏—Ç–µ –ø–µ—Ä–≤—É—é —Ä–∞–±–æ—Ç—É",
            icon: "üñºÔ∏è",
            sparks_reward: 20,
            condition_type: "work_upload",
            condition_value: "1",
            is_active: true
        },
        {
            id: 4,
            title: "–ú–∞—Å—Ç–µ—Ä",
            description: "–ü–æ–ª—É—á–∏—Ç–µ 100 –∏—Å–∫—Ä",
            icon: "‚≠ê",
            sparks_reward: 25,
            condition_type: "sparks_total",
            condition_value: "100",
            is_active: true
        },
        {
            id: 5,
            title: "–ú–∞—Ä–∞—Ñ–æ–Ω–µ—Ü",
            description: "–ó–∞–≤–µ—Ä—à–∏—Ç–µ –ø–µ—Ä–≤—ã–π –º–∞—Ä–∞—Ñ–æ–Ω",
            icon: "üèÖ",
            sparks_reward: 50,
            condition_type: "marathon_completion",
            condition_value: "1",
            is_active: true
        }
    ],
    user_achievements: [
        {
            id: 1,
            user_id: 12345,
            achievement_id: 1,
            earned_at: new Date(Date.now() - 30 * 24 * 60 * 60 * 1000).toISOString(),
            sparks_claimed: true
        },
        {
            id: 2,
            user_id: 12345,
            achievement_id: 2,
            earned_at: new Date(Date.now() - 25 * 24 * 60 * 60 * 1000).toISOString(),
            sparks_claimed: true
        },
        {
            id: 3,
            user_id: 12345,
            achievement_id: 3,
            earned_at: new Date(Date.now() - 20 * 24 * 60 * 60 * 1000).toISOString(),
            sparks_claimed: true
        }
    ],
    settings: [
        {
            key: "app_name",
            value: "–ú–∞—Å—Ç–µ—Ä—Å–∫–∞—è –í–¥–æ—Ö–Ω–æ–≤–µ–Ω–∏—è",
            description: "–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è"
        },
        {
            key: "sparks_registration_bonus",
            value: "10",
            description: "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏—Å–∫—Ä –∑–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é"
        },
        {
            key: "sparks_quiz_per_correct",
            value: "2",
            description: "–ò—Å–∫—Ä –∑–∞ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç –≤ –∫–≤–∏–∑–µ"
        },
        {
            key: "sparks_work_upload",
            value: "5",
            description: "–ò—Å–∫—Ä –∑–∞ –∑–∞–≥—Ä—É–∑–∫—É —Ä–∞–±–æ—Ç—ã"
        },
        {
            key: "sparks_work_approved",
            value: "15",
            description: "–ò—Å–∫—Ä –∑–∞ –æ–¥–æ–±—Ä–µ–Ω–Ω—É—é —Ä–∞–±–æ—Ç—É"
        },
        {
            key: "admin_contact",
            value: "@inspiration_support",
            description: "–ö–æ–Ω—Ç–∞–∫—Ç –¥–ª—è —Å–≤—è–∑–∏ —Å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏–µ–π"
        }
    ]
};

app.use(express.json({ limit: '50mb' }));
app.use(cors());
app.use(bodyParser.urlencoded({ extended: true }));

// ==================== –°–¢–ê–¢–ò–ß–ï–°–ö–ò–ï –§–ê–ô–õ–´ ====================
app.use(express.static(join(APP_ROOT, 'public')));
app.use('/admin', express.static(join(APP_ROOT, 'admin')));

app.get('/admin', (req, res) => {
    res.sendFile(join(APP_ROOT, 'admin', 'index.html'));
});

app.get('/admin/*', (req, res) => {
    res.sendFile(join(APP_ROOT, 'admin', 'index.html'));
});

console.log('üé® –°–∏—Å—Ç–µ–º–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞ —É—Å–ø–µ—à–Ω–æ!');

// –£–õ–£–ß–®–ï–ù–ù–ê–Ø –°–ò–°–¢–ï–ú–ê –ù–ê–ß–ò–°–õ–ï–ù–ò–Ø –ò–°–ö–†
const SPARKS_SYSTEM = {
    QUIZ_PER_CORRECT_ANSWER: 2,
    QUIZ_PERFECT_BONUS: 10,
    MARATHON_DAY_COMPLETION: 7,
    MARATHON_COMPLETION_BONUS: 50,
    INVITE_FRIEND: 10,
    WRITE_REVIEW: 3,
    DAILY_COMMENT: 1,
    UPLOAD_WORK: 5,
    WORK_APPROVED: 15,
    REGISTRATION_BONUS: 10,
    PARTICIPATE_POLL: 2,
    INTERACTIVE_COMPLETION: 5,
    INTERACTIVE_SUBMISSION: 2,
    COMPLIMENT_CHALLENGE: 0.5,
    MARATHON_SUBMISSION: 5,
    ROLE_CHANGE: 0,
    ACHIEVEMENT_REWARD: 25
};

// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
function calculateLevel(sparks) {
    if (sparks >= 1000) return '–õ–µ–≥–µ–Ω–¥–∞';
    if (sparks >= 500) return '–ù–∞—Å—Ç–∞–≤–Ω–∏–∫';
    if (sparks >= 300) return '–ú–∞—Å—Ç–µ—Ä';
    if (sparks >= 150) return '–ó–Ω–∞—Ç–æ–∫';
    if (sparks >= 50) return '–ò—Å–∫–∞—Ç–µ–ª—å';
    return '–£—á–µ–Ω–∏–∫';
}

function addSparks(userId, sparks, activityType, description) {
    const user = db.users.find(u => u.user_id == userId);
    if (user) {
        user.sparks = Math.max(0, user.sparks + sparks);
        user.level = calculateLevel(user.sparks);
        user.last_active = new Date().toISOString();
        
        const activity = {
            id: Date.now(),
            user_id: userId,
            activity_type: activityType,
            sparks_earned: sparks,
            description: description,
            created_at: new Date().toISOString()
        };
        
        db.activities.push(activity);
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è
        checkAchievements(userId);
        
        return activity;
    }
    return null;
}

function checkAchievements(userId) {
    const user = db.users.find(u => u.user_id == userId);
    if (!user) return;

    const userActivities = db.activities.filter(a => a.user_id == userId);
    const userAchievements = db.user_achievements.filter(ua => ua.user_id == userId);
    const quizCompletions = db.quiz_completions.filter(qc => qc.user_id == userId);
    const works = db.user_works.filter(w => w.user_id == userId);
    const marathonCompletions = db.marathon_completions.filter(mc => mc.user_id == userId && mc.completed);

    db.achievements.forEach(achievement => {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É–∂–µ —ç—Ç–æ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–µ
        const hasAchievement = userAchievements.some(ua => ua.achievement_id == achievement.id);
        if (hasAchievement) return;

        let conditionMet = false;

        switch (achievement.condition_type) {
            case 'registration':
                conditionMet = user.is_registered;
                break;
            case 'quiz_completion':
                conditionMet = quizCompletions.length >= parseInt(achievement.condition_value);
                break;
            case 'work_upload':
                conditionMet = works.length >= parseInt(achievement.condition_value);
                break;
            case 'sparks_total':
                conditionMet = user.sparks >= parseInt(achievement.condition_value);
                break;
            case 'marathon_completion':
                conditionMet = marathonCompletions.length >= parseInt(achievement.condition_value);
                break;
        }

        if (conditionMet) {
            const userAchievement = {
                id: Date.now(),
                user_id: userId,
                achievement_id: achievement.id,
                earned_at: new Date().toISOString(),
                sparks_claimed: false
            };
            
            db.user_achievements.push(userAchievement);
            
            // –°–æ–∑–¥–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
            const notification = {
                id: Date.now(),
                user_id: userId,
                title: "üèÜ –ù–æ–≤–æ–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–µ!",
                message: `–í—ã –ø–æ–ª—É—á–∏–ª–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–µ "${achievement.title}"!`,
                type: "achievement",
                is_read: false,
                created_at: new Date().toISOString()
            };
            
            db.notifications.push(notification);
        }
    });
}

function getUserStats(userId) {
    const user = db.users.find(u => u.user_id == userId);
    if (!user) return null;
    
    const activities = db.activities.filter(a => a.user_id == userId);
    const purchases = db.purchases.filter(p => p.user_id == userId);
    const works = db.user_works.filter(w => w.user_id == userId);
    const quizCompletions = db.quiz_completions.filter(q => q.user_id == userId);
    const marathonCompletions = db.marathon_completions.filter(m => m.user_id == userId);
    const interactiveCompletions = db.interactive_completions.filter(i => i.user_id == userId);
    const userAchievements = db.user_achievements.filter(ua => ua.user_id == userId);
    
    return {
        totalActivities: activities.length,
        totalPurchases: purchases.length,
        totalWorks: works.length,
        approvedWorks: works.filter(w => w.status === 'approved').length,
        totalQuizzesCompleted: quizCompletions.length,
        totalMarathonsCompleted: marathonCompletions.filter(m => m.completed).length,
        totalInteractivesCompleted: interactiveCompletions.length,
        totalSparksEarned: activities.reduce((sum, a) => sum + a.sparks_earned, 0),
        totalAchievements: userAchievements.length,
        registrationDate: user.registration_date,
        lastActive: user.last_active
    };
}

// Middleware
const requireAdmin = (req, res, next) => {
    const userId = req.query.userId || req.body.userId;
    
    if (!userId) {
        return res.status(401).json({ error: 'User ID required' });
    }
    
    const admin = db.admins.find(a => a.user_id == userId);
    if (!admin) {
        return res.status(403).json({ error: 'Admin access required' });
    }
    
    req.admin = admin;
    next();
};

// Basic routes
app.get('/health', (req, res) => {
    res.json({ 
        status: 'OK', 
        timestamp: new Date().toISOString(),
        version: '8.0.0',
        database: 'In-Memory',
        users: db.users.length,
        quizzes: db.quizzes.length,
        marathons: db.marathons.length,
        shop_items: db.shop_items.length,
        interactives: db.interactives.length,
        posts: db.channel_posts.length
    });
});

// WebApp API
app.get('/api/users/:userId', (req, res) => {
    const userId = parseInt(req.params.userId);
    const user = db.users.find(u => u.user_id === userId);
    
    if (user) {
        const stats = getUserStats(userId);
        const userAchievements = db.user_achievements
            .filter(ua => ua.user_id === userId)
            .map(ua => {
                const achievement = db.achievements.find(a => a.id === ua.achievement_id);
                return {
                    ...ua,
                    title: achievement?.title,
                    description: achievement?.description,
                    icon: achievement?.icon,
                    sparks_reward: achievement?.sparks_reward
                };
            });
        
        const notifications = db.notifications
            .filter(n => n.user_id === userId && !n.is_read)
            .slice(0, 10);
            
        res.json({ 
            exists: true, 
            user: {
                ...user,
                stats: stats,
                achievements: userAchievements,
                unread_notifications: notifications.length
            }
        });
    } else {
        const newUser = {
            id: Date.now(),
            user_id: userId,
            tg_first_name: '–ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å',
            sparks: 0,
            level: '–£—á–µ–Ω–∏–∫',
            is_registered: false,
            class: null,
            character_id: null,
            character_name: null,
            available_buttons: [],
            registration_date: new Date().toISOString(),
            last_active: new Date().toISOString(),
            total_activities: 0,
            completed_quizzes: 0,
            completed_marathons: 0,
            uploaded_works: 0
        };
        db.users.push(newUser);
        res.json({ 
            exists: false, 
            user: newUser 
        });
    }
});

// –ù–û–í–´–ô –ú–ï–¢–û–î –î–õ–Ø –°–ú–ï–ù–´ –†–û–õ–ò
app.post('/api/users/change-role', (req, res) => {
    const { userId, roleId, characterId } = req.body;
    
    if (!userId || !roleId) {
        return res.status(400).json({ error: 'User ID and role are required' });
    }
    
    const user = db.users.find(u => u.user_id == userId);
    const role = db.roles.find(r => r.id == roleId);
    const character = db.characters.find(c => c.id == characterId);
    
    if (!user || !role) {
        return res.status(404).json({ error: 'User or role not found' });
    }
    
    if (!user.is_registered) {
        return res.status(400).json({ error: 'User not registered' });
    }
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Ç–∞—Ä—É—é —Ä–æ–ª—å –¥–ª—è –ª–æ–≥–∞
    const oldRole = user.class;
    
    user.class = role.name;
    user.character_id = characterId;
    user.character_name = character ? character.name : null;
    user.available_buttons = role.available_buttons;
    user.last_active = new Date().toISOString();
    
    // –õ–æ–≥–∏—Ä—É–µ–º —Å–º–µ–Ω—É —Ä–æ–ª–∏ (0 –∏—Å–∫—Ä)
    addSparks(userId, SPARKS_SYSTEM.ROLE_CHANGE, 'role_change', `–°–º–µ–Ω–∞ —Ä–æ–ª–∏: ${oldRole} ‚Üí ${role.name}`);
    
    res.json({ 
        success: true, 
        message: '–†–æ–ª—å —É—Å–ø–µ—à–Ω–æ –∏–∑–º–µ–Ω–µ–Ω–∞!',
        user: user
    });
});

app.post('/api/users/register', (req, res) => {
    const { userId, firstName, roleId, characterId } = req.body;
    
    if (!userId || !firstName || !roleId) {
        return res.status(400).json({ error: 'User ID, first name and role are required' });
    }
    
    const user = db.users.find(u => u.user_id == userId);
    const role = db.roles.find(r => r.id == roleId);
    const character = db.characters.find(c => c.id == characterId);
    
    if (!user || !role) {
        return res.status(404).json({ error: 'User or role not found' });
    }
    
    const isNewUser = !user.is_registered;
    
    user.tg_first_name = firstName;
    user.class = role.name;
    user.character_id = characterId;
    user.character_name = character ? character.name : null;
    user.is_registered = true;
    user.available_buttons = role.available_buttons;
    user.last_active = new Date().toISOString();
    
    let message = '–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞!';
    let sparksAdded = 0;
    
    if (isNewUser) {
        sparksAdded = SPARKS_SYSTEM.REGISTRATION_BONUS;
        addSparks(userId, sparksAdded, 'registration', '–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è');
        message = `–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞! +${sparksAdded}‚ú®`;
        
        // –°–æ–∑–¥–∞–µ–º welcome —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
        const notification = {
            id: Date.now(),
            user_id: userId,
            title: "üéâ –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!",
            message: "–í—ã —É—Å–ø–µ—à–Ω–æ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–ª–∏—Å—å –≤ –ú–∞—Å—Ç–µ—Ä—Å–∫–æ–π –í–¥–æ—Ö–Ω–æ–≤–µ–Ω–∏—è! –ù–∞—á–Ω–∏—Ç–µ —Å –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è –ø–µ—Ä–≤–æ–≥–æ –∫–≤–∏–∑–∞.",
            type: "welcome",
            is_read: false,
            created_at: new Date().toISOString()
        };
        db.notifications.push(notification);
    }
    
    res.json({ 
        success: true, 
        message, 
        sparksAdded,
        user: user
    });
});

app.get('/api/webapp/roles', (req, res) => {
    const roles = db.roles.filter(role => role.is_active);
    res.json(roles);
});

app.get('/api/webapp/characters/:roleId', (req, res) => {
    const roleId = parseInt(req.params.roleId);
    const characters = db.characters.filter(char => char.role_id === roleId && char.is_active);
    res.json(characters);
});

app.get('/api/webapp/quizzes', (req, res) => {
    const userId = parseInt(req.query.userId);
    const quizzes = db.quizzes.filter(q => q.is_active);
    
    const quizzesWithStatus = quizzes.map(quiz => {
        const completion = db.quiz_completions.find(
            qc => qc.user_id === userId && qc.quiz_id === quiz.id
        );
        
        let canRetake = quiz.allow_retake;
        if (completion && quiz.cooldown_hours > 0) {
            const lastCompletion = new Date(completion.completed_at);
            const now = new Date();
            const hoursSinceCompletion = (now - lastCompletion) / (1000 * 60 * 60);
            canRetake = hoursSinceCompletion >= quiz.cooldown_hours;
        }
        
        return {
            ...quiz,
            completed: !!completion,
            user_score: completion ? completion.score : 0,
            total_questions: quiz.questions.length,
            can_retake: canRetake && quiz.allow_retake,
            last_completion: completion ? completion.completed_at : null,
            user_perfect_score: completion ? completion.perfect_score : false
        };
    });
    
    res.json(quizzesWithStatus);
});

// –ò–°–ü–†–ê–í–õ–ï–ù–ù–û–ï –û–¢–ü–†–ê–í–õ–ï–ù–ò–ï –†–ï–ó–£–õ–¨–¢–ê–¢–û–í –ö–í–ò–ó–ê
app.post('/api/webapp/quizzes/:quizId/submit', (req, res) => {
    const quizId = parseInt(req.params.quizId);
    const { userId, answers } = req.body;
    
    if (!userId) {
        return res.status(400).json({ error: 'User ID is required' });
    }
    
    const quiz = db.quizzes.find(q => q.id === quizId);
    if (!quiz) {
        return res.status(404).json({ error: 'Quiz not found' });
    }
    
    const existingCompletion = db.quiz_completions.find(
        qc => qc.user_id === userId && qc.quiz_id === quizId
    );
    
    if (existingCompletion && !quiz.allow_retake) {
        return res.status(400).json({ error: '–≠—Ç–æ—Ç –∫–≤–∏–∑ –Ω–µ–ª—å–∑—è –ø—Ä–æ–π—Ç–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ' });
    }
    
    if (existingCompletion && quiz.cooldown_hours > 0) {
        const lastCompletion = new Date(existingCompletion.completed_at);
        const now = new Date();
        const hoursSinceCompletion = (now - lastCompletion) / (1000 * 60 * 60);
        
        if (hoursSinceCompletion < quiz.cooldown_hours) {
            const hoursLeft = Math.ceil(quiz.cooldown_hours - hoursSinceCompletion);
            return res.status(400).json({ 
                error: `–ö–≤–∏–∑ –º–æ–∂–Ω–æ –ø—Ä–æ–π—Ç–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ —á–µ—Ä–µ–∑ ${hoursLeft} —á–∞—Å–æ–≤` 
            });
        }
    }
    
    let correctAnswers = 0;
    const results = quiz.questions.map((question, index) => {
        const isCorrect = answers[index] === question.correctAnswer;
        if (isCorrect) correctAnswers++;
        return {
            questionId: question.id,
            question: question.question,
            userAnswer: answers[index],
            correctAnswer: question.correctAnswer,
            isCorrect: isCorrect,
            explanation: question.explanation
        };
    });
    
    // –ò–°–ü–†–ê–í–õ–ï–ù–ù–û–ï –ù–ê–ß–ò–°–õ–ï–ù–ò–ï –ò–°–ö–†
    let sparksEarned = 0;
    const perfectScore = correctAnswers === quiz.questions.length;
    
    // –ù–∞—á–∏—Å–ª—è–µ–º –∏—Å–∫—Ä—ã –∑–∞ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã
    sparksEarned = correctAnswers * quiz.sparks_per_correct;
    
    // –î–æ–±–∞–≤–ª—è–µ–º –±–æ–Ω—É—Å –∑–∞ –∏–¥–µ–∞–ª—å–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç
    if (perfectScore) {
        sparksEarned += quiz.sparks_perfect_bonus;
    }
    
    if (existingCompletion) {
        existingCompletion.score = correctAnswers;
        existingCompletion.sparks_earned = sparksEarned;
        existingCompletion.perfect_score = perfectScore;
        existingCompletion.completed_at = new Date().toISOString();
    } else {
        db.quiz_completions.push({
            id: Date.now(),
            user_id: userId,
            quiz_id: quizId,
            completed_at: new Date().toISOString(),
            score: correctAnswers,
            total_questions: quiz.questions.length,
            sparks_earned: sparksEarned,
            perfect_score: perfectScore,
            time_spent: req.body.timeSpent || 0
        });
    }
    
    if (sparksEarned > 0) {
        addSparks(userId, sparksEarned, 'quiz', `–ö–≤–∏–∑: ${quiz.title}`);
    }
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    const user = db.users.find(u => u.user_id == userId);
    if (user) {
        user.completed_quizzes = db.quiz_completions.filter(qc => qc.user_id === userId).length;
    }
    
    res.json({
        success: true,
        correctAnswers,
        totalQuestions: quiz.questions.length,
        sparksEarned,
        perfectScore,
        scorePercentage: Math.round((correctAnswers / quiz.questions.length) * 100),
        results: results,
        message: perfectScore ? 
            `–ò–¥–µ–∞–ª—å–Ω–æ! üéâ +${sparksEarned}‚ú® (${correctAnswers}√ó${quiz.sparks_per_correct} + ${quiz.sparks_perfect_bonus} –±–æ–Ω—É—Å)` : 
            `–ü—Ä–∞–≤–∏–ª—å–Ω–æ: ${correctAnswers}/${quiz.questions.length}. +${sparksEarned}‚ú® (${correctAnswers}√ó${quiz.sparks_per_correct})`
    });
});

app.get('/api/webapp/marathons', (req, res) => {
    const userId = parseInt(req.query.userId);
    const marathons = db.marathons.filter(m => m.is_active);
    
    const marathonsWithStatus = marathons.map(marathon => {
        const completion = db.marathon_completions.find(
            mc => mc.user_id === userId && mc.marathon_id === marathon.id
        );
        
        const currentTask = completion ? marathon.tasks[completion.current_day - 1] : marathon.tasks[0];
        const submissions = db.marathon_submissions.filter(
            ms => ms.user_id === userId && ms.marathon_id === marathon.id
        );
        
        return {
            ...marathon,
            completed: completion ? completion.completed : false,
            current_day: completion ? completion.current_day : 1,
            progress: completion ? completion.progress : 0,
            started_at: completion ? completion.started_at : null,
            current_task: currentTask,
            submissions: submissions,
            can_continue: completion && !completion.completed
        };
    });
    
    res.json(marathonsWithStatus);
});

// –ù–û–í–´–ô –ú–ï–¢–û–î –î–õ–Ø –û–¢–ü–†–ê–í–ö–ò –†–ê–ë–û–¢–´ –í –ú–ê–†–ê–§–û–ù–ï
app.post('/api/webapp/marathons/:marathonId/submit-day', (req, res) => {
    const marathonId = parseInt(req.params.marathonId);
    const { userId, day, submission_text, submission_image } = req.body;
    
    if (!userId || !day) {
        return res.status(400).json({ error: 'User ID and day are required' });
    }
    
    const marathon = db.marathons.find(m => m.id === marathonId);
    if (!marathon) {
        return res.status(404).json({ error: 'Marathon not found' });
    }
    
    const task = marathon.tasks.find(t => t.day === day);
    if (!task) {
        return res.status(404).json({ error: 'Task not found' });
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –∑–∞–¥–∞–Ω–∏—é
    if (task.requires_submission && !submission_text && !submission_image) {
        return res.status(400).json({ error: '–≠—Ç–æ –∑–∞–¥–∞–Ω–∏–µ —Ç—Ä–µ–±—É–µ—Ç –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ä–∞–±–æ—Ç—ã' });
    }
    
    let completion = db.marathon_completions.find(
        mc => mc.user_id === userId && mc.marathon_id === marathonId
    );
    
    if (!completion) {
        completion = {
            id: Date.now(),
            user_id: userId,
            marathon_id: marathonId,
            current_day: 1,
            progress: 0,
            completed: false,
            started_at: new Date().toISOString(),
            last_activity: new Date().toISOString()
        };
        db.marathon_completions.push(completion);
    }
    
    if (completion.current_day !== day) {
        return res.status(400).json({ error: '–ù–µ–≤–µ—Ä–Ω—ã–π –¥–µ–Ω—å –º–∞—Ä–∞—Ñ–æ–Ω–∞' });
    }
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–∞–±–æ—Ç—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    if (submission_text || submission_image) {
        const existingSubmission = db.marathon_submissions.find(
            ms => ms.user_id === userId && ms.marathon_id === marathonId && ms.day === day
        );
        
        if (!existingSubmission) {
            db.marathon_submissions.push({
                id: Date.now(),
                user_id: userId,
                marathon_id: marathonId,
                day: day,
                submission_text: submission_text,
                submission_image: submission_image,
                submitted_at: new Date().toISOString(),
                status: 'pending'
            });
        }
    }
    
    // –ù–∞—á–∏—Å–ª—è–µ–º –∏—Å–∫—Ä—ã —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ä–∞–±–æ—Ç—ã
    const sparksEarned = marathon.sparks_per_day;
    addSparks(userId, sparksEarned, 'marathon_day', `–ú–∞—Ä–∞—Ñ–æ–Ω: ${marathon.title} - –¥–µ–Ω—å ${day}`);
    
    completion.current_day = day + 1;
    completion.progress = Math.round((day / marathon.duration_days) * 100);
    completion.last_activity = new Date().toISOString();
    
    if (day >= marathon.duration_days) {
        completion.completed = true;
        completion.progress = 100;
        completion.completed_at = new Date().toISOString();
        
        // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –Ω–∞–≥—Ä–∞–¥–∞ –∑–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ –º–∞—Ä–∞—Ñ–æ–Ω–∞
        const marathonBonus = marathon.sparks_completion_bonus;
        addSparks(userId, marathonBonus, 'marathon_completion', `–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –º–∞—Ä–∞—Ñ–æ–Ω–∞: ${marathon.title}`);
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        const user = db.users.find(u => u.user_id == userId);
        if (user) {
            user.completed_marathons = db.marathon_completions.filter(mc => mc.user_id === userId && mc.completed).length;
        }
    }
    
    res.json({
        success: true,
        sparksEarned,
        currentDay: completion.current_day,
        progress: completion.progress,
        completed: completion.completed,
        completionBonus: completion.completed ? marathon.sparks_completion_bonus : 0,
        message: completion.completed ? 
            `üéâ –ú–∞—Ä–∞—Ñ–æ–Ω –∑–∞–≤–µ—Ä—à–µ–Ω! +${sparksEarned}‚ú® (–¥–µ–Ω—å) + ${marathon.sparks_completion_bonus}‚ú® (–±–æ–Ω—É—Å)` : 
            `–î–µ–Ω—å ${day} –∑–∞–≤–µ—Ä—à–µ–Ω! +${sparksEarned}‚ú®`
    });
});

app.get('/api/webapp/shop/items', (req, res) => {
    const items = db.shop_items.filter(item => item.is_active);
    res.json(items);
});

// –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –ü–û–ö–£–ü–ö–ê –¢–û–í–ê–†–ê
app.post('/api/webapp/shop/purchase', (req, res) => {
    const { userId, itemId } = req.body;
    
    if (!userId || !itemId) {
        return res.status(400).json({ error: 'User ID and item ID are required' });
    }
    
    const user = db.users.find(u => u.user_id == userId);
    const item = db.shop_items.find(i => i.id == itemId && i.is_active);
    
    if (!user) return res.status(404).json({ error: 'User not found' });
    if (!item) return res.status(404).json({ error: 'Item not found' });
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –∫—É–ø–ª–µ–Ω –ª–∏ —É–∂–µ —Ç–æ–≤–∞—Ä
    const existingPurchase = db.purchases.find(
        p => p.user_id === userId && p.item_id === itemId
    );
    
    if (existingPurchase) {
        return res.status(400).json({ error: '–í—ã —É–∂–µ –∫—É–ø–∏–ª–∏ —ç—Ç–æ—Ç —Ç–æ–≤–∞—Ä' });
    }
    
    if (user.sparks < item.price) {
        return res.status(400).json({ error: '–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∏—Å–∫—Ä' });
    }
    
    // –°–ø–∏—Å–∞–Ω–∏–µ –∏—Å–∫—Ä
    user.sparks -= item.price;
    
    const purchase = {
        id: Date.now(),
        user_id: userId,
        item_id: itemId,
        price_paid: item.price,
        purchased_at: new Date().toISOString(),
        status: 'completed'
    };
    
    db.purchases.push(purchase);
    
    addSparks(userId, -item.price, 'purchase', `–ü–æ–∫—É–ø–∫–∞: ${item.title}`);
    
    // –°–æ–∑–¥–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –ø–æ–∫—É–ø–∫–µ
    const notification = {
        id: Date.now(),
        user_id: userId,
        title: "üõí –ü–æ–∫—É–ø–∫–∞ —Å–æ–≤–µ—Ä—à–µ–Ω–∞!",
        message: `–í—ã –ø—Ä–∏–æ–±—Ä–µ–ª–∏ "${item.title}" –∑–∞ ${item.price}‚ú®`,
        type: "purchase",
        is_read: false,
        created_at: new Date().toISOString()
    };
    db.notifications.push(notification);
    
    res.json({
        success: true,
        message: `–ü–æ–∫—É–ø–∫–∞ —É—Å–ø–µ—à–Ω–∞! –ö—É–ø–ª–µ–Ω–æ: ${item.title}`,
        remainingSparks: user.sparks,
        purchase: purchase
    });
});

app.get('/api/webapp/users/:userId/purchases', (req, res) => {
    const userId = parseInt(req.params.userId);
    const userPurchases = db.purchases
        .filter(p => p.user_id === userId)
        .map(purchase => {
            const item = db.shop_items.find(i => i.id === purchase.item_id);
            return { 
                ...purchase, 
                title: item?.title,
                description: item?.description,
                type: item?.type,
                file_url: item?.file_url,
                content_text: item?.content_text,
                preview_url: item?.preview_url,
                file_data: item?.file_url?.startsWith('data:') ? item.file_url : null,
                preview_data: item?.preview_url?.startsWith('data:') ? item.preview_url : null
            };
        })
        .sort((a, b) => new Date(b.purchased_at) - new Date(a.purchased_at));
        
    res.json({ purchases: userPurchases });
});

app.get('/api/webapp/users/:userId/activities', (req, res) => {
    const userId = parseInt(req.params.userId);
    const userActivities = db.activities
        .filter(a => a.user_id === userId)
        .sort((a, b) => new Date(b.created_at) - new Date(a.created_at))
        .slice(0, 50);
    res.json({ activities: userActivities });
});

// –†–∞–±–æ—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
app.post('/api/webapp/upload-work', (req, res) => {
    const { userId, title, description, imageUrl, type, category, tags } = req.body;
    
    if (!userId || !title || !imageUrl) {
        return res.status(400).json({ error: 'User ID, title and image URL are required' });
    }
    
    const user = db.users.find(u => u.user_id == userId);
    if (!user) return res.status(404).json({ error: 'User not found' });
    
    const newWork = {
        id: Date.now(),
        user_id: userId,
        title,
        description: description || '',
        image_url: imageUrl,
        type: type || 'image',
        category: category || 'other',
        tags: tags || [],
        status: 'pending',
        created_at: new Date().toISOString(),
        moderated_at: null,
        moderator_id: null,
        admin_comment: null,
        likes_count: 0,
        comments_count: 0
    };
    
    db.user_works.push(newWork);
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    user.uploaded_works = db.user_works.filter(w => w.user_id === userId).length;
    
    addSparks(userId, SPARKS_SYSTEM.UPLOAD_WORK, 'upload_work', `–ó–∞–≥—Ä—É–∑–∫–∞ —Ä–∞–±–æ—Ç—ã: ${title}`);
    
    res.json({
        success: true,
        message: `–†–∞–±–æ—Ç–∞ —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω–∞! –ü–æ–ª—É—á–µ–Ω–æ +${SPARKS_SYSTEM.UPLOAD_WORK}‚ú®. –ü–æ—Å–ª–µ –æ–¥–æ–±—Ä–µ–Ω–∏—è –≤—ã –ø–æ–ª—É—á–∏—Ç–µ +${SPARKS_SYSTEM.WORK_APPROVED}‚ú®`,
        workId: newWork.id,
        work: newWork
    });
});

app.get('/api/webapp/users/:userId/works', (req, res) => {
    const userId = parseInt(req.params.userId);
    const userWorks = db.user_works
        .filter(w => w.user_id === userId)
        .sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
    res.json({ works: userWorks });
});

// –ü–æ—Å—Ç—ã –∫–∞–Ω–∞–ª–∞
app.get('/api/webapp/channel-posts', (req, res) => {
    const posts = db.channel_posts
        .filter(p => p.is_active)
        .map(post => {
            const reviews = db.post_reviews.filter(r => r.post_id === post.post_id);
            const userReviews = req.query.userId ? 
                db.post_reviews.filter(r => r.user_id === parseInt(req.query.userId) && r.post_id === post.post_id) : [];
            
            return {
                ...post,
                reviews_count: reviews.length,
                average_rating: reviews.length > 0 ? 
                    reviews.reduce((sum, r) => sum + r.rating, 0) / reviews.length : 0,
                user_review: userReviews.length > 0 ? userReviews[0] : null
            };
        })
        .sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
        
    res.json({ posts: posts });
});

app.post('/api/webapp/posts/:postId/review', (req, res) => {
    const postId = req.params.postId;
    const { userId, reviewText, rating } = req.body;
    
    if (!userId || !reviewText) {
        return res.status(400).json({ error: 'User ID and review text are required' });
    }
    
    const post = db.channel_posts.find(p => p.post_id === postId);
    if (!post) {
        return res.status(404).json({ error: 'Post not found' });
    }
    
    const existingReview = db.post_reviews.find(
        r => r.user_id === userId && r.post_id === postId
    );
    
    if (existingReview) {
        return res.status(400).json({ error: '–í—ã —É–∂–µ –æ—Å—Ç–∞–≤–ª—è–ª–∏ –æ—Ç–∑—ã–≤ –Ω–∞ —ç—Ç–æ—Ç –ø–æ—Å—Ç' });
    }
    
    const today = new Date().toDateString();
    const todayReviews = db.daily_reviews.filter(
        dr => dr.user_id === userId && new Date(dr.date).toDateString() === today
    );
    
    let sparksEarned = SPARKS_SYSTEM.WRITE_REVIEW;
    
    if (todayReviews.length === 0) {
        sparksEarned += SPARKS_SYSTEM.DAILY_COMMENT;
        
        db.daily_reviews.push({
            id: Date.now(),
            user_id: userId,
            date: new Date().toISOString(),
            type: 'daily_comment'
        });
    }
    
    const newReview = {
        id: Date.now(),
        user_id: userId,
        post_id: postId,
        review_text: reviewText,
        rating: rating || 5,
        status: 'pending',
        created_at: new Date().toISOString(),
        moderated_at: null,
        moderator_id: null,
        admin_comment: null
    };
    
    db.post_reviews.push(newReview);
    
    addSparks(userId, sparksEarned, 'post_review', `–û—Ç–∑—ã–≤ –∫ –ø–æ—Å—Ç—É: ${post.title}`);
    
    const message = todayReviews.length === 0 
        ? `–û—Ç–∑—ã–≤ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω! +${sparksEarned}‚ú® (3 –∑–∞ –æ—Ç–∑—ã–≤ + 1 –∑–∞ –ø–µ—Ä–≤—ã–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π —Å–µ–≥–æ–¥–Ω—è)`
        : `–û—Ç–∑—ã–≤ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω! +${sparksEarned}‚ú®`;
    
    res.json({
        success: true,
        message: message,
        reviewId: newReview.id,
        sparksEarned: sparksEarned
    });
});

// API –î–õ–Ø –ò–ù–¢–ï–†–ê–ö–¢–ò–í–û–í
app.get('/api/webapp/interactives', (req, res) => {
    const userId = parseInt(req.query.userId);
    const interactives = db.interactives.filter(i => i.is_active);
    
    const interactivesWithStatus = interactives.map(interactive => {
        const completion = db.interactive_completions.find(
            ic => ic.user_id === userId && ic.interactive_id === interactive.id
        );
        
        return {
            ...interactive,
            completed: !!completion,
            user_score: completion ? completion.score : 0,
            can_retake: interactive.allow_retake && (!completion || interactive.allow_retake)
        };
    });
    
    res.json(interactivesWithStatus);
});

app.post('/api/webapp/interactives/:interactiveId/submit', (req, res) => {
    const interactiveId = parseInt(req.params.interactiveId);
    const { userId, answer } = req.body;
    
    if (!userId) {
        return res.status(400).json({ error: 'User ID is required' });
    }
    
    const interactive = db.interactives.find(i => i.id === interactiveId);
    if (!interactive) {
        return res.status(404).json({ error: 'Interactive not found' });
    }
    
    const existingCompletion = db.interactive_completions.find(
        ic => ic.user_id === userId && ic.interactive_id === interactiveId
    );
    
    if (existingCompletion && !interactive.allow_retake) {
        return res.status(400).json({ error: '–í—ã —É–∂–µ –ø—Ä–æ—à–ª–∏ —ç—Ç–æ—Ç –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤' });
    }
    
    const isCorrect = answer === interactive.correct_answer;
    const sparksEarned = isCorrect ? interactive.sparks_reward : 0;
    
    if (existingCompletion) {
        existingCompletion.score = isCorrect ? 1 : 0;
        existingCompletion.sparks_earned = sparksEarned;
        existingCompletion.completed_at = new Date().toISOString();
        existingCompletion.answer = answer;
    } else {
        db.interactive_completions.push({
            id: Date.now(),
            user_id: userId,
            interactive_id: interactiveId,
            completed_at: new Date().toISOString(),
            score: isCorrect ? 1 : 0,
            sparks_earned: sparksEarned,
            answer: answer,
            time_spent: req.body.timeSpent || 0
        });
    }
    
    if (sparksEarned > 0) {
        addSparks(userId, sparksEarned, 'interactive', `–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤: ${interactive.title}`);
    }
    
    res.json({
        success: true,
        correct: isCorrect,
        score: isCorrect ? 1 : 0,
        sparksEarned: sparksEarned,
        message: isCorrect ? 
            `–ü—Ä–∞–≤–∏–ª—å–Ω–æ! +${sparksEarned}‚ú®` : 
            '–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑!'
    });
});

// API –¥–ª—è –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π
app.get('/api/webapp/users/:userId/achievements', (req, res) => {
    const userId = parseInt(req.params.userId);
    
    const userAchievements = db.user_achievements
        .filter(ua => ua.user_id === userId)
        .map(ua => {
            const achievement = db.achievements.find(a => a.id === ua.achievement_id);
            return {
                ...ua,
                title: achievement?.title,
                description: achievement?.description,
                icon: achievement?.icon,
                sparks_reward: achievement?.sparks_reward
            };
        })
        .sort((a, b) => new Date(b.earned_at) - new Date(a.earned_at));
    
    const availableAchievements = db.achievements
        .filter(a => a.is_active)
        .map(achievement => {
            const userAchievement = userAchievements.find(ua => ua.achievement_id === achievement.id);
            return {
                ...achievement,
                earned: !!userAchievement,
                earned_at: userAchievement ? userAchievement.earned_at : null,
                sparks_claimed: userAchievement ? userAchievement.sparks_claimed : false
            };
        });
    
    res.json({
        earned: userAchievements,
        available: availableAchievements
    });
});

app.post('/api/webapp/achievements/:achievementId/claim', (req, res) => {
    const achievementId = parseInt(req.params.achievementId);
    const { userId } = req.body;
    
    if (!userId) {
        return res.status(400).json({ error: 'User ID is required' });
    }
    
    const userAchievement = db.user_achievements.find(
        ua => ua.user_id === userId && ua.achievement_id === achievementId
    );
    
    if (!userAchievement) {
        return res.status(404).json({ error: '–î–æ—Å—Ç–∏–∂–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ' });
    }
    
    if (userAchievement.sparks_claimed) {
        return res.status(400).json({ error: '–ù–∞–≥—Ä–∞–¥–∞ —É–∂–µ –ø–æ–ª—É—á–µ–Ω–∞' });
    }
    
    const achievement = db.achievements.find(a => a.id === achievementId);
    if (!achievement) {
        return res.status(404).json({ error: '–î–æ—Å—Ç–∏–∂–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ' });
    }
    
    // –ù–∞—á–∏—Å–ª—è–µ–º –∏—Å–∫—Ä—ã
    addSparks(userId, achievement.sparks_reward, 'achievement', `–î–æ—Å—Ç–∏–∂–µ–Ω–∏–µ: ${achievement.title}`);
    
    // –û—Ç–º–µ—á–∞–µ–º –∫–∞–∫ –ø–æ–ª—É—á–µ–Ω–Ω–æ–µ
    userAchievement.sparks_claimed = true;
    
    res.json({
        success: true,
        message: `–ü–æ–ª—É—á–µ–Ω–æ ${achievement.sparks_reward}‚ú® –∑–∞ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–µ "${achievement.title}"`,
        sparksEarned: achievement.sparks_reward
    });
});

// API –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
app.get('/api/webapp/users/:userId/notifications', (req, res) => {
    const userId = parseInt(req.params.userId);
    const { unread_only } = req.query;
    
    let notifications = db.notifications.filter(n => n.user_id === userId);
    
    if (unread_only === 'true') {
        notifications = notifications.filter(n => !n.is_read);
    }
    
    notifications = notifications.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
    
    res.json({ notifications });
});

app.post('/api/webapp/notifications/:notificationId/read', (req, res) => {
    const notificationId = parseInt(req.params.notificationId);
    const { userId } = req.body;
    
    const notification = db.notifications.find(
        n => n.id === notificationId && n.user_id === userId
    );
    
    if (!notification) {
        return res.status(404).json({ error: '–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ' });
    }
    
    notification.is_read = true;
    
    res.json({ success: true, message: '–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–º–µ—á–µ–Ω–æ –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω–æ–µ' });
});

app.post('/api/webapp/notifications/mark-all-read', (req, res) => {
    const { userId } = req.body;
    
    const userNotifications = db.notifications.filter(n => n.user_id === userId && !n.is_read);
    userNotifications.forEach(notification => {
        notification.is_read = true;
    });
    
    res.json({ 
        success: true, 
        message: `–í—Å–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ—Ç–º–µ—á–µ–Ω—ã –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ`,
        marked_count: userNotifications.length 
    });
});

// Admin API
app.get('/api/admin/stats', requireAdmin, (req, res) => {
    const stats = {
        totalUsers: db.users.length,
        registeredUsers: db.users.filter(u => u.is_registered).length,
        activeUsers: db.users.filter(u => {
            const lastActive = new Date(u.last_active);
            const thirtyDaysAgo = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000);
            return lastActive > thirtyDaysAgo;
        }).length,
        newUsersToday: db.users.filter(u => {
            const today = new Date().toDateString();
            return new Date(u.registration_date).toDateString() === today;
        }).length,
        activeQuizzes: db.quizzes.filter(q => q.is_active).length,
        activeMarathons: db.marathons.filter(m => m.is_active).length,
        shopItems: db.shop_items.filter(i => i.is_active).length,
        totalSparks: db.users.reduce((sum, user) => sum + user.sparks, 0),
        totalAdmins: db.admins.length,
        pendingReviews: db.post_reviews.filter(r => r.status === 'pending').length,
        pendingWorks: db.user_works.filter(w => w.status === 'pending').length,
        totalPosts: db.channel_posts.filter(p => p.is_active).length,
        totalPurchases: db.purchases.length,
        totalActivities: db.activities.length,
        interactives: db.interactives.filter(i => i.is_active).length,
        totalEarnedSparks: db.activities.reduce((sum, a) => sum + a.sparks_earned, 0),
        totalSpentSparks: db.purchases.reduce((sum, p) => sum + p.price_paid, 0)
    };
    res.json(stats);
});

// –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–∞–º–∏
app.get('/api/admin/interactives', requireAdmin, (req, res) => {
    const interactives = db.interactives.map(interactive => {
        const completions = db.interactive_completions.filter(ic => ic.interactive_id === interactive.id);
        
        return {
            ...interactive,
            completions_count: completions.length,
            average_score: completions.length > 0 ? 
                completions.reduce((sum, ic) => sum + ic.score, 0) / completions.length : 0,
            success_rate: completions.length > 0 ? 
                (completions.filter(ic => ic.score > 0).length / completions.length) * 100 : 0
        };
    });
    res.json(interactives);
});

app.post('/api/admin/interactives', requireAdmin, (req, res) => {
    const { title, description, type, category, image_url, question, options, correct_answer, sparks_reward, allow_retake, difficulty } = req.body;
    
    if (!title || !type || !category || !question) {
        return res.status(400).json({ error: 'Title, type, category and question are required' });
    }
    
    const newInteractive = {
        id: Date.now(),
        title,
        description: description || '',
        type,
        category,
        image_url: image_url || '',
        question: question,
        options: options || [],
        correct_answer: correct_answer || 0,
        sparks_reward: sparks_reward || SPARKS_SYSTEM.INTERACTIVE_COMPLETION,
        allow_retake: allow_retake || false,
        difficulty: difficulty || 'beginner',
        is_active: true,
        created_at: new Date().toISOString(),
        attempts_count: 0,
        success_rate: 0
    };
    
    db.interactives.push(newInteractive);
    
    res.json({ 
        success: true, 
        message: '–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω', 
        interactiveId: newInteractive.id,
        interactive: newInteractive
    });
});

app.put('/api/admin/interactives/:interactiveId', requireAdmin, (req, res) => {
    const interactiveId = parseInt(req.params.interactiveId);
    const { title, description, type, category, image_url, question, options, correct_answer, sparks_reward, allow_retake, is_active, difficulty } = req.body;
    
    const interactive = db.interactives.find(i => i.id === interactiveId);
    if (!interactive) {
        return res.status(404).json({ error: 'Interactive not found' });
    }
    
    if (title) interactive.title = title;
    if (description) interactive.description = description;
    if (type) interactive.type = type;
    if (category) interactive.category = category;
    if (image_url) interactive.image_url = image_url;
    if (question) interactive.question = question;
    if (options) interactive.options = options;
    if (correct_answer !== undefined) interactive.correct_answer = correct_answer;
    if (sparks_reward !== undefined) interactive.sparks_reward = sparks_reward;
    if (allow_retake !== undefined) interactive.allow_retake = allow_retake;
    if (is_active !== undefined) interactive.is_active = is_active;
    if (difficulty) interactive.difficulty = difficulty;
    
    res.json({ 
        success: true, 
        message: '–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω',
        interactive: interactive
    });
});

app.delete('/api/admin/interactives/:interactiveId', requireAdmin, (req, res) => {
    const interactiveId = parseInt(req.params.interactiveId);
    const interactiveIndex = db.interactives.findIndex(i => i.id === interactiveId);
    
    if (interactiveIndex === -1) {
        return res.status(404).json({ error: 'Interactive not found' });
    }
    
    db.interactives.splice(interactiveIndex, 1);
    res.json({ success: true, message: '–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤ —É–¥–∞–ª–µ–Ω' });
});

// –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–æ–ª—è–º–∏
app.get('/api/admin/roles', requireAdmin, (req, res) => {
    const roles = db.roles.map(role => {
        const usersCount = db.users.filter(u => u.class === role.name).length;
        return {
            ...role,
            users_count: usersCount
        };
    });
    res.json(roles);
});

app.post('/api/admin/roles', requireAdmin, (req, res) => {
    const { name, description, icon, available_buttons, color, requirements } = req.body;
    
    if (!name || !description) {
        return res.status(400).json({ error: 'Name and description are required' });
    }
    
    const newRole = {
        id: Date.now(),
        name,
        description,
        icon: icon || 'üé®',
        available_buttons: available_buttons || ['quiz', 'marathon', 'works', 'activities', 'posts', 'shop', 'invite', 'interactives', 'change_role'],
        color: color || '#667eea',
        requirements: requirements || '',
        is_active: true,
        created_at: new Date().toISOString()
    };
    
    db.roles.push(newRole);
    
    res.json({ 
        success: true, 
        message: '–†–æ–ª—å —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–∞', 
        role: newRole
    });
});

app.put('/api/admin/roles/:roleId', requireAdmin, (req, res) => {
    const roleId = parseInt(req.params.roleId);
    const { name, description, icon, available_buttons, is_active, color, requirements } = req.body;
    
    const role = db.roles.find(r => r.id === roleId);
    if (!role) {
        return res.status(404).json({ error: 'Role not found' });
    }
    
    if (name) role.name = name;
    if (description) role.description = description;
    if (icon) role.icon = icon;
    if (available_buttons) role.available_buttons = available_buttons;
    if (is_active !== undefined) role.is_active = is_active;
    if (color) role.color = color;
    if (requirements) role.requirements = requirements;
    
    res.json({ 
        success: true, 
        message: '–†–æ–ª—å —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∞',
        role: role
    });
});

app.delete('/api/admin/roles/:roleId', requireAdmin, (req, res) => {
    const roleId = parseInt(req.params.roleId);
    const roleIndex = db.roles.findIndex(r => r.id === roleId);
    
    if (roleIndex === -1) {
        return res.status(404).json({ error: 'Role not found' });
    }
    
    const usersWithRole = db.users.filter(u => u.class === db.roles[roleIndex].name);
    if (usersWithRole.length > 0) {
        return res.status(400).json({ error: '–ù–µ–ª—å–∑—è —É–¥–∞–ª–∏—Ç—å —Ä–æ–ª—å, —É –∫–æ—Ç–æ—Ä–æ–π –µ—Å—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏' });
    }
    
    db.roles.splice(roleIndex, 1);
    res.json({ success: true, message: '–†–æ–ª—å —É–¥–∞–ª–µ–Ω–∞' });
});

// –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞–º–∏
app.get('/api/admin/characters', requireAdmin, (req, res) => {
    const characters = db.characters.map(character => {
        const role = db.roles.find(r => r.id === character.role_id);
        const usersCount = db.users.filter(u => u.character_id === character.id).length;
        return {
            ...character,
            role_name: role?.name,
            users_count: usersCount
        };
    });
    res.json(characters);
});

app.post('/api/admin/characters', requireAdmin, (req, res) => {
    const { role_id, name, description, bonus_type, bonus_value, bonus_description, avatar, personality } = req.body;
    
    if (!role_id || !name || !bonus_type || !bonus_value) {
        return res.status(400).json({ error: 'Role ID, name, bonus type and value are required' });
    }
    
    const newCharacter = {
        id: Date.now(),
        role_id: parseInt(role_id),
        name,
        description: description || '',
        bonus_type,
        bonus_value,
        bonus_description: bonus_description || '',
        avatar: avatar || 'üë§',
        personality: personality || '',
        is_active: true,
        created_at: new Date().toISOString()
    };
    
    db.characters.push(newCharacter);
    
    res.json({ 
        success: true, 
        message: '–ü–µ—Ä—Å–æ–Ω–∞–∂ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω', 
        character: newCharacter
    });
});

app.put('/api/admin/characters/:characterId', requireAdmin, (req, res) => {
    const characterId = parseInt(req.params.characterId);
    const { name, description, bonus_type, bonus_value, bonus_description, is_active, avatar, personality } = req.body;
    
    const character = db.characters.find(c => c.id === characterId);
    if (!character) {
        return res.status(404).json({ error: 'Character not found' });
    }
    
    if (name) character.name = name;
    if (description) character.description = description;
    if (bonus_type) character.bonus_type = bonus_type;
    if (bonus_value) character.bonus_value = bonus_value;
    if (bonus_description) character.bonus_description = bonus_description;
    if (is_active !== undefined) character.is_active = is_active;
    if (avatar) character.avatar = avatar;
    if (personality) character.personality = personality;
    
    res.json({ 
        success: true, 
        message: '–ü–µ—Ä—Å–æ–Ω–∞–∂ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω',
        character: character
    });
});

app.delete('/api/admin/characters/:characterId', requireAdmin, (req, res) => {
    const characterId = parseInt(req.params.characterId);
    const characterIndex = db.characters.findIndex(c => c.id === characterId);
    
    if (characterIndex === -1) {
        return res.status(404).json({ error: 'Character not found' });
    }
    
    const usersWithCharacter = db.users.filter(u => u.character_id === characterId);
    if (usersWithCharacter.length > 0) {
        return res.status(400).json({ error: '–ù–µ–ª—å–∑—è —É–¥–∞–ª–∏—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–∂–∞, —É –∫–æ—Ç–æ—Ä–æ–≥–æ –µ—Å—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏' });
    }
    
    db.characters.splice(characterIndex, 1);
    res.json({ success: true, message: '–ü–µ—Ä—Å–æ–Ω–∞–∂ —É–¥–∞–ª–µ–Ω' });
});

// –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–∞–≥–∞–∑–∏–Ω–æ–º
app.get('/api/admin/shop/items', requireAdmin, (req, res) => {
    const items = db.shop_items.map(item => {
        const purchasesCount = db.purchases.filter(p => p.item_id === item.id).length;
        const totalRevenue = db.purchases
            .filter(p => p.item_id === item.id)
            .reduce((sum, p) => sum + p.price_paid, 0);
            
        return {
            ...item,
            purchases_count: purchasesCount,
            total_revenue: totalRevenue
        };
    });
    res.json(items);
});

app.post('/api/admin/shop/items', requireAdmin, (req, res) => {
    const { title, description, type, file_url, preview_url, price, content_text, category, difficulty, duration, instructor, features } = req.body;
    
    if (!title || !price) {
        return res.status(400).json({ error: 'Title and price are required' });
    }
    
    const newItem = {
        id: Date.now(),
        title,
        description: description || '',
        type: type || 'video',
        file_url: file_url || '',
        preview_url: preview_url || '',
        price: parseFloat(price),
        content_text: content_text || '',
        category: category || 'general',
        difficulty: difficulty || 'beginner',
        duration: duration || '',
        instructor: instructor || '',
        features: features || [],
        is_active: true,
        created_at: new Date().toISOString(),
        rating: 0,
        students_count: 0
    };
    
    db.shop_items.push(newItem);
    
    res.json({ 
        success: true, 
        message: '–¢–æ–≤–∞—Ä —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω', 
        itemId: newItem.id,
        item: newItem
    });
});

app.put('/api/admin/shop/items/:itemId', requireAdmin, (req, res) => {
    const itemId = parseInt(req.params.itemId);
    const { title, description, type, file_url, preview_url, price, content_text, is_active, category, difficulty, duration, instructor, features } = req.body;
    
    const item = db.shop_items.find(i => i.id === itemId);
    if (!item) {
        return res.status(404).json({ error: 'Item not found' });
    }
    
    if (title) item.title = title;
    if (description) item.description = description;
    if (type) item.type = type;
    if (file_url !== undefined) item.file_url = file_url;
    if (preview_url !== undefined) item.preview_url = preview_url;
    if (price) item.price = parseFloat(price);
    if (content_text) item.content_text = content_text;
    if (is_active !== undefined) item.is_active = is_active;
    if (category) item.category = category;
    if (difficulty) item.difficulty = difficulty;
    if (duration) item.duration = duration;
    if (instructor) item.instructor = instructor;
    if (features) item.features = features;
    
    res.json({ 
        success: true, 
        message: '–¢–æ–≤–∞—Ä —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω',
        item: item
    });
});

app.delete('/api/admin/shop/items/:itemId', requireAdmin, (req, res) => {
    const itemId = parseInt(req.params.itemId);
    const itemIndex = db.shop_items.findIndex(i => i.id === itemId);
    
    if (itemIndex === -1) {
        return res.status(404).json({ error: 'Item not found' });
    }
    
    db.shop_items.splice(itemIndex, 1);
    res.json({ success: true, message: '–¢–æ–≤–∞—Ä —É–¥–∞–ª–µ–Ω' });
});

// –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–≤–∏–∑–∞–º–∏
app.get('/api/admin/quizzes', requireAdmin, (req, res) => {
    const quizzes = db.quizzes.map(quiz => {
        const completions = db.quiz_completions.filter(qc => qc.quiz_id === quiz.id);
        const perfectCompletions = completions.filter(qc => qc.perfect_score).length;
        
        return {
            ...quiz,
            completions_count: completions.length,
            average_score: completions.length > 0 ? 
                completions.reduce((sum, qc) => sum + qc.score, 0) / completions.length : 0,
            perfect_completions: perfectCompletions,
            success_rate: completions.length > 0 ? 
                (completions.filter(qc => qc.score >= quiz.questions.length / 2).length / completions.length) * 100 : 0
        };
    });
    res.json(quizzes);
});

app.post('/api/admin/quizzes', requireAdmin, (req, res) => {
    const { title, description, questions, sparks_per_correct, sparks_perfect_bonus, cooldown_hours, allow_retake, difficulty, category, duration_minutes } = req.body;
    
    if (!title || !questions || !Array.isArray(questions)) {
        return res.status(400).json({ error: 'Title and questions array are required' });
    }
    
    const newQuiz = {
        id: Date.now(),
        title,
        description: description || '',
        questions: questions,
        sparks_per_correct: sparks_per_correct || SPARKS_SYSTEM.QUIZ_PER_CORRECT_ANSWER,
        sparks_perfect_bonus: sparks_perfect_bonus || SPARKS_SYSTEM.QUIZ_PERFECT_BONUS,
        cooldown_hours: cooldown_hours || 24,
        allow_retake: allow_retake || true,
        difficulty: difficulty || 'beginner',
        category: category || 'general',
        duration_minutes: duration_minutes || 10,
        is_active: true,
        created_at: new Date().toISOString(),
        attempts_count: 0,
        average_score: 0
    };
    
    db.quizzes.push(newQuiz);
    
    res.json({ 
        success: true, 
        message: '–ö–≤–∏–∑ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω', 
        quizId: newQuiz.id,
        quiz: newQuiz
    });
});

app.put('/api/admin/quizzes/:quizId', requireAdmin, (req, res) => {
    const quizId = parseInt(req.params.quizId);
    const { title, description, questions, sparks_per_correct, sparks_perfect_bonus, cooldown_hours, allow_retake, is_active, difficulty, category, duration_minutes } = req.body;
    
    const quiz = db.quizzes.find(q => q.id === quizId);
    if (!quiz) {
        return res.status(404).json({ error: 'Quiz not found' });
    }
    
    if (title) quiz.title = title;
    if (description) quiz.description = description;
    if (questions) quiz.questions = questions;
    if (sparks_per_correct !== undefined) quiz.sparks_per_correct = sparks_per_correct;
    if (sparks_perfect_bonus !== undefined) quiz.sparks_perfect_bonus = sparks_perfect_bonus;
    if (cooldown_hours !== undefined) quiz.cooldown_hours = cooldown_hours;
    if (allow_retake !== undefined) quiz.allow_retake = allow_retake;
    if (is_active !== undefined) quiz.is_active = is_active;
    if (difficulty) quiz.difficulty = difficulty;
    if (category) quiz.category = category;
    if (duration_minutes) quiz.duration_minutes = duration_minutes;
    
    res.json({ 
        success: true, 
        message: '–ö–≤–∏–∑ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω',
        quiz: quiz
    });
});

app.delete('/api/admin/quizzes/:quizId', requireAdmin, (req, res) => {
    const quizId = parseInt(req.params.quizId);
    const quizIndex = db.quizzes.findIndex(q => q.id === quizId);
    
    if (quizIndex === -1) {
        return res.status(404).json({ error: 'Quiz not found' });
    }
    
    db.quizzes.splice(quizIndex, 1);
    res.json({ success: true, message: '–ö–≤–∏–∑ —É–¥–∞–ª–µ–Ω' });
});

// –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–∞—Ä–∞—Ñ–æ–Ω–∞–º–∏
app.get('/api/admin/marathons', requireAdmin, (req, res) => {
    const marathons = db.marathons.map(marathon => {
        const completions = db.marathon_completions.filter(mc => mc.marathon_id === marathon.id);
        const activeParticipants = completions.filter(mc => !mc.completed).length;
        const completedParticipants = completions.filter(mc => mc.completed).length;
        
        return {
            ...marathon,
            completions_count: completions.length,
            active_participants: activeParticipants,
            completed_participants: completedParticipants,
            completion_rate: completions.length > 0 ? 
                (completedParticipants / completions.length) * 100 : 0
        };
    });
    res.json(marathons);
});

app.post('/api/admin/marathons', requireAdmin, (req, res) => {
    const { title, description, duration_days, tasks, sparks_per_day, sparks_completion_bonus, difficulty, category, requirements, cover_image } = req.body;
    
    if (!title || !duration_days || !tasks || !Array.isArray(tasks)) {
        return res.status(400).json({ error: 'Title, duration and tasks array are required' });
    }
    
    const newMarathon = {
        id: Date.now(),
        title,
        description: description || '',
        duration_days: parseInt(duration_days),
        tasks: tasks,
        sparks_per_day: sparks_per_day || SPARKS_SYSTEM.MARATHON_DAY_COMPLETION,
        sparks_completion_bonus: sparks_completion_bonus || SPARKS_SYSTEM.MARATHON_COMPLETION_BONUS,
        difficulty: difficulty || 'beginner',
        category: category || 'general',
        requirements: requirements || '',
        cover_image: cover_image || '',
        is_active: true,
        created_at: new Date().toISOString(),
        participants_count: 0,
        completion_rate: 0
    };
    
    db.marathons.push(newMarathon);
    
    res.json({ 
        success: true, 
        message: '–ú–∞—Ä–∞—Ñ–æ–Ω —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω', 
        marathonId: newMarathon.id,
        marathon: newMarathon
    });
});

app.put('/api/admin/marathons/:marathonId', requireAdmin, (req, res) => {
    const marathonId = parseInt(req.params.marathonId);
    const { title, description, duration_days, tasks, sparks_per_day, sparks_completion_bonus, is_active, difficulty, category, requirements, cover_image } = req.body;
    
    const marathon = db.marathons.find(m => m.id === marathonId);
    if (!marathon) {
        return res.status(404).json({ error: 'Marathon not found' });
    }
    
    if (title) marathon.title = title;
    if (description) marathon.description = description;
    if (duration_days) marathon.duration_days = parseInt(duration_days);
    if (tasks) marathon.tasks = tasks;
    if (sparks_per_day !== undefined) marathon.sparks_per_day = sparks_per_day;
    if (sparks_completion_bonus !== undefined) marathon.sparks_completion_bonus = sparks_completion_bonus;
    if (is_active !== undefined) marathon.is_active = is_active;
    if (difficulty) marathon.difficulty = difficulty;
    if (category) marathon.category = category;
    if (requirements) marathon.requirements = requirements;
    if (cover_image) marathon.cover_image = cover_image;
    
    res.json({ 
        success: true, 
        message: '–ú–∞—Ä–∞—Ñ–æ–Ω —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω',
        marathon: marathon
    });
});

app.delete('/api/admin/marathons/:marathonId', requireAdmin, (req, res) => {
    const marathonId = parseInt(req.params.marathonId);
    const marathonIndex = db.marathons.findIndex(m => m.id === marathonId);
    
    if (marathonIndex === -1) {
        return res.status(404).json({ error: 'Marathon not found' });
    }
    
    db.marathons.splice(marathonIndex, 1);
    res.json({ success: true, message: '–ú–∞—Ä–∞—Ñ–æ–Ω —É–¥–∞–ª–µ–Ω' });
});

// –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
app.get('/api/admin/user-works', requireAdmin, (req, res) => {
    const { status = 'pending' } = req.query;
    
    const works = db.user_works
        .filter(w => w.status === status)
        .map(work => {
            const user = db.users.find(u => u.user_id === work.user_id);
            return {
                ...work,
                user_name: user?.tg_first_name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ',
                user_username: user?.tg_username,
                user_level: user?.level
            };
        })
        .sort((a, b) => new Date(a.created_at) - new Date(b.created_at));
    
    res.json({ works });
});

app.post('/api/admin/user-works/:workId/moderate', requireAdmin, (req, res) => {
    const workId = parseInt(req.params.workId);
    const { status, admin_comment } = req.body;
    const adminId = req.admin.user_id;
    
    const work = db.user_works.find(w => w.id === workId);
    if (!work) {
        return res.status(404).json({ error: 'Work not found' });
    }
    
    work.status = status;
    work.moderated_at = new Date().toISOString();
    work.moderator_id = adminId;
    work.admin_comment = admin_comment || null;
    
    if (status === 'approved') {
        addSparks(work.user_id, SPARKS_SYSTEM.WORK_APPROVED, 'work_approved', `–†–∞–±–æ—Ç–∞ –æ–¥–æ–±—Ä–µ–Ω–∞: ${work.title}`);
        
        // –°–æ–∑–¥–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        const notification = {
            id: Date.now(),
            user_id: work.user_id,
            title: "‚ú® –†–∞–±–æ—Ç–∞ –æ–¥–æ–±—Ä–µ–Ω–∞!",
            message: `–í–∞—à–∞ —Ä–∞–±–æ—Ç–∞ "${work.title}" –±—ã–ª–∞ –æ–¥–æ–±—Ä–µ–Ω–∞ –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–æ–º. –í—ã –ø–æ–ª—É—á–∏–ª–∏ ${SPARKS_SYSTEM.WORK_APPROVED}‚ú®`,
            type: "work_approved",
            is_read: false,
            created_at: new Date().toISOString()
        };
        db.notifications.push(notification);
    } else if (status === 'rejected') {
        // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–∏
        const notification = {
            id: Date.now(),
            user_id: work.user_id,
            title: "‚ùå –†–∞–±–æ—Ç–∞ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∞",
            message: `–í–∞—à–∞ —Ä–∞–±–æ—Ç–∞ "${work.title}" –±—ã–ª–∞ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∞ –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–æ–º.${admin_comment ? ` –ü—Ä–∏—á–∏–Ω–∞: ${admin_comment}` : ''}`,
            type: "work_rejected",
            is_read: false,
            created_at: new Date().toISOString()
        };
        db.notifications.push(notification);
    }
    
    res.json({ 
        success: true, 
        message: `–†–∞–±–æ—Ç–∞ ${status === 'approved' ? '–æ–¥–æ–±—Ä–µ–Ω–∞' : '–æ—Ç–∫–ª–æ–Ω–µ–Ω–∞'}`,
        work: work
    });
});

// –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ—Å—Ç–∞–º–∏
app.get('/api/admin/channel-posts', requireAdmin, (req, res) => {
    const posts = db.channel_posts.map(post => {
        const admin = db.admins.find(a => a.user_id === post.admin_id);
        const reviews = db.post_reviews.filter(r => r.post_id === post.post_id);
        return {
            ...post,
            admin_username: admin?.username,
            reviews_count: reviews.length,
            average_rating: reviews.length > 0 ? 
                reviews.reduce((sum, r) => sum + r.rating, 0) / reviews.length : 0
        };
    }).sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
    
    res.json({ posts });
});

app.post('/api/admin/channel-posts', requireAdmin, (req, res) => {
    const { post_id, title, content, image_url, video_url, media_type, action_type, action_target } = req.body;
    
    if (!post_id || !title) {
        return res.status(400).json({ error: 'Post ID and title are required' });
    }
    
    const existingPost = db.channel_posts.find(p => p.post_id === post_id);
    if (existingPost) {
        return res.status(400).json({ error: 'Post with this ID already exists' });
    }
    
    const newPost = {
        id: Date.now(),
        post_id,
        title,
        content: content || '',
        image_url: image_url || '',
        video_url: video_url || '',
        media_type: media_type || 'text',
        admin_id: req.admin.user_id,
        created_at: new Date().toISOString(),
        is_active: true,
        telegram_message_id: null,
        action_type: action_type || null,
        action_target: action_target || null,
        likes_count: 0,
        comments_count: 0
    };
    
    db.channel_posts.push(newPost);
    
    res.json({ 
        success: true, 
        message: '–ü–æ—Å—Ç —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω', 
        postId: newPost.id,
        post: newPost
    });
});

app.put('/api/admin/channel-posts/:postId', requireAdmin, (req, res) => {
    const postId = parseInt(req.params.postId);
    const { title, content, image_url, video_url, media_type, is_active, action_type, action_target } = req.body;
    
    const post = db.channel_posts.find(p => p.id === postId);
    if (!post) {
        return res.status(404).json({ error: 'Post not found' });
    }
    
    if (title) post.title = title;
    if (content) post.content = content;
    if (image_url) post.image_url = image_url;
    if (video_url) post.video_url = video_url;
    if (media_type) post.media_type = media_type;
    if (is_active !== undefined) post.is_active = is_active;
    if (action_type !== undefined) post.action_type = action_type;
    if (action_target !== undefined) post.action_target = action_target;
    
    res.json({ 
        success: true, 
        message: '–ü–æ—Å—Ç —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω',
        post: post
    });
});

app.delete('/api/admin/channel-posts/:postId', requireAdmin, (req, res) => {
    const postId = parseInt(req.params.postId);
    const postIndex = db.channel_posts.findIndex(p => p.id === postId);
    
    if (postIndex === -1) {
        return res.status(404).json({ error: 'Post not found' });
    }
    
    db.channel_posts.splice(postIndex, 1);
    res.json({ success: true, message: '–ü–æ—Å—Ç —É–¥–∞–ª–µ–Ω' });
});

// –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—Ç–∑—ã–≤–∞–º–∏
app.get('/api/admin/reviews', requireAdmin, (req, res) => {
    const { status = 'pending' } = req.query;
    
    const reviews = db.post_reviews
        .filter(r => r.status === status)
        .map(review => {
            const user = db.users.find(u => u.user_id === review.user_id);
            const post = db.channel_posts.find(p => p.post_id === review.post_id);
            const moderator = db.admins.find(a => a.user_id === review.moderator_id);
            return {
                ...review,
                tg_first_name: user?.tg_first_name,
                tg_username: user?.tg_username,
                post_title: post?.title,
                moderator_username: moderator?.username
            };
        })
        .sort((a, b) => new Date(a.created_at) - new Date(b.created_at));
    
    res.json({ reviews });
});

app.post('/api/admin/reviews/:reviewId/moderate', requireAdmin, (req, res) => {
    const reviewId = parseInt(req.params.reviewId);
    const { status, admin_comment } = req.body;
    const adminId = req.admin.user_id;
    
    const review = db.post_reviews.find(r => r.id === reviewId);
    if (!review) {
        return res.status(404).json({ error: 'Review not found' });
    }
    
    review.status = status;
    review.moderated_at = new Date().toISOString();
    review.moderator_id = adminId;
    review.admin_comment = admin_comment || null;
    
    res.json({ 
        success: true, 
        message: `–û—Ç–∑—ã–≤ ${status === 'approved' ? '–æ–¥–æ–±—Ä–µ–Ω' : '–æ—Ç–∫–ª–æ–Ω–µ–Ω'}`,
        review: review
    });
});

// –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω–∞–º–∏
app.get('/api/admin/admins', requireAdmin, (req, res) => {
    const admins = db.admins.map(admin => {
        const user = db.users.find(u => u.user_id === admin.user_id);
        return {
            ...admin,
            tg_first_name: user?.tg_first_name,
            tg_username: user?.tg_username
        };
    });
    res.json(admins);
});

app.post('/api/admin/admins', requireAdmin, (req, res) => {
    const { user_id, username, role, permissions } = req.body;
    
    if (!user_id) {
        return res.status(400).json({ error: 'User ID is required' });
    }
    
    const existingAdmin = db.admins.find(a => a.user_id == user_id);
    if (existingAdmin) {
        return res.status(400).json({ error: 'Admin already exists' });
    }
    
    const user = db.users.find(u => u.user_id == user_id);
    if (!user) {
        return res.status(404).json({ error: 'User not found' });
    }
    
    const newAdmin = {
        id: Date.now(),
        user_id: parseInt(user_id),
        username: username || user.tg_username || '',
        role: role || 'moderator',
        permissions: permissions || ['users', 'content', 'moderation'],
        created_at: new Date().toISOString(),
        last_login: new Date().toISOString()
    };
    
    db.admins.push(newAdmin);
    
    res.json({ 
        success: true, 
        message: '–ê–¥–º–∏–Ω —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω',
        admin: newAdmin
    });
});

app.delete('/api/admin/admins/:userId', requireAdmin, (req, res) => {
    const userId = parseInt(req.params.userId);
    
    if (userId === req.admin.user_id) {
        return res.status(400).json({ error: 'Cannot remove yourself' });
    }
    
    const adminIndex = db.admins.findIndex(a => a.user_id === userId);
    if (adminIndex === -1) {
        return res.status(404).json({ error: 'Admin not found' });
    }
    
    db.admins.splice(adminIndex, 1);
    res.json({ success: true, message: '–ê–¥–º–∏–Ω —É–¥–∞–ª–µ–Ω' });
});

// –û—Ç—á–µ—Ç –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º
app.get('/api/admin/users-report', requireAdmin, (req, res) => {
    const users = db.users
        .filter(u => u.is_registered)
        .map(user => {
            const stats = getUserStats(user.user_id);
            const works = db.user_works.filter(w => w.user_id === user.user_id);
            const quizCompletions = db.quiz_completions.filter(q => q.user_id === user.user_id);
            const marathonCompletions = db.marathon_completions.filter(m => m.user_id === user.user_id);
            const interactiveCompletions = db.interactive_completions.filter(i => i.user_id === user.user_id);
            const purchases = db.purchases.filter(p => p.user_id === user.user_id);
            
            const totalActivities = 
                quizCompletions.length + 
                marathonCompletions.filter(m => m.completed).length + 
                interactiveCompletions.length + 
                works.length;
            
            return {
                id: user.user_id,
                name: user.tg_first_name,
                username: user.tg_username,
                role: user.class,
                character: user.character_name,
                sparks: user.sparks,
                level: user.level,
                total_quizzes: quizCompletions.length,
                total_marathons: marathonCompletions.filter(m => m.completed).length,
                total_interactives: interactiveCompletions.length,
                total_works: works.length,
                approved_works: works.filter(w => w.status === 'approved').length,
                total_purchases: purchases.length,
                total_spent: purchases.reduce((sum, p) => sum + p.price_paid, 0),
                total_activities: totalActivities,
                registration_date: user.registration_date,
                last_active: user.last_active
            };
        })
        .sort((a, b) => b.total_activities - a.total_activities);
    
    res.json({ users });
});

// –ü–æ–ª–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
app.get('/api/admin/full-stats', requireAdmin, (req, res) => {
    const stats = {
        users: {
            total: db.users.length,
            registered: db.users.filter(u => u.is_registered).length,
            by_role: db.roles.map(role => ({
                role: role.name,
                count: db.users.filter(u => u.class === role.name).length
            })),
            active_today: db.users.filter(u => {
                const today = new Date();
                const lastActive = new Date(u.last_active);
                return lastActive.toDateString() === today.toDateString();
            }).length,
            active_week: db.users.filter(u => {
                const weekAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000);
                const lastActive = new Date(u.last_active);
                return lastActive > weekAgo;
            }).length,
            new_today: db.users.filter(u => {
                const today = new Date().toDateString();
                return new Date(u.registration_date).toDateString() === today;
            }).length
        },
        content: {
            quizzes: db.quizzes.length,
            active_quizzes: db.quizzes.filter(q => q.is_active).length,
            marathons: db.marathons.length,
            active_marathons: db.marathons.filter(m => m.is_active).length,
            shop_items: db.shop_items.length,
            active_shop_items: db.shop_items.filter(i => i.is_active).length,
            posts: db.channel_posts.length,
            active_posts: db.channel_posts.filter(p => p.is_active).length,
            interactives: db.interactives.length,
            active_interactives: db.interactives.filter(i => i.is_active).length
        },
        activities: {
            total_sparks: db.users.reduce((sum, user) => sum + user.sparks, 0),
            earned_sparks: db.activities.reduce((sum, a) => sum + a.sparks_earned, 0),
            spent_sparks: db.purchases.reduce((sum, p) => sum + p.price_paid, 0),
            total_purchases: db.purchases.length,
            total_works: db.user_works.length,
            pending_moderation: {
                works: db.user_works.filter(w => w.status === 'pending').length,
                reviews: db.post_reviews.filter(r => r.status === 'pending').length
            },
            total_activities: db.activities.length
        },
        completions: {
            quizzes: db.quiz_completions.length,
            marathons: db.marathon_completions.filter(m => m.completed).length,
            interactives: db.interactive_completions.length
        },
        revenue: {
            total: db.purchases.reduce((sum, p) => sum + p.price_paid, 0),
            by_item: db.shop_items.map(item => {
                const itemPurchases = db.purchases.filter(p => p.item_id === item.id);
                return {
                    item: item.title,
                    purchases: itemPurchases.length,
                    revenue: itemPurchases.reduce((sum, p) => sum + p.price_paid, 0)
                };
            }).filter(item => item.purchases > 0)
        }
    };
    
    res.json(stats);
});

// –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–∏—Å—Ç–µ–º—ã
app.get('/api/admin/settings', requireAdmin, (req, res) => {
    res.json(db.settings);
});

app.put('/api/admin/settings', requireAdmin, (req, res) => {
    const { settings } = req.body;
    
    if (!settings || !Array.isArray(settings)) {
        return res.status(400).json({ error: 'Settings array is required' });
    }
    
    settings.forEach(setting => {
        const existingSetting = db.settings.find(s => s.key === setting.key);
        if (existingSetting) {
            existingSetting.value = setting.value;
        }
    });
    
    res.json({ success: true, message: '–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –æ–±–Ω–æ–≤–ª–µ–Ω—ã' });
});

// Telegram Bot
let bot;
if (process.env.BOT_TOKEN) {
    try {
        bot = new TelegramBot(process.env.BOT_TOKEN, { polling: true });
        
        console.log('‚úÖ Telegram Bot –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
        
        bot.onText(/\/start/, (msg) => {
            const chatId = msg.chat.id;
            const name = msg.from.first_name || '–î—Ä—É–≥';
            const userId = msg.from.id;
            
            let user = db.users.find(u => u.user_id === userId);
            if (!user) {
                user = {
                    id: Date.now(),
                    user_id: userId,
                    tg_first_name: msg.from.first_name,
                    tg_username: msg.from.username,
                    sparks: 0,
                    level: '–£—á–µ–Ω–∏–∫',
                    is_registered: false,
                    class: null,
                    character_id: null,
                    character_name: null,
                    available_buttons: [],
                    registration_date: new Date().toISOString(),
                    last_active: new Date().toISOString(),
                    total_activities: 0,
                    completed_quizzes: 0,
                    completed_marathons: 0,
                    uploaded_works: 0
                };
                db.users.push(user);
            } else {
                user.last_active = new Date().toISOString();
            }
            
            const welcomeText = `üé® –ü—Ä–∏–≤–µ—Ç, ${name}!

–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ **–ú–∞—Å—Ç–µ—Ä—Å–∫—É—é –í–¥–æ—Ö–Ω–æ–≤–µ–Ω–∏—è**!

‚ú® –û—Ç–∫—Ä–æ–π—Ç–µ –ª–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç —á—Ç–æ–±—ã:
‚Ä¢ üéØ –ü—Ä–æ—Ö–æ–¥–∏—Ç—å –∫–≤–∏–∑—ã –∏ –ø–æ–ª—É—á–∞—Ç—å –∏—Å–∫—Ä—ã
‚Ä¢ üèÉ‚Äç‚ôÇÔ∏è –£—á–∞—Å—Ç–≤–æ–≤–∞—Ç—å –≤ –º–∞—Ä–∞—Ñ–æ–Ω–∞—Ö  
‚Ä¢ üñºÔ∏è –ó–∞–≥—Ä—É–∂–∞—Ç—å —Å–≤–æ–∏ —Ä–∞–±–æ—Ç—ã
‚Ä¢ üéÆ –í—ã–ø–æ–ª–Ω—è—Ç—å –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–¥–∞–Ω–∏—è
‚Ä¢ üîÑ –ú–µ–Ω—è—Ç—å —Ä–æ–ª—å –∏ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞
‚Ä¢ üìä –û—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å
‚Ä¢ üõí –ü–æ–∫—É–ø–∞—Ç—å –æ–±—É—á–∞—é—â–∏–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã
‚Ä¢ üèÜ –ü–æ–ª—É—á–∞—Ç—å –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è

–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å!`;
            
            const keyboard = {
                inline_keyboard: [[
                    {
                        text: "üì± –û—Ç–∫—Ä—ã—Ç—å –õ–∏—á–Ω—ã–π –ö–∞–±–∏–Ω–µ—Ç",
                        web_app: { url: process.env.APP_URL || `https://your-domain.timeweb.cloud` }
                    }
                ]]
            };

            bot.sendMessage(chatId, welcomeText, {
                parse_mode: 'Markdown',
                reply_markup: keyboard
            });
        });

        bot.onText(/\/admin/, (msg) => {
            const chatId = msg.chat.id;
            const userId = msg.from.id;
            
            const admin = db.admins.find(a => a.user_id == userId);
            if (!admin) {
                bot.sendMessage(chatId, '‚ùå –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞ –∫ –∞–¥–º–∏–Ω –ø–∞–Ω–µ–ª–∏.');
                return;
            }
            
            const baseUrl = process.env.APP_URL || 'https://sergeynikishin555123123-lab-tg-inspirationn-bot-3c3e.twc1.net';
            const adminUrl = `${baseUrl}/admin.html?userId=${userId}`;
            
            const keyboard = {
                inline_keyboard: [[
                    {
                        text: "üîß –û—Ç–∫—Ä—ã—Ç—å –ê–¥–º–∏–Ω –ü–∞–Ω–µ–ª—å",
                        url: adminUrl
                    }
                ]]
            };
            
            bot.sendMessage(chatId, `üîß –ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞\n\n–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ —á—Ç–æ–±—ã –æ—Ç–∫—Ä—ã—Ç—å –∞–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å:`, {
                parse_mode: 'Markdown',
                reply_markup: keyboard
            });
        });

        bot.onText(/\/stats/, (msg) => {
            const chatId = msg.chat.id;
            const userId = msg.from.id;
            
            const admin = db.admins.find(a => a.user_id == userId);
            if (!admin) {
                bot.sendMessage(chatId, '‚ùå –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞.');
                return;
            }
            
            const stats = {
                totalUsers: db.users.length,
                registeredUsers: db.users.filter(u => u.is_registered).length,
                activeQuizzes: db.quizzes.filter(q => q.is_active).length,
                activeMarathons: db.marathons.filter(m => m.is_active).length,
                shopItems: db.shop_items.filter(i => i.is_active).length,
                totalSparks: db.users.reduce((sum, user) => sum + user.sparks, 0)
            };
            
            const statsText = `üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –±–æ—Ç–∞:
            
üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏: ${stats.totalUsers}
‚úÖ –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–æ: ${stats.registeredUsers}
üéØ –ê–∫—Ç–∏–≤–Ω—ã—Ö –∫–≤–∏–∑–æ–≤: ${stats.activeQuizzes}
üèÉ‚Äç‚ôÇÔ∏è –ê–∫—Ç–∏–≤–Ω—ã—Ö –º–∞—Ä–∞—Ñ–æ–Ω–æ–≤: ${stats.activeMarathons}
üõí –¢–æ–≤–∞—Ä–æ–≤ –≤ –º–∞–≥–∞–∑–∏–Ω–µ: ${stats.shopItems}
‚ú® –í—Å–µ–≥–æ –∏—Å–∫—Ä: ${stats.totalSparks.toFixed(1)}`;
            
            bot.sendMessage(chatId, statsText);
        });

        // –ö–æ–º–∞–Ω–¥–∞ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π
        bot.onText(/\/achievements/, (msg) => {
            const chatId = msg.chat.id;
            const userId = msg.from.id;
            
            const user = db.users.find(u => u.user_id === userId);
            if (!user) {
                bot.sendMessage(chatId, '–°–Ω–∞—á–∞–ª–∞ –∑–∞–π–¥–∏—Ç–µ –≤ –ª–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ.');
                return;
            }
            
            const userAchievements = db.user_achievements
                .filter(ua => ua.user_id === userId)
                .map(ua => {
                    const achievement = db.achievements.find(a => a.id === ua.achievement_id);
                    return achievement;
                })
                .filter(a => a);
            
            if (userAchievements.length === 0) {
                bot.sendMessage(chatId, '–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π. –ê–∫—Ç–∏–≤–Ω–µ–µ —É—á–∞—Å—Ç–≤—É–π—Ç–µ –≤ –∂–∏–∑–Ω–∏ —Å–æ–æ–±—â–µ—Å—Ç–≤–∞!');
                return;
            }
            
            let achievementsText = `üèÜ –í–∞—à–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è (${userAchievements.length}):\n\n`;
            userAchievements.forEach((achievement, index) => {
                achievementsText += `${achievement.icon} ${achievement.title}\n${achievement.description}\n\n`;
            });
            
            bot.sendMessage(chatId, achievementsText);
        });

    } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –±–æ—Ç–∞:', error);
    }
}

const PORT = process.env.PORT || 3000;
app.listen(PORT, '0.0.0.0', () => {
    console.log(`üöÄ –°–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω –Ω–∞ –ø–æ—Ä—Ç—É ${PORT}`);
    console.log(`üì± WebApp: ${process.env.APP_URL || `http://localhost:${PORT}`}`);
    console.log(`üîß Admin: ${process.env.APP_URL || `http://localhost:${PORT}`}/admin`);
    console.log(`üéØ –ö–≤–∏–∑–æ–≤: ${db.quizzes.length}`);
    console.log(`üèÉ‚Äç‚ôÇÔ∏è –ú–∞—Ä–∞—Ñ–æ–Ω–æ–≤: ${db.marathons.length}`);
    console.log(`üéÆ –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–æ–≤: ${db.interactives.length}`);
    console.log(`üõí –¢–æ–≤–∞—Ä–æ–≤: ${db.shop_items.length}`);
    console.log(`üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: ${db.users.length}`);
    console.log('‚úÖ –í—Å–µ —Å–∏—Å—Ç–µ–º—ã —Ä–∞–±–æ—Ç–∞—é—Ç!');
});
